{"version":3,"sources":["meteor://💻app/packages/steedos_application-package/models/application_package.coffee","meteor://💻app/models/application_package.coffee","meteor://💻app/packages/steedos_application-package/server/routes/export.coffee","meteor://💻app/server/routes/export.coffee","meteor://💻app/packages/steedos_application-package/server/routes/import.coffee","meteor://💻app/server/routes/import.coffee","meteor://💻app/packages/steedos_application-package/server/methods/listviews_options.coffee","meteor://💻app/server/methods/listviews_options.coffee","meteor://💻app/packages/steedos_application-package/server/methods/init_export_data.coffee","meteor://💻app/server/methods/init_export_data.coffee","meteor://💻app/packages/steedos_application-package/lib/transform.coffee","meteor://💻app/lib/transform.coffee"],"names":["Creator","Objects","application_package","name","icon","label","hidden","fields","type","apps","reference_to","multiple","optionsFunction","_options","_","forEach","Apps","o","k","push","value","icon_slds","objects","objectsByName","list_views","optionsMethod","permission_set","permission_objects","reports","all","columns","filter_scope","actions","init_data","visible","on","todo","object_name","record_id","console","log","Meteor","call","Session","get","error","result","toastr","reason","success","url","Steedos","absoluteUrl","window","open","Modal","show","JsonRoutes","add","req","res","next","data","e","fileName","record","space_id","space_user","userId","getUserIdFromAuthToken","sendResult","code","errors","params","isSpaceAdmin","getCollection","findOne","_id","user","space","APTransform","dataSource","setHeader","encodeURI","end","JSON","stringify","stack","message","transformFieldOptions","transformFilters","filters","_filters","each","f","isArray","length","field","operation","options","has","join","importObject","object","list_views_id_maps","_fieldnames","hasRecentView","internal_list_view","obj_list_views","triggers","permissions","owner","insert","list_view","new_id","old_id","isRecentView","isAllView","$set","$unset","update","remove","contains","direct","trigger","replace","RegExp","is_enable","action","import_app_package","imp_data","from_template","apps_id_maps","imp_app_ids","imp_object_names","object_names","permission_set_id_maps","permission_set_ids","Error","check","Object","pluck","app","include","keys","isLegalVersion","isString","assigned_apps","app_id","permission_object","permission_set_id","report","is_creator","_list_view","permission_set_users","users","user_id","disabled_list_views","list_view_id","new_view_id","methods","collection","name_field_key","query","query_options","records","ref","ref1","results","searchTextQuery","selected","sort","getObject","NAME_FIELD_KEY","searchText","$regex","values","$or","$in","extend","$nin","db","filterQuery","limit","isObject","find","fetch","ref2","isEmpty","getAppObjects","getObjectsListViews","getObjectsPermissionObjects","getObjectsPermissionSet","getObjectsReports","appObjects","objects_name","objectsListViews","shared","objectsReports","objectsPermissionObjects","objectsPermissionSet","_objects","_objects_list_views","_objects_permission_objects","_objects_permission_set","_objects_reports","appId","concat","uniq","ignore_fields","created","created_by","modified","modified_by","is_deleted","instances","sharing","exportObject","_obj","v","key","_trigger","isFunction","toString","_todo","_action","_field","_fo","_o1","regEx","_regEx","_optionsFunction","_reference_to","createFunction","_createFunction","defaultValue","_defaultValue","export_data","appKey"],"mappings":"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","file":"/packages/steedos_application-package.js","sourcesContent":["Creator.Objects.application_package =\n\tname: \"application_package\"\n\ticon: \"custom.custom42\"\n\tlabel: \"软件包\"\n\thidden: true\n\tfields:\n\t\tname:\n\t\t\ttype: \"text\"\n\t\t\tlabel: \"名称\"\n\t\tapps:\n\t\t\ttype: \"lookup\"\n\t\t\tlabel: \"应用\"\n\t\t\ttype: \"lookup\"\n\t\t\treference_to: \"apps\"\n\t\t\tmultiple: true\n\t\t\toptionsFunction: ()->\n\t\t\t\t_options = []\n\t\t\t\t_.forEach Creator.Apps, (o, k)->\n\t\t\t\t\t_options.push {label: o.name, value: k, icon: o.icon_slds}\n\t\t\t\treturn _options\n\t\tobjects:\n\t\t\ttype: \"lookup\"\n\t\t\tlabel: \"对象\"\n\t\t\treference_to: \"objects\"\n\t\t\tmultiple: true\n\t\t\toptionsFunction: ()->\n\t\t\t\t_options = []\n\t\t\t\t_.forEach Creator.objectsByName, (o, k)->\n\t\t\t\t\tif !o.hidden\n\t\t\t\t\t\t_options.push { label: o.label, value: k, icon: o.icon }\n\t\t\t\treturn _options\n\n\t\tlist_views:\n\t\t\ttype: \"lookup\"\n\t\t\tlabel: \"列表视图\"\n\t\t\tmultiple: true\n\t\t\treference_to: \"object_listviews\"\n\t\t\toptionsMethod: \"creator.listviews_options\"\n\t\tpermission_set:\n\t\t\ttype: \"lookup\"\n\t\t\tlabel: \"权限集\"\n\t\t\tmultiple: true\n\t\t\treference_to: \"permission_set\"\n\t\tpermission_objects:\n\t\t\ttype: \"lookup\"\n\t\t\tlabel: \"权限集\"\n\t\t\tmultiple: true\n\t\t\treference_to: \"permission_objects\"\n\t\treports:\n\t\t\ttype: \"lookup\"\n\t\t\tlabel: \"报表\"\n\t\t\tmultiple: true\n\t\t\treference_to: \"reports\"\n\tlist_views:\n\t\tall:\n\t\t\tlabel: \"所有\"\n\t\t\tcolumns: [\"name\"]\n\t\t\tfilter_scope: \"space\"\n\tactions:\n\t\tinit_data:\n\t\t\tlabel: \"初始化\"\n\t\t\tvisible: true\n\t\t\ton: \"record\"\n\t\t\ttodo: (object_name, record_id, fields)->\n\t\t\t\tconsole.log(object_name, record_id, fields)\n\t\t\t\tMeteor.call \"appPackage.init_export_data\", Session.get(\"spaceId\"), record_id,(error, result)->\n\t\t\t\t\tif error\n\t\t\t\t\t\ttoastr.error(error.reason)\n\t\t\t\t\telse\n\t\t\t\t\t\ttoastr.success(\"初始化完成\")\n\t\texport:\n\t\t\tlabel: \"导出\"\n\t\t\tvisible: true\n\t\t\ton: \"record\"\n\t\t\ttodo: (object_name, record_id, fields)->\n\t\t\t\tconsole.log(\"导出#{object_name}->#{record_id}\")\n\t\t\t\turl = Steedos.absoluteUrl \"/api/creator/app_package/export/#{Session.get(\"spaceId\")}/#{record_id}\"\n\t\t\t\twindow.open(url)\n#\t\t\t\t$.ajax\n#\t\t\t\t\ttype: \"post\"\n#\t\t\t\t\turl: url\n#\t\t\t\t\tdataType: \"json\"\n#\t\t\t\t\tbeforeSend: (request) ->\n#\t\t\t\t\t\trequest.setRequestHeader('X-User-Id', Meteor.userId())\n#\t\t\t\t\t\trequest.setRequestHeader('X-Auth-Token', Accounts._storedLoginToken())\n#\t\t\t\t\terror: (jqXHR, textStatus, errorThrown) ->\n#\t\t\t\t\t\terror = jqXHR.responseJSON\n#\t\t\t\t\t\tconsole.error error\n#\t\t\t\t\t\tif error?.reason\n#\t\t\t\t\t\t\ttoastr?.error?(TAPi18n.__(error.reason))\n#\t\t\t\t\t\telse if error?.message\n#\t\t\t\t\t\t\ttoastr?.error?(TAPi18n.__(error.message))\n#\t\t\t\t\t\telse\n#\t\t\t\t\t\t\ttoastr?.error?(error)\n#\t\t\t\t\tsuccess: (result) ->\n#\t\t\t\t\t\tconsole.log(\"result...................#{result}\")\n\n\t\timport:\n\t\t\tlabel: \"导入\"\n\t\t\tvisible: true\n\t\t\ton: \"list\"\n\t\t\ttodo: (object_name)->\n\t\t\t\tconsole.log(\"object_name\", object_name)\n\t\t\t\tModal.show(\"APPackageImportModal\")\n","Creator.Objects.application_package = {\n  name: \"application_package\",\n  icon: \"custom.custom42\",\n  label: \"软件包\",\n  hidden: true,\n  fields: {\n    name: {\n      type: \"text\",\n      label: \"名称\"\n    },\n    apps: {\n      type: \"lookup\",\n      label: \"应用\",\n      type: \"lookup\",\n      reference_to: \"apps\",\n      multiple: true,\n      optionsFunction: function() {\n        var _options;\n        _options = [];\n        _.forEach(Creator.Apps, function(o, k) {\n          return _options.push({\n            label: o.name,\n            value: k,\n            icon: o.icon_slds\n          });\n        });\n        return _options;\n      }\n    },\n    objects: {\n      type: \"lookup\",\n      label: \"对象\",\n      reference_to: \"objects\",\n      multiple: true,\n      optionsFunction: function() {\n        var _options;\n        _options = [];\n        _.forEach(Creator.objectsByName, function(o, k) {\n          if (!o.hidden) {\n            return _options.push({\n              label: o.label,\n              value: k,\n              icon: o.icon\n            });\n          }\n        });\n        return _options;\n      }\n    },\n    list_views: {\n      type: \"lookup\",\n      label: \"列表视图\",\n      multiple: true,\n      reference_to: \"object_listviews\",\n      optionsMethod: \"creator.listviews_options\"\n    },\n    permission_set: {\n      type: \"lookup\",\n      label: \"权限集\",\n      multiple: true,\n      reference_to: \"permission_set\"\n    },\n    permission_objects: {\n      type: \"lookup\",\n      label: \"权限集\",\n      multiple: true,\n      reference_to: \"permission_objects\"\n    },\n    reports: {\n      type: \"lookup\",\n      label: \"报表\",\n      multiple: true,\n      reference_to: \"reports\"\n    }\n  },\n  list_views: {\n    all: {\n      label: \"所有\",\n      columns: [\"name\"],\n      filter_scope: \"space\"\n    }\n  },\n  actions: {\n    init_data: {\n      label: \"初始化\",\n      visible: true,\n      on: \"record\",\n      todo: function(object_name, record_id, fields) {\n        console.log(object_name, record_id, fields);\n        return Meteor.call(\"appPackage.init_export_data\", Session.get(\"spaceId\"), record_id, function(error, result) {\n          if (error) {\n            return toastr.error(error.reason);\n          } else {\n            return toastr.success(\"初始化完成\");\n          }\n        });\n      }\n    },\n    \"export\": {\n      label: \"导出\",\n      visible: true,\n      on: \"record\",\n      todo: function(object_name, record_id, fields) {\n        var url;\n        console.log(\"导出\" + object_name + \"->\" + record_id);\n        url = Steedos.absoluteUrl(\"/api/creator/app_package/export/\" + (Session.get(\"spaceId\")) + \"/\" + record_id);\n        return window.open(url);\n      }\n    },\n    \"import\": {\n      label: \"导入\",\n      visible: true,\n      on: \"list\",\n      todo: function(object_name) {\n        console.log(\"object_name\", object_name);\n        return Modal.show(\"APPackageImportModal\");\n      }\n    }\n  }\n};\n","JsonRoutes.add 'get', '/api/creator/app_package/export/:space_id/:record_id', (req, res, next) ->\n\ttry\n\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res);\n\n\t\tif !userId\n\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\tcode: 401\n\t\t\t\tdata: {errors: \"Authentication is required and has not been provided.\"}\n\t\t\t}\n\t\t\treturn\n\n\t\trecord_id = req.params.record_id\n\t\tspace_id = req.params.space_id\n\n\t\tif !Creator.isSpaceAdmin(space_id, userId)\n\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\tcode: 401\n\t\t\t\tdata: {errors: \"Permission denied\"}\n\t\t\t}\n\t\t\treturn\n\n\t\trecord = Creator.getCollection(\"application_package\").findOne({_id: record_id})\n\n\t\tif !record\n\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\tcode: 404\n\t\t\t\tdata: {errors: \"Collection not found for the segment #{record_id}\"}\n\t\t\t}\n\t\t\treturn\n\n\t\tspace_user = Creator.getCollection(\"space_users\").findOne({user: userId, space: record.space})\n\n\t\tif !space_user\n\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\tcode: 401\n\t\t\t\tdata: {errors: \"User does not have privileges to access the entity\"}\n\t\t\t}\n\t\t\treturn\n\n\t\tdata = APTransform.export record\n\n\t\tdata.dataSource = Meteor.absoluteUrl(\"api/creator/app_package/export/#{space_id}/#{record_id}\")\n\n\t\tfileName = record.name || \"application_package\"\n\n\t\tres.setHeader('Content-type', 'application/x-msdownload');\n\t\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(fileName)+'.json');\n\t\tres.end(JSON.stringify(data, null, 4))\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: e.reason || e.message }\n\t\t}\n\n","JsonRoutes.add('get', '/api/creator/app_package/export/:space_id/:record_id', function(req, res, next) {\n  var data, e, fileName, record, record_id, space_id, space_user, userId;\n  try {\n    userId = Steedos.getUserIdFromAuthToken(req, res);\n    if (!userId) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          errors: \"Authentication is required and has not been provided.\"\n        }\n      });\n      return;\n    }\n    record_id = req.params.record_id;\n    space_id = req.params.space_id;\n    if (!Creator.isSpaceAdmin(space_id, userId)) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          errors: \"Permission denied\"\n        }\n      });\n      return;\n    }\n    record = Creator.getCollection(\"application_package\").findOne({\n      _id: record_id\n    });\n    if (!record) {\n      JsonRoutes.sendResult(res, {\n        code: 404,\n        data: {\n          errors: \"Collection not found for the segment \" + record_id\n        }\n      });\n      return;\n    }\n    space_user = Creator.getCollection(\"space_users\").findOne({\n      user: userId,\n      space: record.space\n    });\n    if (!space_user) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          errors: \"User does not have privileges to access the entity\"\n        }\n      });\n      return;\n    }\n    data = APTransform[\"export\"](record);\n    data.dataSource = Meteor.absoluteUrl(\"api/creator/app_package/export/\" + space_id + \"/\" + record_id);\n    fileName = record.name || \"application_package\";\n    res.setHeader('Content-type', 'application/x-msdownload');\n    res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(fileName) + '.json');\n    return res.end(JSON.stringify(data, null, 4));\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: e.reason || e.message\n      }\n    });\n  }\n});\n","transformFilters = (filters)->\n\t_filters = []\n\t_.each filters, (f)->\n\t\tif _.isArray(f) && f.length == 3\n\t\t\t_filters.push {field: f[0], operation: f[1], value: f[2]}\n\t\telse\n\t\t\t_filters.push f\n\treturn _filters\n\ntransformFieldOptions = (options)->\n\tif !_.isArray(options)\n\t\treturn options\n\n\t_options = []\n\n\t_.each options, (o)->\n\t\tif o && _.has(o, 'label') && _.has(o, 'value')\n\t\t\t_options.push \"#{o.label}:#{o.value}\"\n\n\treturn _options.join(',')\n\n\nCreator.importObject = (userId, space_id, object, list_views_id_maps) ->\n\tconsole.log('------------------importObject------------------', object.name)\n\tfields = object.fields\n\ttriggers = object.triggers\n\tactions = object.actions\n\tobj_list_views = object.list_views\n\n\tdelete object._id\n\tdelete object.fields\n\tdelete object.triggers\n\tdelete object.actions\n\tdelete object.permissions #删除permissions动态属性\n\tdelete object.list_views\n\n\tobject.space = space_id\n\tobject.owner = userId\n\n\tCreator.getCollection(\"objects\").insert(object)\n\n\t# 2.1 持久化对象list_views\n\tinternal_list_view = {}\n\n\thasRecentView = false\n\tconsole.log('持久化对象list_views');\n\t_.each obj_list_views, (list_view)->\n\t\told_id = list_view._id\n\t\tdelete list_view._id\n\t\tlist_view.space = space_id\n\t\tlist_view.owner = userId\n\t\tlist_view.object_name = object.name\n\t\tif Creator.isRecentView(list_view)\n\t\t\thasRecentView = true\n\n\t\tif list_view.filters\n\t\t\tlist_view.filters = transformFilters(list_view.filters)\n\n\t\tif Creator.isAllView(list_view) || Creator.isRecentView(list_view)\n\t# 创建object时，会自动添加all view、recent view\n\n\t\t\toptions = {$set: list_view}\n\n\t\t\tif !list_view.columns\n\t\t\t\toptions.$unset = {columns: ''}\n\n\t\t\tCreator.getCollection(\"object_listviews\").update({object_name: object.name, name: list_view.name, space: space_id}, options)\n\t\telse\n\t\t\tnew_id = Creator.getCollection(\"object_listviews\").insert(list_view)\n\t\t\tlist_views_id_maps[object.name + \"_\" + old_id] = new_id\n\n\tif !hasRecentView\n\t\tCreator.getCollection(\"object_listviews\").remove({name: \"recent\", space: space_id, object_name: object.name, owner: userId})\n\tconsole.log('持久化对象字段');\n\t# 2.2 持久化对象字段\n\n\t_fieldnames = []\n\n\t_.each fields, (field, k)->\n\t\tdelete field._id\n\t\tfield.space = space_id\n\t\tfield.owner = userId\n\t\tfield.object = object.name\n\n\t\tif field.options\n\t\t\tfield.options = transformFieldOptions(field.options)\n\n\t\tif !_.has(field, \"name\")\n\t\t\tfield.name = k\n\n\t\t_fieldnames.push field.name\n\n\t\tif field.name == \"name\"\n\t\t\t# 创建object时，会自动添加name字段，因此在此处对name字段进行更新\n\t\t\tCreator.getCollection(\"object_fields\").update({object: object.name, name: \"name\", space: space_id}, {$set: field})\n\t\telse\n\t\t\tCreator.getCollection(\"object_fields\").insert(field)\n\n\t\tif !_.contains(_fieldnames, 'name')\n\t\t\tCreator.getCollection(\"object_fields\").direct.remove({object: object.name, name: \"name\", space: space_id})\n\n\tconsole.log('持久化触发器');\n\t# 2.3 持久化触发器\n\t_.each triggers, (trigger, k)->\n\t\tdelete triggers._id\n\t\ttrigger.space = space_id\n\t\ttrigger.owner = userId\n\t\ttrigger.object = object.name\n\t\tif !_.has(trigger, \"name\")\n\t\t\ttrigger.name = k.replace(new RegExp(\"\\\\.\", \"g\"), \"_\")\n\n\t\tif !_.has(trigger, \"is_enable\")\n\t\t\ttrigger.is_enable = true\n\n\t\tCreator.getCollection(\"object_triggers\").insert(trigger)\n\tconsole.log('持久化操作');\n\t# 2.4 持久化操作\n\t_.each actions, (action, k)->\n\t\tdelete action._id\n\t\taction.space = space_id\n\t\taction.owner = userId\n\t\taction.object = object.name\n\t\tif !_.has(action, \"name\")\n\t\t\taction.name = k.replace(new RegExp(\"\\\\.\", \"g\"), \"_\")\n\t\tif !_.has(action, \"is_enable\")\n\t\t\taction.is_enable = true\n\t\tCreator.getCollection(\"object_actions\").insert(action)\n\n\tconsole.log('------------------importObject end------------------', object.name)\n\nCreator.import_app_package = (userId, space_id, imp_data, from_template)->\n\tif !userId\n\t\tthrow new Meteor.Error(\"401\", \"Authentication is required and has not been provided.\")\n\n\tif !Creator.isSpaceAdmin(space_id, userId)\n\t\tthrow new Meteor.Error(\"401\", \"Permission denied.\")\n\n\t###数据校验 开始###\n\tcheck(imp_data, Object)\n\tif !from_template\n\t\t# 1 apps校验：根据_id判断应用是否已存在\n\t\timp_app_ids = _.pluck(imp_data.apps, \"_id\")\n\t\tif _.isArray(imp_data.apps) && imp_data.apps.length > 0\n\t\t\t_.each imp_data.apps, (app)->\n\t\t\t\tif _.include(_.keys(Creator.Apps), app._id)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"应用'#{app.name}'已存在\")\n\n\t\t# 2 objects校验：根据object.name判断对象是否已存在; 校验triggers\n\t\tif _.isArray(imp_data.objects) && imp_data.objects.length > 0\n\t\t\t_.each imp_data.objects, (object)->\n\t\t\t\tif _.include(_.keys(Creator.Objects), object.name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"对象'#{object.name}'已存在\")\n\t\t\t\t_.each object.triggers, (trigger)->\n\t\t\t\t\tif trigger.on == 'server' && !Steedos.isLegalVersion(space_id,\"workflow.enterprise\")\n\t\t\t\t\t\tthrow new Meteor.Error 500, \"只有企业版支持配置服务端的触发器\"\n\n\t\timp_object_names = _.pluck(imp_data.objects, \"name\")\n\t\tobject_names = _.keys(Creator.Objects)\n\n\t\t# 3 判断apps的对象是否都存在\n\t\tif _.isArray(imp_data.apps) && imp_data.apps.length > 0\n\t\t\t_.each imp_data.apps, (app)->\n\t\t\t\t_.each app.objects, (object_name)->\n\t\t\t\t\tif !_.include(object_names, object_name) && !_.include(imp_object_names, object_name)\n\t\t\t\t\t\tthrow new Meteor.Error(\"500\", \"应用'#{app.name}'中指定的对象'#{object_name}'不存在\")\n\n\t\t# 4 list_views校验：判断list_views对应的object是否存在\n\t\tif _.isArray(imp_data.list_views) && imp_data.list_views.length > 0\n\t\t\t_.each imp_data.list_views, (list_view)->\n\t\t\t\tif !list_view.object_name || !_.isString(list_view.object_name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"列表视图'#{list_view.name}'的object_name属性无效\")\n\t\t\t\tif !_.include(object_names, list_view.object_name) && !_.include(imp_object_names, list_view.object_name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"列表视图'#{list_view.name}'中指定的对象'#{list_view.object_name}'不存在\")\n\n\t\t# 5 permission_set校验：判断权限集中的授权应用assigned_apps; 权限集的名称不允许重复\n\t\tpermission_set_ids = _.pluck(imp_data.permission_set, \"_id\")\n\t\tif _.isArray(imp_data.permission_set) && imp_data.permission_set.length > 0\n\t\t\t_.each imp_data.permission_set, (permission_set)->\n\t\t\t\tif Creator.getCollection(\"permission_set\").findOne({space: space_id, name: permission_set.name},{fields:{_id:1}})\n\t\t\t\t\tthrow new Meteor.Error 500, \"权限集名称'#{permission_set.name}'不能重复\"\n\t\t\t\t_.each permission_set.assigned_apps, (app_id)->\n\t\t\t\t\tif !_.include(_.keys(Creator.Apps), app_id) && !_.include(imp_app_ids, app_id)\n\t\t\t\t\t\tthrow new Meteor.Error(\"500\", \"权限集'#{permission_set.name}'的授权应用'#{app_id}'不存在\")\n\n\t\t# 6 permission_objects校验：判断权限集中指定的object是否存在；判断权限集标识是是否有效\n\t\tif _.isArray(imp_data.permission_objects) && imp_data.permission_objects.length > 0\n\t\t\t_.each imp_data.permission_objects, (permission_object)->\n\t\t\t\tif !permission_object.object_name || !_.isString(permission_object.object_name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"权限集'#{permission_object.name}'的object_name属性无效\")\n\t\t\t\tif !_.include(object_names, permission_object.object_name) && !_.include(imp_object_names, permission_object.object_name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"权限集'#{list_view.name}'中指定的对象'#{permission_object.object_name}'不存在\")\n\n\t\t\t\tif !_.has(permission_object, \"permission_set_id\") || !_.isString(permission_object.permission_set_id)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"权限集'#{permission_object.name}'的permission_set_id属性无效\")\n\t\t\t\telse if !_.include(permission_set_ids, permission_object.permission_set_id)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"权限集'#{permission_object.name}'指定的权限集'#{permission_object.permission_set_id}'值不在导入的permission_set中\")\n\n\t\t# 7 reports校验：判断报表中指定的object是否存在\n\t\tif _.isArray(imp_data.reports) && imp_data.reports.length > 0\n\t\t\t_.each imp_data.reports, (report)->\n\t\t\t\tif !report.object_name || !_.isString(report.object_name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"报表'#{report.name}'的object_name属性无效\")\n\t\t\t\tif !_.include(object_names, report.object_name) && !_.include(imp_object_names, report.object_name)\n\t\t\t\t\tthrow new Meteor.Error(\"500\", \"报表'#{report.name}'中指定的对象'#{report.object_name}'不存在\")\n\n\t###数据校验 结束###\n\n\t###数据持久化 开始###\n\n\t# 定义新旧数据对应关系集合\n\tapps_id_maps = {}\n\tlist_views_id_maps = {}\n\tpermission_set_id_maps = {}\n\n\t# 1 持久化Apps\n\tif _.isArray(imp_data.apps) && imp_data.apps.length > 0\n\t\t_.each imp_data.apps, (app)->\n\t\t\told_id = app._id\n\t\t\tdelete app._id\n\t\t\tapp.space = space_id\n\t\t\tapp.owner = userId\n\t\t\tapp.is_creator = true\n\t\t\tnew_id = Creator.getCollection(\"apps\").insert(app)\n\t\t\tapps_id_maps[old_id] = new_id\n\n\t# 2 持久化objects\n\tif _.isArray(imp_data.objects) && imp_data.objects.length > 0\n\t\t_.each imp_data.objects, (object)->\n\t\t\tCreator.importObject(userId, space_id, object, list_views_id_maps)\n\n\t# 3 持久化list_views\n\tif _.isArray(imp_data.list_views) && imp_data.list_views.length > 0\n\t\t_.each imp_data.list_views, (list_view)->\n\t\t\told_id = list_view._id\n\t\t\tdelete list_view._id\n\n\t\t\tlist_view.space = space_id\n\t\t\tlist_view.owner = userId\n\t\t\tif Creator.isAllView(list_view) || Creator.isRecentView(list_view)\n\t\t\t\t# 创建object时，会自动添加all view、recent view\n\t\t\t\t_list_view = Creator.getCollection(\"object_listviews\").findOne({object_name: list_view.object_name, name: list_view.name, space: space_id},{fields: {_id: 1}})\n\t\t\t\tif _list_view\n\t\t\t\t\tnew_id = _list_view._id\n\t\t\t\tCreator.getCollection(\"object_listviews\").update({object_name: list_view.object_name, name: list_view.name, space: space_id}, {$set: list_view})\n\t\t\telse\n\t\t\t\tnew_id = Creator.getCollection(\"object_listviews\").insert(list_view)\n\n\t\t\tlist_views_id_maps[list_view.object_name + \"_\" + old_id] = new_id\n\n\t# 4 持久化permission_set\n\tif _.isArray(imp_data.permission_set) && imp_data.permission_set.length > 0\n\t\t_.each imp_data.permission_set, (permission_set)->\n\t\t\told_id = permission_set._id\n\t\t\tdelete permission_set._id\n\n\t\t\tpermission_set.space = space_id\n\t\t\tpermission_set.owner = userId\n\n\t\t\tpermission_set_users = []\n\t\t\t_.each permission_set.users, (user_id)->\n\t\t\t\tspace_user = Creator.getCollection(\"space_users\").findOne({space: space_id, user: user_id}, {fields: {_id: 1}})\n\t\t\t\tif space_user\n\t\t\t\t\tpermission_set_users.push user_id\n\n\t\t\tassigned_apps = []\n\t\t\t_.each permission_set.assigned_apps, (app_id)->\n\t\t\t\tif _.include(_.keys(Creator.Apps), app_id)\n\t\t\t\t\tassigned_apps.push app_id\n\t\t\t\telse if apps_id_maps[app_id]\n\t\t\t\t\tassigned_apps.push apps_id_maps[app_id]\n\n\n\t\t\tnew_id = Creator.getCollection(\"permission_set\").insert(permission_set)\n\n\t\t\tpermission_set_id_maps[old_id] = new_id\n\n\t# 5  持久化permission_objects\n\tif _.isArray(imp_data.permission_objects) && imp_data.permission_objects.length > 0\n\t\t_.each imp_data.permission_objects, (permission_object)->\n\t\t\tdelete permission_object._id\n\n\t\t\tpermission_object.space = space_id\n\t\t\tpermission_object.owner = userId\n\n\t\t\tpermission_object.permission_set_id = permission_set_id_maps[permission_object.permission_set_id]\n\n\t\t\tdisabled_list_views = []\n\t\t\t_.each permission_object.disabled_list_views, (list_view_id)->\n\t\t\t\tnew_view_id = list_views_id_maps[permission_object.object_name + \"_\" + list_view_id]\n\t\t\t\tif new_view_id\n\t\t\t\t\tdisabled_list_views.push new_view_id\n\n\t\t\tCreator.getCollection(\"permission_objects\").insert(permission_object)\n\n\t# 6 持久化reports\n\tif _.isArray(imp_data.reports) && imp_data.reports.length > 0\n\t\t_.each imp_data.reports, (report)->\n\t\t\tdelete report._id\n\n\t\t\treport.space = space_id\n\t\t\treport.owner = userId\n\n\t\t\tCreator.getCollection(\"reports\").insert(report)\n\t###数据持久化 结束###\n\n###由于使用接口方式会导致collection的after、before中获取不到userId，再此问题未解决之前，还是使用Method\nJsonRoutes.add 'post', '/api/creator/app_package/import/:space_id', (req, res, next) ->\n\ttry\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res);\n\t\tspace_id = req.params.space_id\n\t\timp_data = req.body\n\t\timport_app_package(userId, space_id, imp_data)\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: {}\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: e.error\n\t\t\tdata: { errors: errorMessage: e.reason || e.message }\n\t\t}\n###\n\nMeteor.methods\n\t'import_app_package': (space_id, imp_data)->\n\t\tuserId = this.userId\n\t\tCreator.import_app_package(userId, space_id, imp_data)\n","var transformFieldOptions, transformFilters;\n\ntransformFilters = function(filters) {\n  var _filters;\n  _filters = [];\n  _.each(filters, function(f) {\n    if (_.isArray(f) && f.length === 3) {\n      return _filters.push({\n        field: f[0],\n        operation: f[1],\n        value: f[2]\n      });\n    } else {\n      return _filters.push(f);\n    }\n  });\n  return _filters;\n};\n\ntransformFieldOptions = function(options) {\n  var _options;\n  if (!_.isArray(options)) {\n    return options;\n  }\n  _options = [];\n  _.each(options, function(o) {\n    if (o && _.has(o, 'label') && _.has(o, 'value')) {\n      return _options.push(o.label + \":\" + o.value);\n    }\n  });\n  return _options.join(',');\n};\n\nCreator.importObject = function(userId, space_id, object, list_views_id_maps) {\n  var _fieldnames, actions, fields, hasRecentView, internal_list_view, obj_list_views, triggers;\n  console.log('------------------importObject------------------', object.name);\n  fields = object.fields;\n  triggers = object.triggers;\n  actions = object.actions;\n  obj_list_views = object.list_views;\n  delete object._id;\n  delete object.fields;\n  delete object.triggers;\n  delete object.actions;\n  delete object.permissions;\n  delete object.list_views;\n  object.space = space_id;\n  object.owner = userId;\n  Creator.getCollection(\"objects\").insert(object);\n  internal_list_view = {};\n  hasRecentView = false;\n  console.log('持久化对象list_views');\n  _.each(obj_list_views, function(list_view) {\n    var new_id, old_id, options;\n    old_id = list_view._id;\n    delete list_view._id;\n    list_view.space = space_id;\n    list_view.owner = userId;\n    list_view.object_name = object.name;\n    if (Creator.isRecentView(list_view)) {\n      hasRecentView = true;\n    }\n    if (list_view.filters) {\n      list_view.filters = transformFilters(list_view.filters);\n    }\n    if (Creator.isAllView(list_view) || Creator.isRecentView(list_view)) {\n      options = {\n        $set: list_view\n      };\n      if (!list_view.columns) {\n        options.$unset = {\n          columns: ''\n        };\n      }\n      return Creator.getCollection(\"object_listviews\").update({\n        object_name: object.name,\n        name: list_view.name,\n        space: space_id\n      }, options);\n    } else {\n      new_id = Creator.getCollection(\"object_listviews\").insert(list_view);\n      return list_views_id_maps[object.name + \"_\" + old_id] = new_id;\n    }\n  });\n  if (!hasRecentView) {\n    Creator.getCollection(\"object_listviews\").remove({\n      name: \"recent\",\n      space: space_id,\n      object_name: object.name,\n      owner: userId\n    });\n  }\n  console.log('持久化对象字段');\n  _fieldnames = [];\n  _.each(fields, function(field, k) {\n    delete field._id;\n    field.space = space_id;\n    field.owner = userId;\n    field.object = object.name;\n    if (field.options) {\n      field.options = transformFieldOptions(field.options);\n    }\n    if (!_.has(field, \"name\")) {\n      field.name = k;\n    }\n    _fieldnames.push(field.name);\n    if (field.name === \"name\") {\n      Creator.getCollection(\"object_fields\").update({\n        object: object.name,\n        name: \"name\",\n        space: space_id\n      }, {\n        $set: field\n      });\n    } else {\n      Creator.getCollection(\"object_fields\").insert(field);\n    }\n    if (!_.contains(_fieldnames, 'name')) {\n      return Creator.getCollection(\"object_fields\").direct.remove({\n        object: object.name,\n        name: \"name\",\n        space: space_id\n      });\n    }\n  });\n  console.log('持久化触发器');\n  _.each(triggers, function(trigger, k) {\n    delete triggers._id;\n    trigger.space = space_id;\n    trigger.owner = userId;\n    trigger.object = object.name;\n    if (!_.has(trigger, \"name\")) {\n      trigger.name = k.replace(new RegExp(\"\\\\.\", \"g\"), \"_\");\n    }\n    if (!_.has(trigger, \"is_enable\")) {\n      trigger.is_enable = true;\n    }\n    return Creator.getCollection(\"object_triggers\").insert(trigger);\n  });\n  console.log('持久化操作');\n  _.each(actions, function(action, k) {\n    delete action._id;\n    action.space = space_id;\n    action.owner = userId;\n    action.object = object.name;\n    if (!_.has(action, \"name\")) {\n      action.name = k.replace(new RegExp(\"\\\\.\", \"g\"), \"_\");\n    }\n    if (!_.has(action, \"is_enable\")) {\n      action.is_enable = true;\n    }\n    return Creator.getCollection(\"object_actions\").insert(action);\n  });\n  return console.log('------------------importObject end------------------', object.name);\n};\n\nCreator.import_app_package = function(userId, space_id, imp_data, from_template) {\n  var apps_id_maps, imp_app_ids, imp_object_names, list_views_id_maps, object_names, permission_set_id_maps, permission_set_ids;\n  if (!userId) {\n    throw new Meteor.Error(\"401\", \"Authentication is required and has not been provided.\");\n  }\n  if (!Creator.isSpaceAdmin(space_id, userId)) {\n    throw new Meteor.Error(\"401\", \"Permission denied.\");\n  }\n\n  /*数据校验 开始 */\n  check(imp_data, Object);\n  if (!from_template) {\n    imp_app_ids = _.pluck(imp_data.apps, \"_id\");\n    if (_.isArray(imp_data.apps) && imp_data.apps.length > 0) {\n      _.each(imp_data.apps, function(app) {\n        if (_.include(_.keys(Creator.Apps), app._id)) {\n          throw new Meteor.Error(\"500\", \"应用'\" + app.name + \"'已存在\");\n        }\n      });\n    }\n    if (_.isArray(imp_data.objects) && imp_data.objects.length > 0) {\n      _.each(imp_data.objects, function(object) {\n        if (_.include(_.keys(Creator.Objects), object.name)) {\n          throw new Meteor.Error(\"500\", \"对象'\" + object.name + \"'已存在\");\n        }\n        return _.each(object.triggers, function(trigger) {\n          if (trigger.on === 'server' && !Steedos.isLegalVersion(space_id, \"workflow.enterprise\")) {\n            throw new Meteor.Error(500, \"只有企业版支持配置服务端的触发器\");\n          }\n        });\n      });\n    }\n    imp_object_names = _.pluck(imp_data.objects, \"name\");\n    object_names = _.keys(Creator.Objects);\n    if (_.isArray(imp_data.apps) && imp_data.apps.length > 0) {\n      _.each(imp_data.apps, function(app) {\n        return _.each(app.objects, function(object_name) {\n          if (!_.include(object_names, object_name) && !_.include(imp_object_names, object_name)) {\n            throw new Meteor.Error(\"500\", \"应用'\" + app.name + \"'中指定的对象'\" + object_name + \"'不存在\");\n          }\n        });\n      });\n    }\n    if (_.isArray(imp_data.list_views) && imp_data.list_views.length > 0) {\n      _.each(imp_data.list_views, function(list_view) {\n        if (!list_view.object_name || !_.isString(list_view.object_name)) {\n          throw new Meteor.Error(\"500\", \"列表视图'\" + list_view.name + \"'的object_name属性无效\");\n        }\n        if (!_.include(object_names, list_view.object_name) && !_.include(imp_object_names, list_view.object_name)) {\n          throw new Meteor.Error(\"500\", \"列表视图'\" + list_view.name + \"'中指定的对象'\" + list_view.object_name + \"'不存在\");\n        }\n      });\n    }\n    permission_set_ids = _.pluck(imp_data.permission_set, \"_id\");\n    if (_.isArray(imp_data.permission_set) && imp_data.permission_set.length > 0) {\n      _.each(imp_data.permission_set, function(permission_set) {\n        if (Creator.getCollection(\"permission_set\").findOne({\n          space: space_id,\n          name: permission_set.name\n        }, {\n          fields: {\n            _id: 1\n          }\n        })) {\n          throw new Meteor.Error(500, \"权限集名称'\" + permission_set.name + \"'不能重复\");\n        }\n        return _.each(permission_set.assigned_apps, function(app_id) {\n          if (!_.include(_.keys(Creator.Apps), app_id) && !_.include(imp_app_ids, app_id)) {\n            throw new Meteor.Error(\"500\", \"权限集'\" + permission_set.name + \"'的授权应用'\" + app_id + \"'不存在\");\n          }\n        });\n      });\n    }\n    if (_.isArray(imp_data.permission_objects) && imp_data.permission_objects.length > 0) {\n      _.each(imp_data.permission_objects, function(permission_object) {\n        if (!permission_object.object_name || !_.isString(permission_object.object_name)) {\n          throw new Meteor.Error(\"500\", \"权限集'\" + permission_object.name + \"'的object_name属性无效\");\n        }\n        if (!_.include(object_names, permission_object.object_name) && !_.include(imp_object_names, permission_object.object_name)) {\n          throw new Meteor.Error(\"500\", \"权限集'\" + list_view.name + \"'中指定的对象'\" + permission_object.object_name + \"'不存在\");\n        }\n        if (!_.has(permission_object, \"permission_set_id\") || !_.isString(permission_object.permission_set_id)) {\n          throw new Meteor.Error(\"500\", \"权限集'\" + permission_object.name + \"'的permission_set_id属性无效\");\n        } else if (!_.include(permission_set_ids, permission_object.permission_set_id)) {\n          throw new Meteor.Error(\"500\", \"权限集'\" + permission_object.name + \"'指定的权限集'\" + permission_object.permission_set_id + \"'值不在导入的permission_set中\");\n        }\n      });\n    }\n    if (_.isArray(imp_data.reports) && imp_data.reports.length > 0) {\n      _.each(imp_data.reports, function(report) {\n        if (!report.object_name || !_.isString(report.object_name)) {\n          throw new Meteor.Error(\"500\", \"报表'\" + report.name + \"'的object_name属性无效\");\n        }\n        if (!_.include(object_names, report.object_name) && !_.include(imp_object_names, report.object_name)) {\n          throw new Meteor.Error(\"500\", \"报表'\" + report.name + \"'中指定的对象'\" + report.object_name + \"'不存在\");\n        }\n      });\n    }\n  }\n\n  /*数据校验 结束 */\n\n  /*数据持久化 开始 */\n  apps_id_maps = {};\n  list_views_id_maps = {};\n  permission_set_id_maps = {};\n  if (_.isArray(imp_data.apps) && imp_data.apps.length > 0) {\n    _.each(imp_data.apps, function(app) {\n      var new_id, old_id;\n      old_id = app._id;\n      delete app._id;\n      app.space = space_id;\n      app.owner = userId;\n      app.is_creator = true;\n      new_id = Creator.getCollection(\"apps\").insert(app);\n      return apps_id_maps[old_id] = new_id;\n    });\n  }\n  if (_.isArray(imp_data.objects) && imp_data.objects.length > 0) {\n    _.each(imp_data.objects, function(object) {\n      return Creator.importObject(userId, space_id, object, list_views_id_maps);\n    });\n  }\n  if (_.isArray(imp_data.list_views) && imp_data.list_views.length > 0) {\n    _.each(imp_data.list_views, function(list_view) {\n      var _list_view, new_id, old_id;\n      old_id = list_view._id;\n      delete list_view._id;\n      list_view.space = space_id;\n      list_view.owner = userId;\n      if (Creator.isAllView(list_view) || Creator.isRecentView(list_view)) {\n        _list_view = Creator.getCollection(\"object_listviews\").findOne({\n          object_name: list_view.object_name,\n          name: list_view.name,\n          space: space_id\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        if (_list_view) {\n          new_id = _list_view._id;\n        }\n        Creator.getCollection(\"object_listviews\").update({\n          object_name: list_view.object_name,\n          name: list_view.name,\n          space: space_id\n        }, {\n          $set: list_view\n        });\n      } else {\n        new_id = Creator.getCollection(\"object_listviews\").insert(list_view);\n      }\n      return list_views_id_maps[list_view.object_name + \"_\" + old_id] = new_id;\n    });\n  }\n  if (_.isArray(imp_data.permission_set) && imp_data.permission_set.length > 0) {\n    _.each(imp_data.permission_set, function(permission_set) {\n      var assigned_apps, new_id, old_id, permission_set_users;\n      old_id = permission_set._id;\n      delete permission_set._id;\n      permission_set.space = space_id;\n      permission_set.owner = userId;\n      permission_set_users = [];\n      _.each(permission_set.users, function(user_id) {\n        var space_user;\n        space_user = Creator.getCollection(\"space_users\").findOne({\n          space: space_id,\n          user: user_id\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        if (space_user) {\n          return permission_set_users.push(user_id);\n        }\n      });\n      assigned_apps = [];\n      _.each(permission_set.assigned_apps, function(app_id) {\n        if (_.include(_.keys(Creator.Apps), app_id)) {\n          return assigned_apps.push(app_id);\n        } else if (apps_id_maps[app_id]) {\n          return assigned_apps.push(apps_id_maps[app_id]);\n        }\n      });\n      new_id = Creator.getCollection(\"permission_set\").insert(permission_set);\n      return permission_set_id_maps[old_id] = new_id;\n    });\n  }\n  if (_.isArray(imp_data.permission_objects) && imp_data.permission_objects.length > 0) {\n    _.each(imp_data.permission_objects, function(permission_object) {\n      var disabled_list_views;\n      delete permission_object._id;\n      permission_object.space = space_id;\n      permission_object.owner = userId;\n      permission_object.permission_set_id = permission_set_id_maps[permission_object.permission_set_id];\n      disabled_list_views = [];\n      _.each(permission_object.disabled_list_views, function(list_view_id) {\n        var new_view_id;\n        new_view_id = list_views_id_maps[permission_object.object_name + \"_\" + list_view_id];\n        if (new_view_id) {\n          return disabled_list_views.push(new_view_id);\n        }\n      });\n      return Creator.getCollection(\"permission_objects\").insert(permission_object);\n    });\n  }\n  if (_.isArray(imp_data.reports) && imp_data.reports.length > 0) {\n    return _.each(imp_data.reports, function(report) {\n      delete report._id;\n      report.space = space_id;\n      report.owner = userId;\n      return Creator.getCollection(\"reports\").insert(report);\n    });\n  }\n\n  /*数据持久化 结束 */\n};\n\n\n/*由于使用接口方式会导致collection的after、before中获取不到userId，再此问题未解决之前，还是使用Method\nJsonRoutes.add 'post', '/api/creator/app_package/import/:space_id', (req, res, next) ->\n\ttry\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res);\n\t\tspace_id = req.params.space_id\n\t\timp_data = req.body\n\t\timport_app_package(userId, space_id, imp_data)\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: {}\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: e.error\n\t\t\tdata: { errors: errorMessage: e.reason || e.message }\n\t\t}\n */\n\nMeteor.methods({\n  'import_app_package': function(space_id, imp_data) {\n    var userId;\n    userId = this.userId;\n    return Creator.import_app_package(userId, space_id, imp_data);\n  }\n});\n","Meteor.methods\n\t\"creator.listviews_options\": (options)->\n\t\tif options?.params?.reference_to\n\n\t\t\tobject = Creator.getObject(options.params.reference_to)\n\n\t\t\tname_field_key = object.NAME_FIELD_KEY\n\n\t\t\tquery = {}\n\t\t\tif options.params.space\n\t\t\t\tquery.space = options.params.space\n\n\t\t\t\tsort = options?.sort\n\n\t\t\t\tselected = options?.selected || []\n\n\t\t\t\tif options.searchText\n\t\t\t\t\tsearchTextQuery = {}\n\t\t\t\t\tsearchTextQuery[name_field_key] = {$regex: options.searchText}\n\n\t\t\t\tif options?.values?.length\n\t\t\t\t\tif options.searchText\n\t\t\t\t\t\tquery.$or = [{_id: {$in: options.values}}, searchTextQuery, {object_name: {$regex: options.searchText}}]\n\t\t\t\t\telse\n\t\t\t\t\t\tquery.$or = [{_id: {$in: options.values}}]\n\t\t\t\telse\n\t\t\t\t\tif options.searchText\n\t\t\t\t\t\t_.extend(query, {$or: [searchTextQuery,  {object_name: {$regex: options.searchText}}]})\n\t\t\t\t\tquery._id = {$nin: selected}\n\n\t\t\t\tcollection = object.db\n\n\t\t\t\tif options.filterQuery\n\t\t\t\t\t_.extend query, options.filterQuery\n\n\t\t\t\tquery_options = {limit: 10}\n\n\t\t\t\tif sort && _.isObject(sort)\n\t\t\t\t\tquery_options.sort = sort\n\n\t\t\t\tif collection\n\t\t\t\t\ttry\n\t\t\t\t\t\trecords = collection.find(query, query_options).fetch()\n\t\t\t\t\t\tresults = []\n\t\t\t\t\t\t_.each records, (record)->\n\t\t\t\t\t\t\tobject_name = Creator.getObject(record.object_name)?.name || \"\"\n\t\t\t\t\t\t\tif !_.isEmpty(object_name)\n\t\t\t\t\t\t\t\tobject_name = \" (#{object_name})\"\n\n\t\t\t\t\t\t\tresults.push\n\t\t\t\t\t\t\t\tlabel: record[name_field_key] + object_name\n\t\t\t\t\t\t\t\tvalue: record._id\n\t\t\t\t\t\treturn results\n\t\t\t\t\tcatch e\n\t\t\t\t\t\tthrow new Meteor.Error 500, e.message + \"-->\" + JSON.stringify(options)\n\t\treturn [] ","Meteor.methods({\n  \"creator.listviews_options\": function(options) {\n    var collection, e, name_field_key, object, query, query_options, records, ref, ref1, results, searchTextQuery, selected, sort;\n    if (options != null ? (ref = options.params) != null ? ref.reference_to : void 0 : void 0) {\n      object = Creator.getObject(options.params.reference_to);\n      name_field_key = object.NAME_FIELD_KEY;\n      query = {};\n      if (options.params.space) {\n        query.space = options.params.space;\n        sort = options != null ? options.sort : void 0;\n        selected = (options != null ? options.selected : void 0) || [];\n        if (options.searchText) {\n          searchTextQuery = {};\n          searchTextQuery[name_field_key] = {\n            $regex: options.searchText\n          };\n        }\n        if (options != null ? (ref1 = options.values) != null ? ref1.length : void 0 : void 0) {\n          if (options.searchText) {\n            query.$or = [\n              {\n                _id: {\n                  $in: options.values\n                }\n              }, searchTextQuery, {\n                object_name: {\n                  $regex: options.searchText\n                }\n              }\n            ];\n          } else {\n            query.$or = [\n              {\n                _id: {\n                  $in: options.values\n                }\n              }\n            ];\n          }\n        } else {\n          if (options.searchText) {\n            _.extend(query, {\n              $or: [\n                searchTextQuery, {\n                  object_name: {\n                    $regex: options.searchText\n                  }\n                }\n              ]\n            });\n          }\n          query._id = {\n            $nin: selected\n          };\n        }\n        collection = object.db;\n        if (options.filterQuery) {\n          _.extend(query, options.filterQuery);\n        }\n        query_options = {\n          limit: 10\n        };\n        if (sort && _.isObject(sort)) {\n          query_options.sort = sort;\n        }\n        if (collection) {\n          try {\n            records = collection.find(query, query_options).fetch();\n            results = [];\n            _.each(records, function(record) {\n              var object_name, ref2;\n              object_name = ((ref2 = Creator.getObject(record.object_name)) != null ? ref2.name : void 0) || \"\";\n              if (!_.isEmpty(object_name)) {\n                object_name = \" (\" + object_name + \")\";\n              }\n              return results.push({\n                label: record[name_field_key] + object_name,\n                value: record._id\n              });\n            });\n            return results;\n          } catch (error) {\n            e = error;\n            throw new Meteor.Error(500, e.message + \"-->\" + JSON.stringify(options));\n          }\n        }\n      }\n    }\n    return [];\n  }\n});\n","#获取应用下的对象\ngetAppObjects = (app)->\n\tappObjects = []\n\tif app && _.isArray(app.objects) && app.objects.length > 0\n\t\t_.each app.objects, (object_name)->\n\t\t\tobject = Creator.getObject(object_name)\n\t\t\tif object\n\t\t\t\tappObjects.push object_name\n\treturn appObjects\n\n#获取对象下的列表视图\ngetObjectsListViews = (space_id, objects_name)->\n\tobjectsListViews = []\n\tif objects_name && _.isArray(objects_name) && objects_name.length > 0\n\t\t_.each objects_name, (object_name)->\n\t\t\t#获取对象的共享列表视图list_views\n\t\t\tlist_views = Creator.getCollection(\"object_listviews\").find({object_name: object_name, space: space_id, shared: true}, {fields: {_id: 1}})\n\t\t\tlist_views.forEach (list_view)->\n\t\t\t\tobjectsListViews.push list_view._id\n\treturn objectsListViews\n\n#获取对象下的报表\ngetObjectsReports = (space_id, objects_name)->\n\tobjectsReports = []\n\tif objects_name && _.isArray(objects_name) && objects_name.length > 0\n\t\t_.each objects_name, (object_name)->\n\t\t\t#获取对象的报表reports\n\t\t\treports = Creator.getCollection(\"reports\").find({object_name: object_name, space: space_id}, {fields: {_id: 1}})\n\t\t\treports.forEach (report)->\n\t\t\t\tobjectsReports.push report._id\n\treturn objectsReports\n\n#获取对象下的权限集\ngetObjectsPermissionObjects = (space_id, objects_name)->\n\tobjectsPermissionObjects = []\n\tif objects_name && _.isArray(objects_name) && objects_name.length > 0\n\t\t_.each objects_name, (object_name)->\n\t\t\tpermission_objects = Creator.getCollection(\"permission_objects\").find({object_name: object_name, space: space_id}, {fields: {_id: 1}})\n\t\t\tpermission_objects.forEach (permission_object)->\n\t\t\t\tobjectsPermissionObjects.push permission_object._id\n\treturn objectsPermissionObjects\n\n#获取对象下权限集对应的权限集\ngetObjectsPermissionSet = (space_id, objects_name)->\n\tobjectsPermissionSet = []\n\tif objects_name && _.isArray(objects_name) && objects_name.length > 0\n\t\t_.each objects_name, (object_name)->\n\t\t\tpermission_objects = Creator.getCollection(\"permission_objects\").find({object_name: object_name, space: space_id}, {fields: {permission_set_id: 1}})\n\t\t\tpermission_objects.forEach (permission_object)->\n\t\t\t\tpermission_set = Creator.getCollection(\"permission_set\").findOne({_id: permission_object.permission_set_id}, {fields: {_id: 1}})\n\t\t\t\tobjectsPermissionSet.push permission_set._id\n\treturn objectsPermissionSet\n\n\nMeteor.methods\n\t\"appPackage.init_export_data\": (space_id, record_id)->\n\t\tuserId = this.userId\n\t\tif !userId\n\t\t\tthrow new Meteor.Error(\"401\", \"Authentication is required and has not been provided.\")\n\n\t\tif !Creator.isSpaceAdmin(space_id, userId)\n\t\t\tthrow new Meteor.Error(\"401\", \"Permission denied.\")\n\n\t\trecord = Creator.getCollection(\"application_package\").findOne({_id: record_id})\n\n\t\tif (!_.isArray(record?.apps) || record?.apps?.length < 1) && (!_.isArray(record?.objects) || record?.objects?.length < 1)\n\t\t\tthrow new Meteor.Error(\"500\", \"请先选择应用或者对象\")\n\n\t\tdata = {}\n\t\t_objects = record.objects || []\n\t\t_objects_list_views = record.list_views || []\n\t\t_objects_reports = record.reports || []\n\t\t_objects_permission_objects = record.permission_objects || []\n\t\t_objects_permission_set = record.permission_set || []\n\n\t\ttry\n\t\t\tif _.isArray(record?.apps) && record.apps.length > 0\n\t\t\t\t_.each record.apps, (appId)->\n\t\t\t\t\tif !app\n\t\t\t\t\t\t#如果从代码中定义的apps中没有找到，则从数据库中获取\n\t\t\t\t\t\tapp = Creator.getCollection(\"apps\").findOne({_id: appId, is_creator: true}, {fields: {objects: 1}})\n\t\t\t\t\t_objects = _objects.concat(getAppObjects(app))\n\n\t\t\tif _.isArray(_objects) && _objects.length > 0\n\t\t\t\t_objects_list_views = _objects_list_views.concat(getObjectsListViews(space_id, _objects))\n\t\t\t\t_objects_reports = _objects_reports.concat(getObjectsReports(space_id, _objects))\n\t\t\t\t_objects_permission_objects = _objects_permission_objects.concat(getObjectsPermissionObjects(space_id, _objects))\n\t\t\t\t_objects_permission_set = _objects_permission_set.concat(getObjectsPermissionSet(space_id, _objects))\n\n\t\t\t\tdata.objects = _.uniq _objects\n\t\t\t\tdata.list_views = _.uniq _objects_list_views\n\t\t\t\tdata.permission_set = _.uniq _objects_permission_set\n\t\t\t\tdata.permission_objects = _.uniq _objects_permission_objects\n\t\t\t\tdata.reports = _.uniq _objects_reports\n\t\t\t\tCreator.getCollection(\"application_package\").update({_id: record._id},{$set: data})\n\t\tcatch e\n\t\t\tconsole.error e.stack\n\t\t\tthrow new Meteor.Error(\"500\", e.reason || e.message )","var getAppObjects, getObjectsListViews, getObjectsPermissionObjects, getObjectsPermissionSet, getObjectsReports;\n\ngetAppObjects = function(app) {\n  var appObjects;\n  appObjects = [];\n  if (app && _.isArray(app.objects) && app.objects.length > 0) {\n    _.each(app.objects, function(object_name) {\n      var object;\n      object = Creator.getObject(object_name);\n      if (object) {\n        return appObjects.push(object_name);\n      }\n    });\n  }\n  return appObjects;\n};\n\ngetObjectsListViews = function(space_id, objects_name) {\n  var objectsListViews;\n  objectsListViews = [];\n  if (objects_name && _.isArray(objects_name) && objects_name.length > 0) {\n    _.each(objects_name, function(object_name) {\n      var list_views;\n      list_views = Creator.getCollection(\"object_listviews\").find({\n        object_name: object_name,\n        space: space_id,\n        shared: true\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      return list_views.forEach(function(list_view) {\n        return objectsListViews.push(list_view._id);\n      });\n    });\n  }\n  return objectsListViews;\n};\n\ngetObjectsReports = function(space_id, objects_name) {\n  var objectsReports;\n  objectsReports = [];\n  if (objects_name && _.isArray(objects_name) && objects_name.length > 0) {\n    _.each(objects_name, function(object_name) {\n      var reports;\n      reports = Creator.getCollection(\"reports\").find({\n        object_name: object_name,\n        space: space_id\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      return reports.forEach(function(report) {\n        return objectsReports.push(report._id);\n      });\n    });\n  }\n  return objectsReports;\n};\n\ngetObjectsPermissionObjects = function(space_id, objects_name) {\n  var objectsPermissionObjects;\n  objectsPermissionObjects = [];\n  if (objects_name && _.isArray(objects_name) && objects_name.length > 0) {\n    _.each(objects_name, function(object_name) {\n      var permission_objects;\n      permission_objects = Creator.getCollection(\"permission_objects\").find({\n        object_name: object_name,\n        space: space_id\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      return permission_objects.forEach(function(permission_object) {\n        return objectsPermissionObjects.push(permission_object._id);\n      });\n    });\n  }\n  return objectsPermissionObjects;\n};\n\ngetObjectsPermissionSet = function(space_id, objects_name) {\n  var objectsPermissionSet;\n  objectsPermissionSet = [];\n  if (objects_name && _.isArray(objects_name) && objects_name.length > 0) {\n    _.each(objects_name, function(object_name) {\n      var permission_objects;\n      permission_objects = Creator.getCollection(\"permission_objects\").find({\n        object_name: object_name,\n        space: space_id\n      }, {\n        fields: {\n          permission_set_id: 1\n        }\n      });\n      return permission_objects.forEach(function(permission_object) {\n        var permission_set;\n        permission_set = Creator.getCollection(\"permission_set\").findOne({\n          _id: permission_object.permission_set_id\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        return objectsPermissionSet.push(permission_set._id);\n      });\n    });\n  }\n  return objectsPermissionSet;\n};\n\nMeteor.methods({\n  \"appPackage.init_export_data\": function(space_id, record_id) {\n    var _objects, _objects_list_views, _objects_permission_objects, _objects_permission_set, _objects_reports, data, e, record, ref, ref1, userId;\n    userId = this.userId;\n    if (!userId) {\n      throw new Meteor.Error(\"401\", \"Authentication is required and has not been provided.\");\n    }\n    if (!Creator.isSpaceAdmin(space_id, userId)) {\n      throw new Meteor.Error(\"401\", \"Permission denied.\");\n    }\n    record = Creator.getCollection(\"application_package\").findOne({\n      _id: record_id\n    });\n    if ((!_.isArray(record != null ? record.apps : void 0) || (record != null ? (ref = record.apps) != null ? ref.length : void 0 : void 0) < 1) && (!_.isArray(record != null ? record.objects : void 0) || (record != null ? (ref1 = record.objects) != null ? ref1.length : void 0 : void 0) < 1)) {\n      throw new Meteor.Error(\"500\", \"请先选择应用或者对象\");\n    }\n    data = {};\n    _objects = record.objects || [];\n    _objects_list_views = record.list_views || [];\n    _objects_reports = record.reports || [];\n    _objects_permission_objects = record.permission_objects || [];\n    _objects_permission_set = record.permission_set || [];\n    try {\n      if (_.isArray(record != null ? record.apps : void 0) && record.apps.length > 0) {\n        _.each(record.apps, function(appId) {\n          var app;\n          if (!app) {\n            app = Creator.getCollection(\"apps\").findOne({\n              _id: appId,\n              is_creator: true\n            }, {\n              fields: {\n                objects: 1\n              }\n            });\n          }\n          return _objects = _objects.concat(getAppObjects(app));\n        });\n      }\n      if (_.isArray(_objects) && _objects.length > 0) {\n        _objects_list_views = _objects_list_views.concat(getObjectsListViews(space_id, _objects));\n        _objects_reports = _objects_reports.concat(getObjectsReports(space_id, _objects));\n        _objects_permission_objects = _objects_permission_objects.concat(getObjectsPermissionObjects(space_id, _objects));\n        _objects_permission_set = _objects_permission_set.concat(getObjectsPermissionSet(space_id, _objects));\n        data.objects = _.uniq(_objects);\n        data.list_views = _.uniq(_objects_list_views);\n        data.permission_set = _.uniq(_objects_permission_set);\n        data.permission_objects = _.uniq(_objects_permission_objects);\n        data.reports = _.uniq(_objects_reports);\n        return Creator.getCollection(\"application_package\").update({\n          _id: record._id\n        }, {\n          $set: data\n        });\n      }\n    } catch (error) {\n      e = error;\n      console.error(e.stack);\n      throw new Meteor.Error(\"500\", e.reason || e.message);\n    }\n  }\n});\n","@APTransform = {}\n\nignore_fields = {\n\towner: 0,\n\tspace: 0,\n\tcreated: 0,\n\tcreated_by: 0,\n\tmodified: 0,\n\tmodified_by: 0,\n\tis_deleted: 0,\n\tinstances: 0,\n\tsharing: 0\n}\n\nAPTransform.exportObject = (object)->\n\t_obj = {}\n\n\t_.extend(_obj , object)\n\n\tobj_list_views = {}\n\n\t_.extend(obj_list_views, _obj.list_views || {})\n\n\t_.each obj_list_views, (v, k)->\n\t\tif !_.has(v, \"_id\")\n\t\t\tv._id = k\n\t\tif !_.has(v, \"name\")\n\t\t\tv.name = k\n\t_obj.list_views = obj_list_views\n\n\n\t#只修改_obj属性原object属性保持不变\n\ttriggers = {}\n\t_.forEach _obj.triggers, (trigger, key)->\n\t\t_trigger = {}\n\t\t_.extend(_trigger, trigger)\n\t\tif _.isFunction(_trigger.todo)\n\t\t\t_trigger.todo = _trigger.todo.toString()\n\t\tdelete _trigger._todo\n\t\ttriggers[key] = _trigger\n\t_obj.triggers = triggers\n\n\tactions = {}\n\t_.forEach _obj.actions, (action, key)->\n\t\t_action = {}\n\t\t_.extend(_action, action)\n\t\tif _.isFunction(_action.todo)\n\t\t\t_action.todo = _action.todo.toString()\n\t\tdelete _action._todo\n\t\tactions[key] = _action\n\n\t_obj.actions = actions\n\n\tfields = {}\n\t_.forEach _obj.fields, (field, key)->\n\t\t_field = {}\n\t\t_.extend(_field, field)\n\t\tif _.isFunction(_field.options)\n\t\t\t_field.options = _field.options.toString()\n\t\t\tdelete _field._options\n\n\t\tif _.isArray(_field.options)\n\t\t\t_fo = []\n\t\t\t_.forEach _field.options, (_o1)->\n\t\t\t\t_fo.push(\"#{_o1.label}:#{_o1.value}\")\n\t\t\t_field.options = _fo.join(\",\")\n\t\t\tdelete _field._options\n\n\t\tif _field.regEx\n\t\t\t_field.regEx = _field.regEx.toString()\n\t\t\tdelete _field._regEx\n\n\t\tif _.isFunction(_field.optionsFunction)\n\t\t\t_field.optionsFunction = _field.optionsFunction.toString()\n\t\t\tdelete _field._optionsFunction\n\n\t\tif _.isFunction(_field.reference_to)\n\t\t\t_field.reference_to = _field.reference_to.toString()\n\t\t\tdelete _field._reference_to\n\n\t\tif _.isFunction(_field.createFunction)\n\t\t\t_field.createFunction = _field.createFunction.toString()\n\t\t\tdelete _field._createFunction\n\n\t\tif _.isFunction(_field.defaultValue)\n\t\t\t_field.defaultValue = _field.defaultValue.toString()\n\t\t\tdelete _field._defaultValue\n\t\t#TODO 转换field.autoform.type，已和朱思嘉确认，目前不支持autoform.type 为function类型\n\t\tfields[key] = _field\n\n\t_obj.fields = fields\n\n\treturn _obj\n\n###\n导出数据:\n{\n\tapps:[{}], 软件包选中的apps\n\tobjects:[{}], 选中的object及其fields, list_views, triggers, actions, permission_set等\n    list_views:[{}], 软件包选中的list_views\n    permissions:[{}], 软件包选中的权限集\n    permission_objects:[{}], 软件包选中的权限对象\n    reports:[{}] 软件包选中的报表\n}\n###\nAPTransform.export = (record)->\n\texport_data = {}\n\tif _.isArray(record.apps) && record.apps.length > 0\n\t\texport_data.apps = []\n\n\t\t_.each record.apps, (appKey)->\n\t\t\tapp = {}\n\t\t\t_.extend(app, Creator.Apps[appKey])\n\t\t\tif !app || _.isEmpty(app)\n\t\t\t\tapp = Creator.getCollection(\"apps\").findOne({_id: appKey}, {fields: ignore_fields})\n\t\t\telse\n\t\t\t\tif !_.has(app, \"_id\")\n\t\t\t\t\tapp._id = appKey\n\t\t\tif app\n\t\t\t\texport_data.apps.push app\n\n\tif _.isArray(record.objects) && record.objects.length > 0\n\t\texport_data.objects = []\n\t\t_.each record.objects, (object_name)->\n\t\t\tobject = Creator.Objects[object_name]\n\t\t\tif object\n\t\t\t\texport_data.objects.push APTransform.exportObject(object)\n\n\tif _.isArray(record.list_views) && record.list_views.length > 0\n\t\texport_data.list_views = Creator.getCollection(\"object_listviews\").find({_id: {$in: record.list_views}}, {fields: ignore_fields}).fetch()\n\n\tif _.isArray(record.permission_set) && record.permission_set.length > 0\n\t\texport_data.permission_set = Creator.getCollection(\"permission_set\").find({_id: {$in: record.permission_set}}, {fields: ignore_fields}).fetch()\n\n\tif _.isArray(record.permission_objects) && record.permission_objects.length > 0\n\t\texport_data.permission_objects = Creator.getCollection(\"permission_objects\").find({_id: {$in: record.permission_objects}}, {fields: ignore_fields}).fetch()\n\n\tif _.isArray(record.reports) && record.reports.length > 0\n\t\texport_data.reports = Creator.getCollection(\"reports\").find({_id: {$in: record.reports}}, {fields: ignore_fields}).fetch()\n\n\treturn export_data\n","var ignore_fields;\n\nthis.APTransform = {};\n\nignore_fields = {\n  owner: 0,\n  space: 0,\n  created: 0,\n  created_by: 0,\n  modified: 0,\n  modified_by: 0,\n  is_deleted: 0,\n  instances: 0,\n  sharing: 0\n};\n\nAPTransform.exportObject = function(object) {\n  var _obj, actions, fields, obj_list_views, triggers;\n  _obj = {};\n  _.extend(_obj, object);\n  obj_list_views = {};\n  _.extend(obj_list_views, _obj.list_views || {});\n  _.each(obj_list_views, function(v, k) {\n    if (!_.has(v, \"_id\")) {\n      v._id = k;\n    }\n    if (!_.has(v, \"name\")) {\n      return v.name = k;\n    }\n  });\n  _obj.list_views = obj_list_views;\n  triggers = {};\n  _.forEach(_obj.triggers, function(trigger, key) {\n    var _trigger;\n    _trigger = {};\n    _.extend(_trigger, trigger);\n    if (_.isFunction(_trigger.todo)) {\n      _trigger.todo = _trigger.todo.toString();\n    }\n    delete _trigger._todo;\n    return triggers[key] = _trigger;\n  });\n  _obj.triggers = triggers;\n  actions = {};\n  _.forEach(_obj.actions, function(action, key) {\n    var _action;\n    _action = {};\n    _.extend(_action, action);\n    if (_.isFunction(_action.todo)) {\n      _action.todo = _action.todo.toString();\n    }\n    delete _action._todo;\n    return actions[key] = _action;\n  });\n  _obj.actions = actions;\n  fields = {};\n  _.forEach(_obj.fields, function(field, key) {\n    var _field, _fo;\n    _field = {};\n    _.extend(_field, field);\n    if (_.isFunction(_field.options)) {\n      _field.options = _field.options.toString();\n      delete _field._options;\n    }\n    if (_.isArray(_field.options)) {\n      _fo = [];\n      _.forEach(_field.options, function(_o1) {\n        return _fo.push(_o1.label + \":\" + _o1.value);\n      });\n      _field.options = _fo.join(\",\");\n      delete _field._options;\n    }\n    if (_field.regEx) {\n      _field.regEx = _field.regEx.toString();\n      delete _field._regEx;\n    }\n    if (_.isFunction(_field.optionsFunction)) {\n      _field.optionsFunction = _field.optionsFunction.toString();\n      delete _field._optionsFunction;\n    }\n    if (_.isFunction(_field.reference_to)) {\n      _field.reference_to = _field.reference_to.toString();\n      delete _field._reference_to;\n    }\n    if (_.isFunction(_field.createFunction)) {\n      _field.createFunction = _field.createFunction.toString();\n      delete _field._createFunction;\n    }\n    if (_.isFunction(_field.defaultValue)) {\n      _field.defaultValue = _field.defaultValue.toString();\n      delete _field._defaultValue;\n    }\n    return fields[key] = _field;\n  });\n  _obj.fields = fields;\n  return _obj;\n};\n\n\n/*\n导出数据:\n{\n\tapps:[{}], 软件包选中的apps\n\tobjects:[{}], 选中的object及其fields, list_views, triggers, actions, permission_set等\n    list_views:[{}], 软件包选中的list_views\n    permissions:[{}], 软件包选中的权限集\n    permission_objects:[{}], 软件包选中的权限对象\n    reports:[{}] 软件包选中的报表\n}\n */\n\nAPTransform[\"export\"] = function(record) {\n  var export_data;\n  export_data = {};\n  if (_.isArray(record.apps) && record.apps.length > 0) {\n    export_data.apps = [];\n    _.each(record.apps, function(appKey) {\n      var app;\n      app = {};\n      _.extend(app, Creator.Apps[appKey]);\n      if (!app || _.isEmpty(app)) {\n        app = Creator.getCollection(\"apps\").findOne({\n          _id: appKey\n        }, {\n          fields: ignore_fields\n        });\n      } else {\n        if (!_.has(app, \"_id\")) {\n          app._id = appKey;\n        }\n      }\n      if (app) {\n        return export_data.apps.push(app);\n      }\n    });\n  }\n  if (_.isArray(record.objects) && record.objects.length > 0) {\n    export_data.objects = [];\n    _.each(record.objects, function(object_name) {\n      var object;\n      object = Creator.Objects[object_name];\n      if (object) {\n        return export_data.objects.push(APTransform.exportObject(object));\n      }\n    });\n  }\n  if (_.isArray(record.list_views) && record.list_views.length > 0) {\n    export_data.list_views = Creator.getCollection(\"object_listviews\").find({\n      _id: {\n        $in: record.list_views\n      }\n    }, {\n      fields: ignore_fields\n    }).fetch();\n  }\n  if (_.isArray(record.permission_set) && record.permission_set.length > 0) {\n    export_data.permission_set = Creator.getCollection(\"permission_set\").find({\n      _id: {\n        $in: record.permission_set\n      }\n    }, {\n      fields: ignore_fields\n    }).fetch();\n  }\n  if (_.isArray(record.permission_objects) && record.permission_objects.length > 0) {\n    export_data.permission_objects = Creator.getCollection(\"permission_objects\").find({\n      _id: {\n        $in: record.permission_objects\n      }\n    }, {\n      fields: ignore_fields\n    }).fetch();\n  }\n  if (_.isArray(record.reports) && record.reports.length > 0) {\n    export_data.reports = Creator.getCollection(\"reports\").find({\n      _id: {\n        $in: record.reports\n      }\n    }, {\n      fields: ignore_fields\n    }).fetch();\n  }\n  return export_data;\n};\n"]}