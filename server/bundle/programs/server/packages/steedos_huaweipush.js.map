{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos:huaweipush/checkNpm.js","meteor://ðŸ’»app/packages/steedos:huaweipush/server/huaweiProvider.js"],"names":["checkNpmVersions","module","link","v","request","require","tokenUrl","apiUrl","timeout","HuaweiPush","authInfo","default_package_name","undefined","config","forEach","val","package_name","access_token_expire","debug","console","info","sendMany","notification","tokenDataList","timeToLive","android","title","mapTokenData","tokenData","error","tokenList","push","token","doSendMany","tokens","checkToken","tokenError","log","postData","getPostData","post","url","qs","nsp_ctx","client_id","form","maxAttempts","retryDelay","time","retryStrategy","RetryStrategies","NetworkError","response","body","statusCode","access_token","nsp_svc","nsp_ts","Math","floor","Date","now","payload","hps","msg","type","content","message","action","param","appPkgName","ext","customize","extras","JSON","stringify","device_token_list","expire_time","formatHuaweiDate","sendAll","callback","grant_type","client_secret","data","parse","expires_in","date","moment","format","Array","isArray","extraArray","keys","Object","key"],"mappings":"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","file":"/packages/steedos_huaweipush.js","sourcesContent":["import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\t'requestretry': '^1.12.2'\n}, 'steedos:huaweipush');","const request = require('requestretry');\nconst tokenUrl = \"https://login.vmall.com/oauth2/token\";\nconst apiUrl = \"https://api.push.hicloud.com/pushsend.do\";\nconst timeout = 5000;\n\nHuaweiPush = {\n\tauthInfo: {},\n\tdefault_package_name: undefined\n};\n\nHuaweiPush.config = function(config) {\n\tconfig.forEach((val) => {\n\t\tif (this.authInfo[val.package_name])\n\t\t\treturn\n\t\tthis.authInfo[val.package_name] = val;\n\t\tval.access_token_expire = 0;\n\t\tif (!this.default_package_name) {\n\t\t\tthis.default_package_name = val.package_name;\n\t\t\tif (HuaweiPush.debug)\n\t\t\t\tconsole.info('huawei default package name ', this.default_package_name);\n\t\t}\n\t});\n}\n\nHuaweiPush.sendMany = function(notification, tokenDataList, timeToLive) {\n\tif (notification.android.title) {\n\t\tconst mapTokenData = {};\n\t\tfor (const tokenData of tokenDataList) {\n\t\t\tconst package_name = tokenData.package_name || this.default_package_name;\n\t\t\tif (!this.authInfo[package_name]) {\n\t\t\t\tconsole.error('huawei package name not supported: ', package_name);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst tokenList = mapTokenData[package_name] || [];\n\t\t\ttokenList.push(tokenData.token);\n\t\t\tmapTokenData[package_name] = tokenList;\n\t\t}\n\n\t\tfor (const package_name in mapTokenData) {\n\t\t\tthis.doSendMany(notification, package_name, mapTokenData[package_name], timeToLive);\n\t\t}\n\t}\n}\n\nHuaweiPush.doSendMany = function(notification, package_name, tokens, timeToLive) {\n\tthis.checkToken(package_name, (tokenError) => {\n\t\tif (!tokenError) {\n\t\t\tif (HuaweiPush.debug)\n\t\t\t\tconsole.log(\"sendMany \", notification, timeToLive);\n\t\t\tconst postData = this.getPostData(notification, package_name, tokens, timeToLive);\n\t\t\trequest.post({\n\t\t\t\turl: apiUrl,\n\t\t\t\tqs: {\n\t\t\t\t\tnsp_ctx: `{\"ver\":1,\"appId\":\"${this.authInfo[package_name].client_id}\"}`\n\t\t\t\t},\n\t\t\t\tform: postData,\n\t\t\t\ttimeout: timeout,\n\t\t\t\tmaxAttempts: 2,\n\t\t\t\tretryDelay: 5000,\n\t\t\t\ttime: true,\n\t\t\t\tretryStrategy: request.RetryStrategies.NetworkError\n\t\t\t}, (error, response, body) => {\n\t\t\t\tif (HuaweiPush.debug)\n\t\t\t\t\tconsole.log(\"sendMany result\", error, body);\n\t\t\t\tif (!error && response && response.statusCode == 200) {\n\t\t\t\t\tif (HuaweiPush.debug)\n\t\t\t\t\t\tconsole.log(\"TODO: callback\");\n\t\t\t\t} else {\n\t\t\t\t\terror = error || 'unknown error';\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nHuaweiPush.getPostData = function(notification, package_name, tokens, timeToLive) {\n\tconst postData = {\n\t\taccess_token: this.authInfo[package_name].access_token,\n\t\tnsp_svc: \"openpush.message.api.send\",\n\t\tnsp_ts: Math.floor(Date.now() / 1000)\n\t};\n\tpostData.payload = {\n\t\thps: {\n\t\t\tmsg: {\n\t\t\t\ttype: 3,\n\t\t\t\tbody: {\n\t\t\t\t\tcontent: notification.android.message,\n\t\t\t\t\ttitle: notification.android.title\n\t\t\t\t},\n\t\t\t\taction: {\n\t\t\t\t\ttype: 3,\n\t\t\t\t\tparam: {\n\t\t\t\t\t\tappPkgName: package_name\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\text: {\n\t\t\t\tcustomize: this.extras(notification.extras)\n\t\t\t}\n\t\t}\n\t};\n\tpostData.payload = JSON.stringify(postData.payload);\n\tpostData.device_token_list = JSON.stringify(tokens);\n\n\tif (timeToLive > 0) {\n\t\tpostData.expire_time = this.formatHuaweiDate(new Date(Date.now() + timeToLive));\n\t\tif (HuaweiPush.debug)\n\t\t\tconsole.log(\"postData.expire_time \", postData.expire_time);\n\t}\n\treturn postData;\n}\n\nHuaweiPush.sendAll = function(notification, timeToLive) {\n\tif (notification.android.title) {\n\t\tfor (const package_name in this.authInfo) {\n\t\t\tconsole.log(\"TODO: sendAll\");\n\t\t}\n\t}\n}\n\nHuaweiPush.checkToken = function(package_name, callback) {\n\tconst authInfo = this.authInfo[package_name];\n\tif (authInfo.access_token && Date.now() < authInfo.access_token_expire) {\n\t\tcallback();\n\t} else {\n\t\tif (HuaweiPush.debug)\n\t\t\tconsole.info(\"request token \", package_name, this.authInfo[package_name]);\n\t\trequest.post({\n\t\t\turl: tokenUrl,\n\t\t\tform: {\n\t\t\t\tgrant_type: \"client_credentials\",\n\t\t\t\tclient_id: authInfo.client_id,\n\t\t\t\tclient_secret: authInfo.client_secret\n\t\t\t},\n\t\t\ttimeout: timeout,\n\t\t\tmaxAttempts: 2,\n\t\t\tretryDelay: 5000,\n\t\t\tretryStrategy: request.RetryStrategies.NetworkError\n\t\t}, (error, response, body) => {\n\t\t\tif (!error) {\n\t\t\t\tconst data = JSON.parse(body);\n\t\t\t\tauthInfo.access_token = data.access_token;\n\t\t\t\tauthInfo.access_token_expire = Date.now() + data.expires_in * 1000 - 60 * 1000;\n\t\t\t\tif (HuaweiPush.debug)\n\t\t\t\t\tconsole.info(\"get access token success\", data);\n\t\t\t\tcallback();\n\t\t\t} else {\n\t\t\t\tconsole.error(\"get access token error\", body);\n\t\t\t\tcallback(error);\n\t\t\t}\n\t\t});\n\t}\n}\n\nHuaweiPush.formatHuaweiDate = function(date) {\n\treturn moment(date).format(\"YYYY-MM-DDTHH:mm\");\n}\n\n/*\n * ç”¨æˆ·è‡ªå®šä¹‰ dict\n * \"extras\":{\"season\":\"Spring\", \"weather\":\"raining\"}]\n */\nHuaweiPush.extras = function(extras) {\n\tif (Array.isArray(extras))\n\t\treturn extras;\n\n\tvar extraArray = [];\n\tif (extras) {\n\t\tvar keys = Object.keys(extras);\n\t\tkeys.forEach(function(key) {\n\t\t\tvar v = {};\n\t\t\tv[key] = extras[key];\n\t\t\textraArray.push(v)\n\t\t})\n\t\textras = extraArray\n\t}\n\treturn extraArray;\n};"]}