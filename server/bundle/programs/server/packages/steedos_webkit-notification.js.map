{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos_webkit-notification/server/models/raix_push_notifications.coffee","meteor://ðŸ’»app/server/models/raix_push_notifications.coffee","meteor://ðŸ’»app/packages/steedos_webkit-notification/server/methods/calculate_box.coffee","meteor://ðŸ’»app/server/methods/calculate_box.coffee"],"names":["db","raix_push_notifications","Push","notifications","Meteor","isServer","publish","query","userId","ready","$regex","createdAt","$gt","Date","find","fields","badge","from","title","text","payload","sort","limit","methods","calculateBox","instanceId","box","cc_users","inbox_users","instance","check","String","instances","findOne","_id","_","indexOf"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGAA,GAAGC,uBAAH,GAA6BC,KAAKC,aAAlC;;AAEA,IAAGC,OAAOC,QAAV;AACID,SAAOE,OAAP,CAAe,yBAAf,EAA0C;AAEtC,QAAAC,KAAA;;AAAA,SAAO,KAAKC,MAAZ;AACI,aAAO,KAAKC,KAAL,EAAP;ACFP;;ADMGF,YAAQ;AAACA,aAAO;AAACG,gBAAO,mBAAmB,KAAKF,MAAxB,GAAiC;AAAzC,OAAR;AAAwDG,iBAAU;AAACC,aAAK,IAAIC,IAAJ;AAAN;AAAlE,KAAR;AAEA,WAAOb,GAAGC,uBAAH,CAA2Ba,IAA3B,CAAgCP,KAAhC,EAAuC;AAACQ,cAAQ;AAACC,eAAM,CAAP;AAAUC,cAAK,CAAf;AAAkBC,eAAO,CAAzB;AAA4BC,cAAK,CAAjC;AAAoCC,iBAAQ;AAA5C,OAAT;AAAyDC,YAAK;AAACV,mBAAU,CAAC;AAAZ,OAA9D;AAA6EW,aAAM;AAAnF,KAAvC,CAAP;AATJ;ACwBH,C;;;;;;;;;;;;AC9BDlB,OAAOmB,OAAP,CACC;AAAAC,gBAAc,UAACC,UAAD;AACb,QAAAC,GAAA,EAAAC,QAAA,EAAAC,WAAA,EAAAC,QAAA,EAAArB,MAAA;AAAAsB,UAAML,UAAN,EAAkBM,MAAlB;AACAvB,aAAS,KAAKA,MAAd;AACAqB,eAAW7B,GAAGgC,SAAH,CAAaC,OAAb,CAAqB;AAACC,WAAKT;AAAN,KAArB,EAAuC;AAACV,cAAQ;AAACa,qBAAa,CAAd;AAAiBD,kBAAU;AAA3B;AAAT,KAAvC,CAAX;AACAC,kBAAcC,SAASD,WAAvB;AACAD,eAAWE,SAASF,QAApB;AAEAD,UAAM,EAAN;;AAEA,QAAGS,EAAEC,OAAF,CAAUR,WAAV,EAAuBpB,MAAvB,KAAkC,CAAlC,IAAuC2B,EAAEC,OAAF,CAAUT,QAAV,EAAoBnB,MAApB,KAA+B,CAAzE;AACCkB,YAAM,OAAN;AADD;AAGCA,YAAM,QAAN;ACOE;;ADLH,WAAOA,GAAP;AAdD;AAAA,CADD,E","file":"/packages/steedos_webkit-notification.js","sourcesContent":["\n# db.raix_push_notifications = new Mongo.Collection('_raix_push_notifications');\n\ndb.raix_push_notifications = Push.notifications\n\nif Meteor.isServer\n    Meteor.publish 'raix_push_notifications', ->\n\n        unless this.userId\n            return this.ready()\n\n        # appName = \"workflow\"\n        \n        query = {query: {$regex:\"{\\\"userId\\\":\\\"\" + this.userId + \"\\\",\"},createdAt:{$gt: new Date()}}\n\n        return db.raix_push_notifications.find(query, {fields: {badge:1, from:1, title: 1, text:1, payload:1}, sort:{createdAt:-1},limit:5})","db.raix_push_notifications = Push.notifications;\n\nif (Meteor.isServer) {\n  Meteor.publish('raix_push_notifications', function() {\n    var query;\n    if (!this.userId) {\n      return this.ready();\n    }\n    query = {\n      query: {\n        $regex: \"{\\\"userId\\\":\\\"\" + this.userId + \"\\\",\"\n      },\n      createdAt: {\n        $gt: new Date()\n      }\n    };\n    return db.raix_push_notifications.find(query, {\n      fields: {\n        badge: 1,\n        from: 1,\n        title: 1,\n        text: 1,\n        payload: 1\n      },\n      sort: {\n        createdAt: -1\n      },\n      limit: 5\n    });\n  });\n}\n","Meteor.methods\n\tcalculateBox: (instanceId) ->\n\t\tcheck instanceId, String\n\t\tuserId = this.userId\n\t\tinstance = db.instances.findOne({_id: instanceId},{fields: {inbox_users: 1, cc_users: 1}})\n\t\tinbox_users = instance.inbox_users\n\t\tcc_users = instance.cc_users\n\n\t\tbox = \"\"\n\n\t\tif _.indexOf(inbox_users, userId) >= 0 || _.indexOf(cc_users, userId) >= 0\n\t\t\tbox = \"inbox\"\n\t\telse\n\t\t\tbox = \"outbox\"\n\n\t\treturn box","Meteor.methods({\n  calculateBox: function(instanceId) {\n    var box, cc_users, inbox_users, instance, userId;\n    check(instanceId, String);\n    userId = this.userId;\n    instance = db.instances.findOne({\n      _id: instanceId\n    }, {\n      fields: {\n        inbox_users: 1,\n        cc_users: 1\n      }\n    });\n    inbox_users = instance.inbox_users;\n    cc_users = instance.cc_users;\n    box = \"\";\n    if (_.indexOf(inbox_users, userId) >= 0 || _.indexOf(cc_users, userId) >= 0) {\n      box = \"inbox\";\n    } else {\n      box = \"outbox\";\n    }\n    return box;\n  }\n});\n"]}