{"version":3,"sources":["meteor://💻app/packages/steedos:instance-record-queue/lib/common/main.js","meteor://💻app/packages/steedos:instance-record-queue/lib/common/docs.js","meteor://💻app/packages/steedos:instance-record-queue/lib/server/api.js","meteor://💻app/packages/steedos_instance-record-queue/server/startup.coffee","meteor://💻app/server/startup.coffee","meteor://💻app/packages/steedos:instance-record-queue/server/checkNpm.js"],"names":["InstanceRecordQueue","EventState","collection","db","instance_record_queue","Mongo","Collection","_validateDocument","doc","check","info","Object","sent","Match","Optional","Boolean","sending","Integer","createdAt","Date","createdBy","OneOf","String","send","options","currentUser","Meteor","isClient","userId","isServer","_","extend","test","pick","insert","objectql","require","runQuoted","objectName","recordId","runQuotedByObjectFieldFormulas","runQuotedByObjectFieldSummaries","_eval","isConfigured","sendWorker","task","interval","debug","console","log","setInterval","error","message","Configure","self","sendTimeout","Error","_querySend","sendDoc","_id","serverSend","isSendingDoc","sendInterval","_ensureIndex","now","timeoutAt","reserved","update","$lt","$set","result","keepDocs","remove","sentAt","batchSize","sendBatchSize","pendingDocs","find","$and","errMsg","$exists","sort","limit","forEach","stack","syncAttach","sync_attachment","insId","spaceId","newRecordId","cfs","instances","f","hasStored","newFile","FS","File","cmsFileId","Creator","getCollection","_makeNewID","attachData","createReadStream","type","original","err","reason","name","size","metadata","owner","owner_name","space","record_id","object_name","parent","files","wrapAsync","cb","once","storeName","o","ids","extention","extension","versions","created_by","modified_by","parents","includes","push","current","$addToSet","syncInsFields","syncValues","field_map_back","values","ins","objectInfo","field_map_back_script","record","obj","tableFieldCodes","tableFieldMap","tableToRelatedMap","form","findOne","formFields","form_version","fields","formVersion","historys","h","objectFields","objectFieldKeys","keys","relatedObjects","getRelatedObjects","relatedObjectsKeys","pluck","formTableFields","filter","formField","formTableFieldsCode","getRelatedObjectField","key","relatedObjectsKey","startsWith","getFormTableField","formTableFieldCode","getFormField","_formFields","_fieldCode","each","ff","code","fm","relatedObjectField","object_field","formTableField","workflow_field","oTableCode","split","oTableFieldCode","tableToRelatedMapKey","wTableCode","indexOf","hasOwnProperty","isArray","JSON","stringify","workflow_table_field_code","object_table_field_code","wField","oField","reference_to","isEmpty","multiple","is_multiselect","compact","id","isString","oCollection","referObject","getObject","referData","nameFieldKey","NAME_FIELD_KEY","selector","tmp_field_value","temObjFields","length","objField","referObjField","referSetObj","insField","uniq","tfc","c","parse","tr","newTr","v","k","tfm","oTdCode","relatedObjs","getRelatedFieldValue","valueKey","reduce","x","map","tableCode","_FROM_TABLE_CODE","warn","relatedObjectName","relatedObjectValues","relatedObject","tableValueItem","relatedObjectValue","fieldKey","relatedObjectFieldValue","formFieldKey","_code","evalFieldMapBackScript","filterObj","mainObjectValue","relatedObjectsValue","script","func","isObject","syncRelatedObjectsValue","mainRecordId","objectCollection","tableMap","table_id","_table","table_code","oldRelatedRecord","foreign_key","applicant","instance_state","state","final_decision","validate","tableIds","$nin","instance_id","records","flow","traces","ow","flow_id","$in","setObj","removeOldFiles","newObj","r","$push","record_ids","$pull","startup","ref","settings","cron","instancerecordqueue_interval","checkNpmVersions","module","link"],"mappings":"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","file":"/packages/steedos_instance-record-queue.js","sourcesContent":["InstanceRecordQueue = new EventState();","InstanceRecordQueue.collection = db.instance_record_queue = new Mongo.Collection('instance_record_queue');\n\nvar _validateDocument = function(doc) {\n\n\tcheck(doc, {\n\t\tinfo: Object,\n\t\tsent: Match.Optional(Boolean),\n\t\tsending: Match.Optional(Match.Integer),\n\t\tcreatedAt: Date,\n\t\tcreatedBy: Match.OneOf(String, null)\n\t});\n\n};\n\nInstanceRecordQueue.send = function(options) {\n\tvar currentUser = Meteor.isClient && Meteor.userId && Meteor.userId() || Meteor.isServer && (options.createdBy || '<SERVER>') || null\n\tvar doc = _.extend({\n\t\tcreatedAt: new Date(),\n\t\tcreatedBy: currentUser\n\t});\n\n\tif (Match.test(options, Object)) {\n\t\tdoc.info = _.pick(options, 'instance_id', 'records', 'sync_date', 'instance_finish_date', 'step_name');\n\t}\n\n\tdoc.sent = false;\n\tdoc.sending = 0;\n\n\t_validateDocument(doc);\n\n\treturn InstanceRecordQueue.collection.insert(doc);\n};","const objectql = require('@steedos/objectql');\nvar runQuoted = function (objectName, recordId) {\n\tobjectql.runQuotedByObjectFieldFormulas(objectName, recordId);\n\tobjectql.runQuotedByObjectFieldSummaries(objectName, recordId);\n}\n\nvar _eval = require('eval');\nvar isConfigured = false;\nvar sendWorker = function (task, interval) {\n\n\tif (InstanceRecordQueue.debug) {\n\t\tconsole.log('InstanceRecordQueue: Send worker started, using interval: ' + interval);\n\t}\n\n\treturn Meteor.setInterval(function () {\n\t\ttry {\n\t\t\ttask();\n\t\t} catch (error) {\n\t\t\tconsole.log('InstanceRecordQueue: Error while sending: ' + error.message);\n\t\t}\n\t}, interval);\n};\n\n/*\n\toptions: {\n\t\t// Controls the sending interval\n\t\tsendInterval: Match.Optional(Number),\n\t\t// Controls the sending batch size per interval\n\t\tsendBatchSize: Match.Optional(Number),\n\t\t// Allow optional keeping notifications in collection\n\t\tkeepDocs: Match.Optional(Boolean)\n\t}\n*/\nInstanceRecordQueue.Configure = function (options) {\n\tvar self = this;\n\toptions = _.extend({\n\t\tsendTimeout: 60000, // Timeout period\n\t}, options);\n\n\t// Block multiple calls\n\tif (isConfigured) {\n\t\tthrow new Error('InstanceRecordQueue.Configure should not be called more than once!');\n\t}\n\n\tisConfigured = true;\n\n\t// Add debug info\n\tif (InstanceRecordQueue.debug) {\n\t\tconsole.log('InstanceRecordQueue.Configure', options);\n\t}\n\n\n\n\t// Universal send function\n\tvar _querySend = function (doc) {\n\n\t\tif (InstanceRecordQueue.sendDoc) {\n\t\t\tInstanceRecordQueue.sendDoc(doc);\n\t\t}\n\n\t\treturn {\n\t\t\tdoc: [doc._id]\n\t\t};\n\t};\n\n\tself.serverSend = function (doc) {\n\t\tdoc = doc || {};\n\t\treturn _querySend(doc);\n\t};\n\n\n\t// This interval will allow only one doc to be sent at a time, it\n\t// will check for new docs at every `options.sendInterval`\n\t// (default interval is 15000 ms)\n\t//\n\t// It looks in docs collection to see if theres any pending\n\t// docs, if so it will try to reserve the pending doc.\n\t// If successfully reserved the send is started.\n\t//\n\t// If doc.query is type string, it's assumed to be a json string\n\t// version of the query selector. Making it able to carry `$` properties in\n\t// the mongo collection.\n\t//\n\t// Pr. default docs are removed from the collection after send have\n\t// completed. Setting `options.keepDocs` will update and keep the\n\t// doc eg. if needed for historical reasons.\n\t//\n\t// After the send have completed a \"send\" event will be emitted with a\n\t// status object containing doc id and the send result object.\n\t//\n\tvar isSendingDoc = false;\n\n\tif (options.sendInterval !== null) {\n\n\t\t// This will require index since we sort docs by createdAt\n\t\tInstanceRecordQueue.collection._ensureIndex({\n\t\t\tcreatedAt: 1\n\t\t});\n\t\tInstanceRecordQueue.collection._ensureIndex({\n\t\t\tsent: 1\n\t\t});\n\t\tInstanceRecordQueue.collection._ensureIndex({\n\t\t\tsending: 1\n\t\t});\n\n\n\t\tvar sendDoc = function (doc) {\n\t\t\t// Reserve doc\n\t\t\tvar now = +new Date();\n\t\t\tvar timeoutAt = now + options.sendTimeout;\n\t\t\tvar reserved = InstanceRecordQueue.collection.update({\n\t\t\t\t_id: doc._id,\n\t\t\t\tsent: false, // xxx: need to make sure this is set on create\n\t\t\t\tsending: {\n\t\t\t\t\t$lt: now\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\t$set: {\n\t\t\t\t\tsending: timeoutAt,\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Make sure we only handle docs reserved by this\n\t\t\t// instance\n\t\t\tif (reserved) {\n\n\t\t\t\t// Send\n\t\t\t\tvar result = self.serverSend(doc);\n\n\t\t\t\tif (!options.keepDocs) {\n\t\t\t\t\t// Pr. Default we will remove docs\n\t\t\t\t\tInstanceRecordQueue.collection.remove({\n\t\t\t\t\t\t_id: doc._id\n\t\t\t\t\t});\n\t\t\t\t} else {\n\n\t\t\t\t\t// Update\n\t\t\t\t\tInstanceRecordQueue.collection.update({\n\t\t\t\t\t\t_id: doc._id\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t// Mark as sent\n\t\t\t\t\t\t\tsent: true,\n\t\t\t\t\t\t\t// Set the sent date\n\t\t\t\t\t\t\tsentAt: new Date(),\n\t\t\t\t\t\t\t// Not being sent anymore\n\t\t\t\t\t\t\tsending: 0\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t}\n\n\t\t\t\t// // Emit the send\n\t\t\t\t// InstanceRecordQueue.emit('send', {\n\t\t\t\t// \tdoc: doc._id,\n\t\t\t\t// \tresult: result\n\t\t\t\t// });\n\n\t\t\t} // Else could not reserve\n\t\t}; // EO sendDoc\n\n\t\tsendWorker(function () {\n\n\t\t\tif (isSendingDoc) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// Set send fence\n\t\t\tisSendingDoc = true;\n\n\t\t\tvar batchSize = options.sendBatchSize || 1;\n\n\t\t\tvar now = +new Date();\n\n\t\t\t// Find docs that are not being or already sent\n\t\t\tvar pendingDocs = InstanceRecordQueue.collection.find({\n\t\t\t\t$and: [\n\t\t\t\t\t// Message is not sent\n\t\t\t\t\t{\n\t\t\t\t\t\tsent: false\n\t\t\t\t\t},\n\t\t\t\t\t// And not being sent by other instances\n\t\t\t\t\t{\n\t\t\t\t\t\tsending: {\n\t\t\t\t\t\t\t$lt: now\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t// And no error\n\t\t\t\t\t{\n\t\t\t\t\t\terrMsg: {\n\t\t\t\t\t\t\t$exists: false\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}, {\n\t\t\t\t// Sort by created date\n\t\t\t\tsort: {\n\t\t\t\t\tcreatedAt: 1\n\t\t\t\t},\n\t\t\t\tlimit: batchSize\n\t\t\t});\n\n\t\t\tpendingDocs.forEach(function (doc) {\n\t\t\t\ttry {\n\t\t\t\t\tsendDoc(doc);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(error.stack);\n\t\t\t\t\tconsole.log('InstanceRecordQueue: Could not send doc id: \"' + doc._id + '\", Error: ' + error.message);\n\t\t\t\t\tInstanceRecordQueue.collection.update({\n\t\t\t\t\t\t_id: doc._id\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t// error message\n\t\t\t\t\t\t\terrMsg: error.message\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}); // EO forEach\n\n\t\t\t// Remove the send fence\n\t\t\tisSendingDoc = false;\n\t\t}, options.sendInterval || 15000); // Default every 15th sec\n\n\t} else {\n\t\tif (InstanceRecordQueue.debug) {\n\t\t\tconsole.log('InstanceRecordQueue: Send server is disabled');\n\t\t}\n\t}\n\n};\n\nInstanceRecordQueue.syncAttach = function (sync_attachment, insId, spaceId, newRecordId, objectName) {\n\tif (sync_attachment == \"lastest\") {\n\t\tcfs.instances.find({\n\t\t\t'metadata.instance': insId,\n\t\t\t'metadata.current': true\n\t\t}).forEach(function (f) {\n\t\t\tif (!f.hasStored('instances')) {\n\t\t\t\tconsole.error('syncAttach-file not stored: ', f._id);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar newFile = new FS.File(),\n\t\t\t\tcmsFileId = Creator.getCollection('cms_files')._makeNewID();\n\t\t\tnewFile.attachData(f.createReadStream('instances'), {\n\t\t\t\ttype: f.original.type\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\n\t\t\t\t}\n\t\t\t\tnewFile.name(f.name());\n\t\t\t\tnewFile.size(f.size());\n\t\t\t\tvar metadata = {\n\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\towner_name: f.metadata.owner_name,\n\t\t\t\t\tspace: spaceId,\n\t\t\t\t\trecord_id: newRecordId,\n\t\t\t\t\tobject_name: objectName,\n\t\t\t\t\tparent: cmsFileId\n\t\t\t\t};\n\n\t\t\t\tnewFile.metadata = metadata;\n\t\t\t\tcfs.files.insert(newFile);\n\t\t\t});\n\t\t\tMeteor.wrapAsync(function (newFile, Creator, cmsFileId, objectName, newRecordId, spaceId, f, cb) {\n\t\t\t\tnewFile.once('stored', function (storeName) {\n\t\t\t\t\tCreator.getCollection('cms_files').insert({\n\t\t\t\t\t\t_id: cmsFileId,\n\t\t\t\t\t\tparent: {\n\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsize: newFile.size(),\n\t\t\t\t\t\tname: newFile.name(),\n\t\t\t\t\t\textention: newFile.extension(),\n\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\tversions: [newFile._id],\n\t\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\t\tcreated_by: f.metadata.owner,\n\t\t\t\t\t\tmodified_by: f.metadata.owner\n\t\t\t\t\t});\n\n\t\t\t\t\tcb(null);\n\t\t\t\t});\n\t\t\t\tnewFile.once('error', function (error) {\n\t\t\t\t\tconsole.error('syncAttach-error: ', error);\n\t\t\t\t\tcb(error);\n\t\t\t\t});\n\t\t\t})(newFile, Creator, cmsFileId, objectName, newRecordId, spaceId, f);\n\t\t})\n\t} else if (sync_attachment == \"all\") {\n\t\tvar parents = [];\n\t\tcfs.instances.find({\n\t\t\t'metadata.instance': insId\n\t\t}).forEach(function (f) {\n\t\t\tif (!f.hasStored('instances')) {\n\t\t\t\tconsole.error('syncAttach-file not stored: ', f._id);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar newFile = new FS.File(),\n\t\t\t\tcmsFileId = f.metadata.parent;\n\n\t\t\tif (!parents.includes(cmsFileId)) {\n\t\t\t\tparents.push(cmsFileId);\n\t\t\t\tCreator.getCollection('cms_files').insert({\n\t\t\t\t\t_id: cmsFileId,\n\t\t\t\t\tparent: {\n\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t},\n\t\t\t\t\tspace: spaceId,\n\t\t\t\t\tversions: [],\n\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\tcreated_by: f.metadata.owner,\n\t\t\t\t\tmodified_by: f.metadata.owner\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tnewFile.attachData(f.createReadStream('instances'), {\n\t\t\t\ttype: f.original.type\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\n\t\t\t\t}\n\t\t\t\tnewFile.name(f.name());\n\t\t\t\tnewFile.size(f.size());\n\t\t\t\tvar metadata = {\n\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\towner_name: f.metadata.owner_name,\n\t\t\t\t\tspace: spaceId,\n\t\t\t\t\trecord_id: newRecordId,\n\t\t\t\t\tobject_name: objectName,\n\t\t\t\t\tparent: cmsFileId\n\t\t\t\t};\n\n\t\t\t\tnewFile.metadata = metadata;\n\t\t\t\tcfs.files.insert(newFile);\n\t\t\t});\n\t\t\tMeteor.wrapAsync(function (newFile, Creator, cmsFileId, f, cb) {\n\t\t\t\tnewFile.once('stored', function (storeName) {\n\t\t\t\t\tif (f.metadata.current == true) {\n\t\t\t\t\t\tCreator.getCollection('cms_files').update(cmsFileId, {\n\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\tsize: newFile.size(),\n\t\t\t\t\t\t\t\tname: newFile.name(),\n\t\t\t\t\t\t\t\textention: newFile.extension(),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t$addToSet: {\n\t\t\t\t\t\t\t\tversions: newFile._id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tCreator.getCollection('cms_files').update(cmsFileId, {\n\t\t\t\t\t\t\t$addToSet: {\n\t\t\t\t\t\t\t\tversions: newFile._id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tcb(null);\n\t\t\t\t});\n\t\t\t\tnewFile.once('error', function (error) {\n\t\t\t\t\tconsole.error('syncAttach-error: ', error);\n\t\t\t\t\tcb(error);\n\t\t\t\t});\n\t\t\t})(newFile, Creator, cmsFileId, f);\n\t\t})\n\t}\n}\n\nInstanceRecordQueue.syncInsFields = ['name', 'submitter_name', 'applicant_name', 'applicant_organization_name', 'applicant_organization_fullname', 'state',\n\t'current_step_name', 'flow_name', 'category_name', 'submit_date', 'finish_date', 'final_decision', 'applicant_organization', 'applicant_company'\n];\nInstanceRecordQueue.syncValues = function (field_map_back, values, ins, objectInfo, field_map_back_script, record) {\n\tvar\n\t\tobj = {},\n\t\ttableFieldCodes = [],\n\t\ttableFieldMap = [],\n\t\ttableToRelatedMap = {};\n\n\tfield_map_back = field_map_back || [];\n\n\tvar spaceId = ins.space;\n\n\tvar form = Creator.getCollection(\"forms\").findOne(ins.form);\n\tvar formFields = null;\n\tif (form.current._id === ins.form_version) {\n\t\tformFields = form.current.fields || [];\n\t} else {\n\t\tvar formVersion = _.find(form.historys, function (h) {\n\t\t\treturn h._id === ins.form_version;\n\t\t})\n\t\tformFields = formVersion ? formVersion.fields : [];\n\t}\n\n\tvar objectFields = objectInfo.fields;\n\tvar objectFieldKeys = _.keys(objectFields);\n\tvar relatedObjects = Creator.getRelatedObjects(objectInfo.name, spaceId);\n\tvar relatedObjectsKeys = _.pluck(relatedObjects, 'object_name');\n\tvar formTableFields = _.filter(formFields, function (formField) {\n\t\treturn formField.type === 'table'\n\t});\n\tvar formTableFieldsCode = _.pluck(formTableFields, 'code');\n\n\tvar getRelatedObjectField = function (key) {\n\t\treturn _.find(relatedObjectsKeys, function (relatedObjectsKey) {\n\t\t\treturn key.startsWith(relatedObjectsKey + '.');\n\t\t})\n\t};\n\n\tvar getFormTableField = function (key) {\n\t\treturn _.find(formTableFieldsCode, function (formTableFieldCode) {\n\t\t\treturn key.startsWith(formTableFieldCode + '.');\n\t\t})\n\t};\n\n\tvar getFormField = function (_formFields, _fieldCode) {\n\t\tvar formField = null;\n\t\t_.each(_formFields, function (ff) {\n\t\t\tif (!formField) {\n\t\t\t\tif (ff.code === _fieldCode) {\n\t\t\t\t\tformField = ff;\n\t\t\t\t} else if (ff.type === 'section') {\n\t\t\t\t\t_.each(ff.fields, function (f) {\n\t\t\t\t\t\tif (!formField) {\n\t\t\t\t\t\t\tif (f.code === _fieldCode) {\n\t\t\t\t\t\t\t\tformField = f;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t} else if (ff.type === 'table') {\n\t\t\t\t\t_.each(ff.fields, function (f) {\n\t\t\t\t\t\tif (!formField) {\n\t\t\t\t\t\t\tif (f.code === _fieldCode) {\n\t\t\t\t\t\t\t\tformField = f;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn formField;\n\t}\n\n\tfield_map_back.forEach(function (fm) {\n\t\t//workflow 的子表到creator object 的相关对象\n\t\tvar relatedObjectField = getRelatedObjectField(fm.object_field);\n\t\tvar formTableField = getFormTableField(fm.workflow_field);\n\t\tif (relatedObjectField) {\n\t\t\tvar oTableCode = fm.object_field.split('.')[0];\n\t\t\tvar oTableFieldCode = fm.object_field.split('.')[1];\n\t\t\tvar tableToRelatedMapKey = oTableCode;\n\t\t\tif (!tableToRelatedMap[tableToRelatedMapKey]) {\n\t\t\t\ttableToRelatedMap[tableToRelatedMapKey] = {}\n\t\t\t}\n\n\t\t\tif (formTableField) {\n\t\t\t\tvar wTableCode = fm.workflow_field.split('.')[0];\n\t\t\t\ttableToRelatedMap[tableToRelatedMapKey]['_FROM_TABLE_CODE'] = wTableCode\n\t\t\t}\n\n\t\t\ttableToRelatedMap[tableToRelatedMapKey][oTableFieldCode] = fm.workflow_field\n\t\t}\n\t\t// 判断是否是子表字段\n\t\telse if (fm.workflow_field.indexOf('.$.') > 0 && fm.object_field.indexOf('.$.') > 0) {\n\t\t\tvar wTableCode = fm.workflow_field.split('.$.')[0];\n\t\t\tvar oTableCode = fm.object_field.split('.$.')[0];\n\t\t\tif (values.hasOwnProperty(wTableCode) && _.isArray(values[wTableCode])) {\n\t\t\t\ttableFieldCodes.push(JSON.stringify({\n\t\t\t\t\tworkflow_table_field_code: wTableCode,\n\t\t\t\t\tobject_table_field_code: oTableCode\n\t\t\t\t}));\n\t\t\t\ttableFieldMap.push(fm);\n\t\t\t}\n\n\t\t}\n\t\telse if (values.hasOwnProperty(fm.workflow_field)) {\n\t\t\tvar wField = null;\n\n\t\t\t_.each(formFields, function (ff) {\n\t\t\t\tif (!wField) {\n\t\t\t\t\tif (ff.code === fm.workflow_field) {\n\t\t\t\t\t\twField = ff;\n\t\t\t\t\t} else if (ff.type === 'section') {\n\t\t\t\t\t\t_.each(ff.fields, function (f) {\n\t\t\t\t\t\t\tif (!wField) {\n\t\t\t\t\t\t\t\tif (f.code === fm.workflow_field) {\n\t\t\t\t\t\t\t\t\twField = f;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tvar oField = objectFields[fm.object_field];\n\n\t\t\tif (oField) {\n\t\t\t\tif (!wField) {\n\t\t\t\t\tconsole.log('fm.workflow_field: ', fm.workflow_field)\n\t\t\t\t}\n\t\t\t\t// 表单选人选组字段 至 对象 lookup master_detail类型字段同步\n\t\t\t\tif (['user', 'group'].includes(wField.type) && ['lookup', 'master_detail'].includes(oField.type) && ['users', 'organizations'].includes(oField.reference_to)) {\n\t\t\t\t\tif (!_.isEmpty(values[fm.workflow_field])) {\n\t\t\t\t\t\tif (oField.multiple && wField.is_multiselect) {\n\t\t\t\t\t\t\tobj[fm.object_field] = _.compact(_.pluck(values[fm.workflow_field], 'id'))\n\t\t\t\t\t\t} else if (!oField.multiple && !wField.is_multiselect) {\n\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field].id\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to) && _.isString(values[fm.workflow_field])) {\n\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\n\t\t\t\t\tvar referObject = Creator.getObject(oField.reference_to, spaceId)\n\t\t\t\t\tif (oCollection && referObject) {\n\t\t\t\t\t\t// 先认为此值是referObject _id字段值\n\t\t\t\t\t\tvar referData = oCollection.findOne(values[fm.workflow_field], {\n\t\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\t\t_id: 1\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (referData) {\n\t\t\t\t\t\t\tobj[fm.object_field] = referData._id;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// 其次认为此值是referObject NAME_FIELD_KEY值\n\t\t\t\t\t\tif (!referData) {\n\t\t\t\t\t\t\tvar nameFieldKey = referObject.NAME_FIELD_KEY;\n\t\t\t\t\t\t\tvar selector = {};\n\t\t\t\t\t\t\tselector[nameFieldKey] = values[fm.workflow_field];\n\t\t\t\t\t\t\treferData = oCollection.findOne(selector, {\n\t\t\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\t\t\t_id: 1\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (referData) {\n\t\t\t\t\t\t\t\tobj[fm.object_field] = referData._id;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (oField.type === \"boolean\") {\n\t\t\t\t\t\tvar tmp_field_value = values[fm.workflow_field];\n\t\t\t\t\t\tif (['true', '是'].includes(tmp_field_value)) {\n\t\t\t\t\t\t\tobj[fm.object_field] = true;\n\t\t\t\t\t\t} else if (['false', '否'].includes(tmp_field_value)) {\n\t\t\t\t\t\t\tobj[fm.object_field] = false;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tobj[fm.object_field] = tmp_field_value;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (['lookup', 'master_detail'].includes(oField.type) && wField.type === 'odata') {\n\t\t\t\t\t\tif (oField.multiple && wField.is_multiselect) {\n\t\t\t\t\t\t\tobj[fm.object_field] = _.compact(_.pluck(values[fm.workflow_field], '_id'))\n\t\t\t\t\t\t} else if (!oField.multiple && !wField.is_multiselect) {\n\t\t\t\t\t\t\tif (!_.isEmpty(values[fm.workflow_field])) {\n\t\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field]._id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (fm.object_field.indexOf('.') > -1) {\n\t\t\t\t\tvar temObjFields = fm.object_field.split('.');\n\t\t\t\t\tif (temObjFields.length === 2) {\n\t\t\t\t\t\tvar objField = temObjFields[0];\n\t\t\t\t\t\tvar referObjField = temObjFields[1];\n\t\t\t\t\t\tvar oField = objectFields[objField];\n\t\t\t\t\t\tif (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to)) {\n\t\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\n\t\t\t\t\t\t\tif (oCollection && record && record[objField]) {\n\t\t\t\t\t\t\t\tvar referSetObj = {};\n\t\t\t\t\t\t\t\treferSetObj[referObjField] = values[fm.workflow_field];\n\t\t\t\t\t\t\t\toCollection.update(record[objField], {\n\t\t\t\t\t\t\t\t\t$set: referSetObj\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// else{\n\t\t\t\t// \tvar relatedObject = _.find(relatedObjects, function(_relatedObject){\n\t\t\t\t// \t\treturn _relatedObject.object_name === fm.object_field\n\t\t\t\t// \t})\n\t\t\t\t//\n\t\t\t\t// \tif(relatedObject){\n\t\t\t\t// \t\tobj[fm.object_field] = values[fm.workflow_field];\n\t\t\t\t// \t}\n\t\t\t\t// }\n\t\t\t}\n\n\t\t}\n\t\telse {\n\t\t\tif (fm.workflow_field.startsWith('instance.')) {\n\t\t\t\tvar insField = fm.workflow_field.split('instance.')[1];\n\t\t\t\tif (InstanceRecordQueue.syncInsFields.includes(insField)) {\n\t\t\t\t\tif (fm.object_field.indexOf('.') < 0) {\n\t\t\t\t\t\tobj[fm.object_field] = ins[insField];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvar temObjFields = fm.object_field.split('.');\n\t\t\t\t\t\tif (temObjFields.length === 2) {\n\t\t\t\t\t\t\tvar objField = temObjFields[0];\n\t\t\t\t\t\t\tvar referObjField = temObjFields[1];\n\t\t\t\t\t\t\tvar oField = objectFields[objField];\n\t\t\t\t\t\t\tif (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to)) {\n\t\t\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\n\t\t\t\t\t\t\t\tif (oCollection && record && record[objField]) {\n\t\t\t\t\t\t\t\t\tvar referSetObj = {};\n\t\t\t\t\t\t\t\t\treferSetObj[referObjField] = ins[insField];\n\t\t\t\t\t\t\t\t\toCollection.update(record[objField], {\n\t\t\t\t\t\t\t\t\t\t$set: referSetObj\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tif (ins[fm.workflow_field]) {\n\t\t\t\t\tobj[fm.object_field] = ins[fm.workflow_field];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t})\n\n\t_.uniq(tableFieldCodes).forEach(function (tfc) {\n\t\tvar c = JSON.parse(tfc);\n\t\tobj[c.object_table_field_code] = [];\n\t\tvalues[c.workflow_table_field_code].forEach(function (tr) {\n\t\t\tvar newTr = {};\n\t\t\t_.each(tr, function (v, k) {\n\t\t\t\ttableFieldMap.forEach(function (tfm) {\n\t\t\t\t\tif (tfm.workflow_field == (c.workflow_table_field_code + '.$.' + k)) {\n\t\t\t\t\t\tvar oTdCode = tfm.object_field.split('.$.')[1];\n\t\t\t\t\t\tnewTr[oTdCode] = v;\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t\tif (!_.isEmpty(newTr)) {\n\t\t\t\tobj[c.object_table_field_code].push(newTr);\n\t\t\t}\n\t\t})\n\t});\n\tvar relatedObjs = {};\n\tvar getRelatedFieldValue = function (valueKey, parent) {\n\t\treturn valueKey.split('.').reduce(function (o, x) {\n\t\t\treturn o[x];\n\t\t}, parent);\n\t};\n\t_.each(tableToRelatedMap, function (map, key) {\n\t\tvar tableCode = map._FROM_TABLE_CODE;\n\t\tif (!tableCode) {\n\t\t\tconsole.warn('tableToRelated: [' + key + '] missing corresponding table.')\n\t\t} else {\n\t\t\tvar relatedObjectName = key;\n\t\t\tvar relatedObjectValues = [];\n\t\t\tvar relatedObject = Creator.getObject(relatedObjectName, spaceId);\n\t\t\t_.each(values[tableCode], function (tableValueItem) {\n\t\t\t\tvar relatedObjectValue = {};\n\t\t\t\t_.each(map, function (valueKey, fieldKey) {\n\t\t\t\t\tif (fieldKey != '_FROM_TABLE_CODE') {\n\t\t\t\t\t\tif (valueKey.startsWith('instance.')) {\n\t\t\t\t\t\t\trelatedObjectValue[fieldKey] = getRelatedFieldValue(valueKey, { 'instance': ins });\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tvar relatedObjectFieldValue, formFieldKey;\n\t\t\t\t\t\t\tif (valueKey.startsWith(tableCode + '.')) {\n\t\t\t\t\t\t\t\tformFieldKey = valueKey.split(\".\")[1];\n\t\t\t\t\t\t\t\trelatedObjectFieldValue = getRelatedFieldValue(valueKey, { [tableCode]: tableValueItem });\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tformFieldKey = valueKey;\n\t\t\t\t\t\t\t\trelatedObjectFieldValue = getRelatedFieldValue(valueKey, values)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvar formField = getFormField(formFields, formFieldKey);\n\t\t\t\t\t\t\tvar relatedObjectField = relatedObject.fields[fieldKey];\n\t\t\t\t\t\t\tif (!relatedObjectField || !formField) {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (formField.type == 'odata' && ['lookup', 'master_detail'].includes(relatedObjectField.type)) {\n\t\t\t\t\t\t\t\tif (!_.isEmpty(relatedObjectFieldValue)) {\n\t\t\t\t\t\t\t\t\tif (relatedObjectField.multiple && formField.is_multiselect) {\n\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = _.compact(_.pluck(relatedObjectFieldValue, '_id'))\n\t\t\t\t\t\t\t\t\t} else if (!relatedObjectField.multiple && !formField.is_multiselect) {\n\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = relatedObjectFieldValue._id\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// 表单选人选组字段 至 对象 lookup master_detail类型字段同步\n\t\t\t\t\t\t\tif (['user', 'group'].includes(formField.type) && ['lookup', 'master_detail'].includes(relatedObjectField.type) && ['users', 'organizations'].includes(relatedObjectField.reference_to)) {\n\t\t\t\t\t\t\t\tif (!_.isEmpty(relatedObjectFieldValue)) {\n\t\t\t\t\t\t\t\t\tif (relatedObjectField.multiple && formField.is_multiselect) {\n\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = _.compact(_.pluck(relatedObjectFieldValue, 'id'))\n\t\t\t\t\t\t\t\t\t} else if (!relatedObjectField.multiple && !formField.is_multiselect) {\n\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = relatedObjectFieldValue.id\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\trelatedObjectValue[fieldKey] = relatedObjectFieldValue;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\trelatedObjectValue['_table'] = {\n\t\t\t\t\t_id: tableValueItem[\"_id\"],\n\t\t\t\t\t_code: tableCode\n\t\t\t\t};\n\t\t\t\trelatedObjectValues.push(relatedObjectValue);\n\t\t\t});\n\t\t\trelatedObjs[relatedObjectName] = relatedObjectValues;\n\t\t}\n\t})\n\n\tif (field_map_back_script) {\n\t\t_.extend(obj, InstanceRecordQueue.evalFieldMapBackScript(field_map_back_script, ins));\n\t}\n\t// 过滤掉非法的key\n\tvar filterObj = {};\n\n\t_.each(_.keys(obj), function (k) {\n\t\tif (objectFieldKeys.includes(k)) {\n\t\t\tfilterObj[k] = obj[k];\n\t\t}\n\t\t// else if(relatedObjectsKeys.includes(k) && _.isArray(obj[k])){\n\t\t// \tif(_.isArray(relatedObjs[k])){\n\t\t// \t\trelatedObjs[k] = relatedObjs[k].concat(obj[k])\n\t\t// \t}else{\n\t\t// \t\trelatedObjs[k] = obj[k]\n\t\t// \t}\n\t\t// }\n\t})\n\treturn {\n\t\tmainObjectValue: filterObj,\n\t\trelatedObjectsValue: relatedObjs\n\t};\n}\n\nInstanceRecordQueue.evalFieldMapBackScript = function (field_map_back_script, ins) {\n\tvar script = \"module.exports = function (instance) { \" + field_map_back_script + \" }\";\n\tvar func = _eval(script, \"field_map_script\");\n\tvar values = func(ins);\n\tif (_.isObject(values)) {\n\t\treturn values;\n\t} else {\n\t\tconsole.error(\"evalFieldMapBackScript: 脚本返回值类型不是对象\");\n\t}\n\treturn {}\n}\n\nInstanceRecordQueue.syncRelatedObjectsValue = function (mainRecordId, relatedObjects, relatedObjectsValue, spaceId, ins) {\n\tvar insId = ins._id;\n\n\t_.each(relatedObjects, function (relatedObject) {\n\t\tvar objectCollection = Creator.getCollection(relatedObject.object_name, spaceId);\n\t\tvar tableMap = {};\n\t\t_.each(relatedObjectsValue[relatedObject.object_name], function (relatedObjectValue) {\n\t\t\tvar table_id = relatedObjectValue._table._id;\n\t\t\tvar table_code = relatedObjectValue._table._code;\n\t\t\tif (!tableMap[table_code]) {\n\t\t\t\ttableMap[table_code] = []\n\t\t\t};\n\t\t\ttableMap[table_code].push(table_id);\n\t\t\tvar oldRelatedRecord = Creator.getCollection(relatedObject.object_name, spaceId).findOne({ [relatedObject.foreign_key]: mainRecordId, \"instances._id\": insId, _table: relatedObjectValue._table }, { fields: { _id: 1 } })\n\t\t\tif (oldRelatedRecord) {\n\t\t\t\tCreator.getCollection(relatedObject.object_name, spaceId).update({ _id: oldRelatedRecord._id }, { $set: relatedObjectValue })\n\t\t\t} else {\n\t\t\t\trelatedObjectValue[relatedObject.foreign_key] = mainRecordId;\n\t\t\t\trelatedObjectValue.space = spaceId;\n\t\t\t\trelatedObjectValue.owner = ins.applicant;\n\t\t\t\trelatedObjectValue.created_by = ins.applicant;\n\t\t\t\trelatedObjectValue.modified_by = ins.applicant;\n\t\t\t\trelatedObjectValue._id = objectCollection._makeNewID();\n\t\t\t\tvar instance_state = ins.state;\n\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\n\t\t\t\t\tinstance_state = ins.final_decision;\n\t\t\t\t}\n\t\t\t\trelatedObjectValue.instances = [{\n\t\t\t\t\t_id: insId,\n\t\t\t\t\tstate: instance_state\n\t\t\t\t}];\n\t\t\t\trelatedObjectValue.instance_state = instance_state;\n\t\t\t\tCreator.getCollection(relatedObject.object_name, spaceId).insert(relatedObjectValue, { validate: false, filter: false })\n\t\t\t}\n\t\t})\n\t\t//清理申请单上被删除子表记录对应的相关表记录\n\t\t_.each(tableMap, function (tableIds, tableCode) {\n\t\t\tobjectCollection.remove({\n\t\t\t\t[relatedObject.foreign_key]: mainRecordId,\n\t\t\t\t\"instances._id\": insId,\n\t\t\t\t\"_table._code\": tableCode,\n\t\t\t\t\"_table._id\": { $nin: tableIds }\n\t\t\t})\n\t\t})\n\t});\n\n\ttableIds = _.compact(tableIds);\n\n\n}\n\nInstanceRecordQueue.sendDoc = function (doc) {\n\tif (InstanceRecordQueue.debug) {\n\t\tconsole.log(\"sendDoc\");\n\t\tconsole.log(doc);\n\t}\n\n\tvar insId = doc.info.instance_id,\n\t\trecords = doc.info.records;\n\tvar fields = {\n\t\tflow: 1,\n\t\tvalues: 1,\n\t\tapplicant: 1,\n\t\tspace: 1,\n\t\tform: 1,\n\t\tform_version: 1,\n\t\ttraces: 1\n\t};\n\tInstanceRecordQueue.syncInsFields.forEach(function (f) {\n\t\tfields[f] = 1;\n\t})\n\tvar ins = Creator.getCollection('instances').findOne(insId, {\n\t\tfields: fields\n\t});\n\tvar values = ins.values,\n\t\tspaceId = ins.space;\n\n\tif (records && !_.isEmpty(records)) {\n\t\t// 此情况属于从creator中发起审批，或者已经从Apps同步到了creator\n\t\tvar objectName = records[0].o;\n\t\tvar ow = Creator.getCollection('object_workflows').findOne({\n\t\t\tobject_name: objectName,\n\t\t\tflow_id: ins.flow\n\t\t});\n\t\tvar\n\t\t\tobjectCollection = Creator.getCollection(objectName, spaceId),\n\t\t\tsync_attachment = ow.sync_attachment;\n\t\tvar objectInfo = Creator.getObject(objectName, spaceId);\n\t\tobjectCollection.find({\n\t\t\t_id: {\n\t\t\t\t$in: records[0].ids\n\t\t\t}\n\t\t}).forEach(function (record) {\n\t\t\ttry {\n\t\t\t\tvar syncValues = InstanceRecordQueue.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script, record)\n\t\t\t\tvar setObj = syncValues.mainObjectValue;\n\n\t\t\t\tvar instance_state = ins.state;\n\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\n\t\t\t\t\tinstance_state = ins.final_decision;\n\t\t\t\t}\n\t\t\t\tsetObj['instances.$.state'] = setObj.instance_state = instance_state;\n\n\t\t\t\tobjectCollection.update({\n\t\t\t\t\t_id: record._id,\n\t\t\t\t\t'instances._id': insId\n\t\t\t\t}, {\n\t\t\t\t\t$set: setObj\n\t\t\t\t})\n\n\t\t\t\tvar relatedObjects = Creator.getRelatedObjects(ow.object_name, spaceId);\n\t\t\t\tvar relatedObjectsValue = syncValues.relatedObjectsValue;\n\t\t\t\tInstanceRecordQueue.syncRelatedObjectsValue(record._id, relatedObjects, relatedObjectsValue, spaceId, ins);\n\n\n\t\t\t\t// 以最终申请单附件为准，旧的record中附件删除\n\t\t\t\tCreator.getCollection('cms_files').remove({\n\t\t\t\t\t'parent': {\n\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\tids: [record._id]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\tvar removeOldFiles = function (cb) {\n\t\t\t\t\treturn cfs.files.remove({\n\t\t\t\t\t\t'metadata.record_id': record._id\n\t\t\t\t\t}, cb);\n\t\t\t\t};\n\t\t\t\tMeteor.wrapAsync(removeOldFiles)();\n\t\t\t\t// 同步新附件\n\t\t\t\tInstanceRecordQueue.syncAttach(sync_attachment, insId, record.space, record._id, objectName);\n\n\t\t\t\t// 执行公式\n\t\t\t\trunQuoted(objectName, record._id);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(error.stack);\n\t\t\t\tobjectCollection.update({\n\t\t\t\t\t_id: record._id,\n\t\t\t\t\t'instances._id': insId\n\t\t\t\t}, {\n\t\t\t\t\t$set: {\n\t\t\t\t\t\t'instances.$.state': 'pending',\n\t\t\t\t\t\t'instance_state': 'pending'\n\t\t\t\t\t}\n\t\t\t\t})\n\n\t\t\t\tCreator.getCollection('cms_files').remove({\n\t\t\t\t\t'parent': {\n\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\tids: [record._id]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\tcfs.files.remove({\n\t\t\t\t\t'metadata.record_id': record._id\n\t\t\t\t})\n\n\t\t\t\tthrow new Error(error);\n\t\t\t}\n\n\t\t})\n\t} else {\n\t\t// 此情况属于从apps中发起审批\n\t\tCreator.getCollection('object_workflows').find({\n\t\t\tflow_id: ins.flow\n\t\t}).forEach(function (ow) {\n\t\t\ttry {\n\t\t\t\tvar\n\t\t\t\t\tobjectCollection = Creator.getCollection(ow.object_name, spaceId),\n\t\t\t\t\tsync_attachment = ow.sync_attachment,\n\t\t\t\t\tnewRecordId = objectCollection._makeNewID(),\n\t\t\t\t\tobjectName = ow.object_name;\n\n\t\t\t\tvar objectInfo = Creator.getObject(ow.object_name, spaceId);\n\t\t\t\tvar syncValues = InstanceRecordQueue.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script);\n\t\t\t\tvar newObj = syncValues.mainObjectValue;\n\n\t\t\t\tnewObj._id = newRecordId;\n\t\t\t\tnewObj.space = spaceId;\n\t\t\t\tnewObj.name = newObj.name || ins.name;\n\n\t\t\t\tvar instance_state = ins.state;\n\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\n\t\t\t\t\tinstance_state = ins.final_decision;\n\t\t\t\t}\n\t\t\t\tnewObj.instances = [{\n\t\t\t\t\t_id: insId,\n\t\t\t\t\tstate: instance_state\n\t\t\t\t}];\n\t\t\t\tnewObj.instance_state = instance_state;\n\n\t\t\t\tnewObj.owner = ins.applicant;\n\t\t\t\tnewObj.created_by = ins.applicant;\n\t\t\t\tnewObj.modified_by = ins.applicant;\n\t\t\t\tvar r = objectCollection.insert(newObj);\n\t\t\t\tif (r) {\n\t\t\t\t\tCreator.getCollection('instances').update(ins._id, {\n\t\t\t\t\t\t$push: {\n\t\t\t\t\t\t\trecord_ids: {\n\t\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tvar relatedObjects = Creator.getRelatedObjects(ow.object_name, spaceId);\n\t\t\t\t\tvar relatedObjectsValue = syncValues.relatedObjectsValue;\n\t\t\t\t\tInstanceRecordQueue.syncRelatedObjectsValue(newRecordId, relatedObjects, relatedObjectsValue, spaceId, ins);\n\t\t\t\t\t// workflow里发起审批后，同步时也可以修改相关表的字段值 #1183\n\t\t\t\t\tvar record = objectCollection.findOne(newRecordId);\n\t\t\t\t\tInstanceRecordQueue.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script, record);\n\t\t\t\t}\n\n\t\t\t\t// 附件同步\n\t\t\t\tInstanceRecordQueue.syncAttach(sync_attachment, insId, spaceId, newRecordId, objectName);\n\n\t\t\t\t// 执行公式\n\t\t\t\trunQuoted(objectName, newRecordId);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(error.stack);\n\n\t\t\t\tobjectCollection.remove({\n\t\t\t\t\t_id: newRecordId,\n\t\t\t\t\tspace: spaceId\n\t\t\t\t});\n\t\t\t\tCreator.getCollection('instances').update(ins._id, {\n\t\t\t\t\t$pull: {\n\t\t\t\t\t\trecord_ids: {\n\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\tCreator.getCollection('cms_files').remove({\n\t\t\t\t\t'parent': {\n\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\tcfs.files.remove({\n\t\t\t\t\t'metadata.record_id': newRecordId\n\t\t\t\t})\n\n\t\t\t\tthrow new Error(error);\n\t\t\t}\n\n\t\t})\n\t}\n\n\tif (doc._id) {\n\t\tInstanceRecordQueue.collection.update(doc._id, {\n\t\t\t$set: {\n\t\t\t\t'info.sync_date': new Date()\n\t\t\t}\n\t\t})\n\t}\n\n}","Meteor.startup ->\n\tif Meteor.settings.cron?.instancerecordqueue_interval\n\t\tInstanceRecordQueue.Configure\n\t\t\tsendInterval: Meteor.settings.cron.instancerecordqueue_interval\n\t\t\tsendBatchSize: 10\n\t\t\tkeepDocs: true\n","Meteor.startup(function() {\n  var ref;\n  if ((ref = Meteor.settings.cron) != null ? ref.instancerecordqueue_interval : void 0) {\n    return InstanceRecordQueue.Configure({\n      sendInterval: Meteor.settings.cron.instancerecordqueue_interval,\n      sendBatchSize: 10,\n      keepDocs: true\n    });\n  }\n});\n","import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\t\"eval\": \"^0.1.2\"\n}, 'steedos:instance-record-queue');\n"]}