{"version":3,"sources":["meteor://💻app/packages/steedos_workflow-chart/routes/chart.coffee","meteor://💻app/routes/chart.coffee"],"names":["FlowversionAPI","traceMaxApproveCount","traceSplitApprovesIndex","isExpandApprove","getAbsoluteUrl","url","rootUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","writeResponse","res","httpCode","body","statusCode","end","sendInvalidURLResponse","sendAuthTokenExpiredResponse","replaceErrorSymbol","str","replace","getStepHandlerName","step","approverNames","stepHandlerName","deal_type","approver_users","map","userId","user","db","users","findOne","name","join","approver_roles","roleId","role","flow_roles","getStepLabel","stepName","getStepName","cachedStepNames","cachedStepName","_id","generateStepsGraphSyntax","steps","currentStepId","isConvertToString","direction","graphSyntax","nodes","forEach","lines","length","line","toStep","toStepName","step_type","push","findPropertyByPK","to_step","getApproveJudgeText","judge","judgeText","locale","TAPi18n","__","getTraceName","traceName","approveHandlerName","getTraceFromApproveCountersWithType","trace","approves","counters","approve","from_approve_id","type","getTraceCountersWithType","traceFromApproveCounters","toApprove","toApproveFromId","toApproveHandlerName","toApproveType","handler_name","fromApprove","counter","counter2","counterContent","ref","from_type","from_approve_handler_name","to_approve_id","to_approve_handler_name","count","to_approve_handler_names","is_total","pushApprovesWithTypeGraphSyntax","currentTraceName","extraHandlerNamesCounter","fromApproveId","results","splitIndex","tempHandlerNames","toApproveId","toApproves","traceCounters","extraCount","isTypeNode","strToHandlerNames","toHandlerNames","typeName","indexOf","splice","_","isEmpty","results1","generateTracesGraphSyntax","traces","lastApproves","lastTrace","previous_trace_ids","currentFromTraceName","fromApproves","fromTrace","fromApproveHandlerName","fromTraceName","toTraceName","lastApprove","sendHtmlResponse","req","allowDirections","error_msg","flowversion","instance","instance_id","query","ref1","title","include","decodeURIComponent","instances","fields","flow_version","flow","$slice","WorkflowManager","getInstanceFlowVersion","JSON","stringify","JsonRoutes","add","next"],"mappings":"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","file":"/packages/steedos_workflow-chart.js","sourcesContent":["FlowversionAPI =\n\n\ttraceMaxApproveCount: 10\n\ttraceSplitApprovesIndex: 5\n\tisExpandApprove: false\n\n\tgetAbsoluteUrl: (url)->\n\t\trootUrl = if __meteor_runtime_config__ then __meteor_runtime_config__.ROOT_URL_PATH_PREFIX else \"\"\n\t\tif rootUrl\n\t\t\turl = rootUrl + url\n\t\treturn url;\n\n\twriteResponse: (res, httpCode, body)->\n\t\tres.statusCode = httpCode;\n\t\tres.end(body);\n\t\t\n\tsendInvalidURLResponse: (res)->\n\t\treturn @writeResponse(res, 404, \"url must has querys as instance_id.\");\n\t\t\n\tsendAuthTokenExpiredResponse: (res)->\n\t\treturn @writeResponse(res, 401, \"the auth_token has expired.\");\n\n\treplaceErrorSymbol: (str)->\n\t\treturn str.replace(/\\\"/g,\"&quot;\").replace(/\\n/g,\"<br/>\")\n\n\tgetStepHandlerName: (step)->\n\t\tswitch step.deal_type\n\t\t\twhen 'specifyUser'\n\t\t\t\tapproverNames = step.approver_users.map (userId)->\n\t\t\t\t\tuser = db.users.findOne(userId)\n\t\t\t\t\tif user\n\t\t\t\t\t\treturn user.name\n\t\t\t\t\telse\n\t\t\t\t\t\treturn \"\"\n\t\t\t\tstepHandlerName = approverNames.join(\",\")\n\t\t\twhen 'applicantRole'\n\t\t\t\tapproverNames = step.approver_roles.map (roleId)->\n\t\t\t\t\trole = db.flow_roles.findOne(roleId)\n\t\t\t\t\tif role\n\t\t\t\t\t\treturn role.name\n\t\t\t\t\telse\n\t\t\t\t\t\treturn \"\"\n\t\t\t\tstepHandlerName = approverNames.join(\",\")\n\t\t\telse\n\t\t\t\tstepHandlerName = ''\n\t\t\t\tbreak\n\t\treturn stepHandlerName\n\n\tgetStepLabel: (stepName, stepHandlerName)->\n\t\t# 返回sstepName与stepHandlerName结合的步骤显示名称\n\t\tif stepName\n\t\t\tstepName = \"<div class='graph-node'>\n\t\t\t\t<div class='step-name'>#{stepName}</div>\n\t\t\t\t<div class='step-handler-name'>#{stepHandlerName}</div>\n\t\t\t</div>\"\n\t\t\t# 把特殊字符清空或替换，以避免mermaidAPI出现异常\n\t\t\tstepName = FlowversionAPI.replaceErrorSymbol(stepName)\n\t\telse\n\t\t\tstepName = \"\"\n\t\treturn stepName\n\n\tgetStepName: (step, cachedStepNames)->\n\t\t# 返回step节点名称，优先从缓存cachedStepNames中取，否则调用getStepLabel生成\n\t\tcachedStepName = cachedStepNames[step._id]\n\t\tif cachedStepName\n\t\t\treturn cachedStepName\n\t\tstepHandlerName = FlowversionAPI.getStepHandlerName(step)\n\t\tstepName = FlowversionAPI.getStepLabel(step.name, stepHandlerName)\n\t\tcachedStepNames[step._id] = stepName\n\t\treturn stepName\n\n\tgenerateStepsGraphSyntax: (steps, currentStepId, isConvertToString, direction)->\n\t\tnodes = [\"graph #{direction}\"]\n\t\tcachedStepNames = {}\n\t\tsteps.forEach (step)->\n\t\t\tlines = step.lines\n\t\t\tif lines?.length\n\t\t\t\tlines.forEach (line)->\n\t\t\t\t\tif step.name\n\t\t\t\t\t\t# 标记条件节点\n\t\t\t\t\t\tif step.step_type == \"condition\"\n\t\t\t\t\t\t\tnodes.push \"\tclass #{step._id} condition;\"\n\t\t\t\t\t\tstepName = FlowversionAPI.getStepName(step, cachedStepNames)\n\t\t\t\t\telse\n\t\t\t\t\t\tstepName = \"\"\n\t\t\t\t\ttoStep = steps.findPropertyByPK(\"_id\",line.to_step)\n\t\t\t\t\ttoStepName = FlowversionAPI.getStepName(toStep, cachedStepNames)\n\t\t\t\t\tnodes.push \"\t#{step._id}(\\\"#{stepName}\\\")-->#{line.to_step}(\\\"#{toStepName}\\\")\"\n\n\t\tif currentStepId\n\t\t\tnodes.push \"\tclass #{currentStepId} current-step-node;\"\n\t\tif isConvertToString\n\t\t\tgraphSyntax = nodes.join \"\\n\"\n\t\t\treturn graphSyntax\n\t\telse\n\t\t\treturn nodes\n\n\tgetApproveJudgeText: (judge)->\n\t\tlocale = \"zh-CN\"\n\t\tswitch judge\n\t\t\twhen 'approved'\n\t\t\t\t# 已核准\n\t\t\t\tjudgeText = TAPi18n.__('Instance State approved', {}, locale)\n\t\t\twhen 'rejected'\n\t\t\t\t# 已驳回\n\t\t\t\tjudgeText = TAPi18n.__('Instance State rejected', {}, locale)\n\t\t\twhen 'terminated'\n\t\t\t\t# 已取消\n\t\t\t\tjudgeText = TAPi18n.__('Instance State terminated', {}, locale)\n\t\t\twhen 'reassigned'\n\t\t\t\t# 转签核\n\t\t\t\tjudgeText = TAPi18n.__('Instance State reassigned', {}, locale)\n\t\t\twhen 'relocated'\n\t\t\t\t# 重定位\n\t\t\t\tjudgeText = TAPi18n.__('Instance State relocated', {}, locale)\n\t\t\twhen 'retrieved'\n\t\t\t\t# 已取回\n\t\t\t\tjudgeText = TAPi18n.__('Instance State retrieved', {}, locale)\n\t\t\twhen 'returned'\n\t\t\t\t# 已退回\n\t\t\t\tjudgeText = TAPi18n.__('Instance State returned', {}, locale)\n\t\t\twhen 'readed'\n\t\t\t\t# 已阅\n\t\t\t\tjudgeText = TAPi18n.__('Instance State readed', {}, locale)\n\t\t\telse\n\t\t\t\tjudgeText = ''\n\t\t\t\tbreak\n\t\treturn judgeText\n\n\tgetTraceName: (traceName, approveHandlerName)->\n\t\t# 返回trace节点名称\n\t\tif traceName\n\t\t\t# 把特殊字符清空或替换，以避免mermaidAPI出现异常\n\t\t\ttraceName = \"<div class='graph-node'>\n\t\t\t\t<div class='trace-name'>#{traceName}</div>\n\t\t\t\t<div class='trace-handler-name'>#{approveHandlerName}</div>\n\t\t\t</div>\"\n\t\t\ttraceName = FlowversionAPI.replaceErrorSymbol(traceName)\n\t\telse\n\t\t\ttraceName = \"\"\n\t\treturn traceName\n\t\n\tgetTraceFromApproveCountersWithType: (trace)->\n\t\t# 该函数生成json结构，表现出所有传阅、分发、转发节点有有后续子节点的计数情况，其结构为：\n\t\t# counters = {\n\t\t# \t[fromApproveId(来源节点ID)]:{\n\t\t# \t\t[toApproveType(目标结点类型)]:目标节点在指定类型下的后续节点个数\n\t\t# \t}\n\t\t# }\n\t\tcounters = {}\n\t\tapproves = trace.approves\n\t\tunless approves\n\t\t\treturn null\n\t\tapproves.forEach (approve)->\n\t\t\tif approve.from_approve_id\n\t\t\t\tunless counters[approve.from_approve_id]\n\t\t\t\t\tcounters[approve.from_approve_id] = {}\n\t\t\t\tif counters[approve.from_approve_id][approve.type]\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type]++\n\t\t\t\telse\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type] = 1\n\t\treturn counters\n\n\tgetTraceCountersWithType: (trace, traceFromApproveCounters)->\n\t\t# 该函数生成json结构，表现出所有传阅、分发、转发的节点流向，其结构为：\n\t\t# counters = {\n\t\t# \t[fromApproveId(来源节点ID)]:{\n\t\t# \t\t[toApproveType(目标结点类型)]:[{\n\t\t# \t\t\tfrom_type: 来源节点类型\n\t\t# \t\t\tfrom_approve_handler_name: 来源节点处理人\n\t\t# \t\t\tto_approve_id: 目标节点ID\n\t\t# \t\t\tto_approve_handler_names: [多个目标节点汇总处理人集合]\n\t\t# \t\t\tis_total: true/false，是否汇总节点\n\t\t# \t\t},...]\n\t\t# \t}\n\t\t# }\n\t\t# 上述目标结点内容中有一个属性is_total表示是否汇总节点，如果是，则把多个节点汇总合并成一个，\n\t\t# 但是本身有后续子节点的节点不参与汇总及计数。\n\t\tcounters = {}\n\t\tapproves = trace.approves\n\t\tunless approves\n\t\t\treturn null\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\n\t\tisExpandApprove = FlowversionAPI.isExpandApprove\n\n\t\tapproves.forEach (toApprove)->\n\t\t\ttoApproveType = toApprove.type\n\t\t\ttoApproveFromId = toApprove.from_approve_id\n\t\t\ttoApproveHandlerName = toApprove.handler_name\n\t\t\tunless toApproveFromId\n\t\t\t\treturn\n\t\t\tapproves.forEach (fromApprove)->\n\t\t\t\tif fromApprove._id == toApproveFromId\n\t\t\t\t\tcounter = counters[toApproveFromId]\n\t\t\t\t\tunless counter\n\t\t\t\t\t\tcounter = counters[toApproveFromId] = {}\n\t\t\t\t\tunless counter[toApprove.type]\n\t\t\t\t\t\tcounter[toApprove.type] = []\n\t\t\t\t\tcounter2 = counter[toApprove.type]\n\t\t\t\t\tif traceFromApproveCounters[toApprove._id]?[toApproveType]\n\t\t\t\t\t\t# 有后续子节点，则不参与汇总及计数\n\t\t\t\t\t\tcounter2.push\n\t\t\t\t\t\t\tfrom_type: fromApprove.type\n\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\n\t\t\t\t\t\t\tto_approve_id: toApprove._id\n\t\t\t\t\t\t\tto_approve_handler_name: toApprove.handler_name\n\n\t\t\t\t\telse\n\t\t\t\t\t\tcounterContent = if isExpandApprove then null else counter2.findPropertyByPK(\"is_total\", true)\n\t\t\t\t\t\t# counterContent = counter2.findPropertyByPK(\"is_total\", true)\n\t\t\t\t\t\t# 如果强制要求展开所有节点，则不做汇总处理\n\t\t\t\t\t\tif counterContent\n\t\t\t\t\t\t\tcounterContent.count++\n\t\t\t\t\t\t\tunless counterContent.count > traceMaxApproveCount\n\t\t\t\t\t\t\t\tcounterContent.to_approve_handler_names.push toApprove.handler_name\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tcounter2.push\n\t\t\t\t\t\t\t\tfrom_type: fromApprove.type\n\t\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\n\t\t\t\t\t\t\t\tto_approve_id: toApprove._id\n\t\t\t\t\t\t\t\tcount: 1\n\t\t\t\t\t\t\t\tto_approve_handler_names: [toApprove.handler_name]\n\t\t\t\t\t\t\t\tis_total: true\n\n\t\treturn counters\n\n\tpushApprovesWithTypeGraphSyntax: (nodes, trace)->\n\t\ttraceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType trace\n\t\ttraceCounters = FlowversionAPI.getTraceCountersWithType trace, traceFromApproveCounters\n\t\tunless traceCounters\n\t\t\treturn\n\t\textraHandlerNamesCounter = {} #记录需要额外生成所有处理人姓名的被传阅、分发、转发节点\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\n\t\tsplitIndex = FlowversionAPI.traceSplitApprovesIndex\n\t\tcurrentTraceName = trace.name\n\t\tfor fromApproveId,fromApprove of traceCounters\n\t\t\tfor toApproveType,toApproves of fromApprove\n\t\t\t\ttoApproves.forEach (toApprove)->\n\t\t\t\t\ttypeName = \"\"\n\t\t\t\t\tswitch toApproveType\n\t\t\t\t\t\twhen 'cc'\n\t\t\t\t\t\t\ttypeName = \"传阅\"\n\t\t\t\t\t\twhen 'forward'\n\t\t\t\t\t\t\ttypeName = \"转发\"\n\t\t\t\t\t\twhen 'distribute'\n\t\t\t\t\t\t\ttypeName = \"分发\"\n\t\t\t\t\tisTypeNode = [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.from_type) >= 0\n\t\t\t\t\tif isTypeNode\n\t\t\t\t\t\ttraceName = toApprove.from_approve_handler_name\n\t\t\t\t\telse\n\t\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.from_approve_handler_name\n\t\t\t\t\tif toApprove.is_total\n\t\t\t\t\t\ttoHandlerNames = toApprove.to_approve_handler_names\n\t\t\t\t\t\tif splitIndex and toApprove.count > splitIndex\n\t\t\t\t\t\t\t# 在姓名集合中插入回车符号换行\n\t\t\t\t\t\t\ttoHandlerNames.splice(splitIndex,0,\"<br/>,\")\n\t\t\t\t\t\tstrToHandlerNames = toHandlerNames.join(\",\").replace(\",,\",\"\")\n\t\t\t\t\t\textraCount = toApprove.count - traceMaxApproveCount\n\t\t\t\t\t\tif extraCount > 0\n\t\t\t\t\t\t\tstrToHandlerNames += \"等#{toApprove.count}人\"\n\t\t\t\t\t\t\tunless extraHandlerNamesCounter[fromApproveId]\n\t\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId] = {}\n\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id\n\t\t\t\t\telse\n\t\t\t\t\t\tstrToHandlerNames = toApprove.to_approve_handler_name\n\t\t\t\t\tif isTypeNode\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}>\\\"#{traceName}\\\"]--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\n\t\t\t\t\telse\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}(\\\"#{traceName}\\\")--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\n\n\t\t# 为需要额外生成所有处理人姓名的被传阅、分发、转发节点，增加鼠标弹出详细层事件\n\t\t# extraHandlerNamesCounter的结构为：\n\t\t# counters = {\n\t\t# \t[fromApproveId(来源节点ID)]:{\n\t\t# \t\t[toApproveType(目标结点类型)]:目标结点ID\n\t\t# \t}\n\t\t# }\n\t\tapproves = trace.approves\n\t\tunless _.isEmpty(extraHandlerNamesCounter)\n\t\t\tfor fromApproveId,fromApprove of extraHandlerNamesCounter\n\t\t\t\tfor toApproveType,toApproveId of fromApprove\n\t\t\t\t\ttempHandlerNames = []\n\t\t\t\t\tapproves.forEach (approve)->\n\t\t\t\t\t\tif fromApproveId == approve.from_approve_id\n\t\t\t\t\t\t\tunless traceFromApproveCounters[approve._id]?[toApproveType]\n\t\t\t\t\t\t\t\t# 有后续子节点，则不参与汇总及计数\n\t\t\t\t\t\t\t\ttempHandlerNames.push approve.handler_name\n\t\t\t\t\tnodes.push \"\tclick #{toApproveId} callback \\\"#{tempHandlerNames.join(\",\")}\\\"\"\n\n\tgenerateTracesGraphSyntax: (traces, isConvertToString, direction)->\n\t\tnodes = [\"graph #{direction}\"]\n\t\tlastTrace = null\n\t\tlastApproves = []\n\t\ttraces.forEach (trace)->\n\t\t\tlines = trace.previous_trace_ids\n\t\t\tcurrentTraceName = trace.name\n\t\t\tif lines?.length\n\t\t\t\tlines.forEach (line)->\n\t\t\t\t\tfromTrace = traces.findPropertyByPK(\"_id\",line)\n\t\t\t\t\tcurrentFromTraceName = fromTrace.name\n\t\t\t\t\tfromApproves = fromTrace.approves\n\t\t\t\t\ttoApproves = trace.approves\n\t\t\t\t\tlastTrace = trace\n\t\t\t\t\tlastApproves = toApproves\n\t\t\t\t\tfromApproves.forEach (fromApprove)->\n\t\t\t\t\t\tfromApproveHandlerName = fromApprove.handler_name\n\t\t\t\t\t\tif toApproves?.length\n\t\t\t\t\t\t\ttoApproves.forEach (toApprove)->\n\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.type) < 0\n\t\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\n\t\t\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\n\t\t\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.handler_name\n\t\t\t\t\t\t\t\t\t\t# 不是传阅、分发、转发，则连接到下一个trace\n\t\t\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\n\t\t\t\t\t\t\t\t\t\tif judgeText\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t# 最后一个步骤的trace\n\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\n\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\n\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName)\n\t\t\t\t\t\t\t\t# 不是传阅、分发、转发，则连接到下一个trace\n\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\n\t\t\t\t\t\t\t\tif judgeText\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{trace._id}(\\\"#{toTraceName}\\\")\"\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{trace._id}(\\\"#{toTraceName}\\\")\"\n\t\t\telse\n\t\t\t\t# 第一个trace，因traces可能只有一个，这时需要单独显示出来\n\t\t\t\ttrace.approves.forEach (approve)->\n\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, approve.handler_name\n\t\t\t\t\tnodes.push \"\t#{approve._id}(\\\"#{traceName}\\\")\"\n\n\t\t\tFlowversionAPI.pushApprovesWithTypeGraphSyntax nodes, trace\n\n\t\t# 签批历程中最后的approves高亮显示，结束步骤的trace中是没有approves的，所以结束步骤不高亮显示\n\t\tlastApproves?.forEach (lastApprove)->\n\t\t\tnodes.push \"\tclass #{lastApprove._id} current-step-node;\"\n\n\t\tif isConvertToString\n\t\t\tgraphSyntax = nodes.join \"\\n\"\n\t\t\treturn graphSyntax\n\t\telse\n\t\t\treturn nodes\n\n\tsendHtmlResponse: (req, res, type)->\n\t\tquery = req.query\n\t\tinstance_id = query.instance_id\n\t\tdirection = query.direction || 'TD'\n\t\tallowDirections = ['TB','BT','RL','LR','TD'];\n\n\t\tif !_.include(allowDirections, direction)\n\t\t\treturn @writeResponse(res, 500, \"Invalid direction. The value of direction should be in ['TB', 'BT', 'RL', 'LR', 'TD']\");\n\n\t\tunless instance_id\n\t\t\tFlowversionAPI.sendInvalidURLResponse res \n\t\t\n\t\ttitle = query.title\n\t\tif title\n\t\t\ttitle = decodeURIComponent(decodeURIComponent(title))\n\t\telse\n\t\t\ttitle = \"Workflow Chart\"\n\n\t\terror_msg = \"\"\n\t\tgraphSyntax = \"\"\n\t\tFlowversionAPI.isExpandApprove = false\n\t\tif type == \"traces_expand\"\n\t\t\ttype = \"traces\"\n\t\t\tFlowversionAPI.isExpandApprove = true\n\t\tswitch type\n\t\t\twhen 'traces'\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{traces: 1}}\n\t\t\t\tif instance\n\t\t\t\t\ttraces = instance.traces\n\t\t\t\t\tif traces?.length\n\t\t\t\t\t\tgraphSyntax = this.generateTracesGraphSyntax traces, false, direction\n\t\t\t\t\telse\n\t\t\t\t\t\terror_msg = \"没有找到当前申请单的流程步骤数据\"\n\t\t\t\telse\n\t\t\t\t\terror_msg = \"当前申请单不存在或已被删除\"\n\t\t\telse\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{flow_version:1,flow:1,traces: {$slice: -1}}}\n\t\t\t\tif instance\n\t\t\t\t\tcurrentStepId = instance.traces?[0]?.step\n\t\t\t\t\tflowversion = WorkflowManager.getInstanceFlowVersion(instance)\n\t\t\t\t\tsteps = flowversion?.steps\n\t\t\t\t\tif steps?.length\n\t\t\t\t\t\tgraphSyntax = this.generateStepsGraphSyntax steps,currentStepId,false, direction\n\t\t\t\t\telse\n\t\t\t\t\t\terror_msg = \"没有找到当前申请单的流程步骤数据\"\n\t\t\t\telse\n\t\t\t\t\terror_msg = \"当前申请单不存在或已被删除\"\n\t\t\t\tbreak\n\n\t\treturn @writeResponse res, 200, \"\"\"\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t\t<meta charset=\"utf-8\">\n\t\t\t\t\t<meta name=\"viewport\" content=\"width=device-width,initial-scale=1,user-scalable=yes\">\n\t\t\t\t\t<title>#{title}</title>\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"192x192\" href=\"/favicons/android-chrome-192x192.png\">\n\t\t\t\t\t<link rel=\"manifest\" href=\"/favicons/manifest.json\">\n\t\t\t\t\t<meta name=\"mobile-web-app-capable\" content=\"yes\">\n\t\t\t\t\t<meta name=\"theme-color\" content=\"#000\">\n\t\t\t\t\t<meta name=\"application-name\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"57x57\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-57x57.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"60x60\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-60x60.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"72x72\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-72x72.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"76x76\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-76x76.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"114x114\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-114x114.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"120x120\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-120x120.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"144x144\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-144x144.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"152x152\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-152x152.png\")}\">\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-180x180.png\")}\">\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-title\">\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"228x228\" href=\"#{@getAbsoluteUrl(\"/favicons/coast-228x228.png\")}\">\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"16x16\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-16x16.png\")}\">\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-32x32.png\")}\">\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"96x96\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-96x96.png\")}\">\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"230x230\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-230x230.png\")}\">\n\t\t\t\t\t<link rel=\"shortcut icon\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon.ico\")}\">\n\t\t\t\t\t<link rel=\"yandex-tableau-widget\" href=\"#{@getAbsoluteUrl(\"/favicons/yandex-browser-manifest.json\")}\">\n\t\t\t\t\t<meta name=\"msapplication-TileColor\" content=\"#fff\">\n\t\t\t\t\t<meta name=\"msapplication-TileImage\" content=\"#{@getAbsoluteUrl(\"/favicons/mstile-144x144.png\")}\">\n\t\t\t\t\t<meta name=\"msapplication-config\" content=\"#{@getAbsoluteUrl(\"/favicons/browserconfig.xml\")}\">\n\t\t\t\t\t<meta property=\"twitter:image\" content=\"#{@getAbsoluteUrl(\"/favicons/twitter.png\")}\">\n\t\t\t\t\t<meta property=\"og:image\" content=\"#{@getAbsoluteUrl(\"/favicons/open-graph.png\")}\">\n\t\t\t\t\t<link rel=\"stylesheet\" href=\"#{@getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.css\")}\"/>\n\t\t\t\t\t<script type=\"text/javascript\" src=\"#{@getAbsoluteUrl(\"/lib/jquery/jquery-1.11.2.min.js\")}\"></script>\n\t\t\t\t\t<script type=\"text/javascript\" src=\"#{@getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.min.js\")}\"></script>\n\t\t\t\t\t<style>\n\t\t\t\t\t\tbody { \n\t\t\t\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tbackground-color: #fff;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.loading{\n\t\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\t\tleft: 0px;\n\t\t\t\t\t\t\tright: 0px;\n\t\t\t\t\t\t\ttop: 50%;\n\t\t\t\t\t\t\tz-index: 1100;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tmargin-top: -30px;\n\t\t\t\t\t\t\tfont-size: 36px;\n\t\t\t\t\t\t\tcolor: #dfdfdf;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.error-msg{\n\t\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\t\tleft: 0px;\n\t\t\t\t\t\t\tright: 0px;\n\t\t\t\t\t\t\tbottom: 20px;\n\t\t\t\t\t\t\tz-index: 1100;\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t\tfont-size: 20px;\n\t\t\t\t\t\t\tcolor: #a94442;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node rect{\n\t\t\t\t\t\t\tfill: #ccccff;\n\t\t\t\t\t\t\tstroke: rgb(144, 144, 255);\n    \t\t\t\t\t\tstroke-width: 2px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node.current-step-node rect{\n\t\t\t\t\t\t\tfill: #cde498;\n\t\t\t\t\t\t\tstroke: #13540c;\n\t\t\t\t\t\t\tstroke-width: 2px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node.condition rect{\n\t\t\t\t\t\t\tfill: #ececff;\n\t\t\t\t\t\t\tstroke: rgb(204, 204, 255);\n    \t\t\t\t\t\tstroke-width: 1px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node .trace-handler-name{\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#flow-steps-svg .node .step-handler-name{\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdiv.mermaidTooltip{\n\t\t\t\t\t\t\tposition: fixed!important;\n\t\t\t\t\t\t\ttext-align: left!important;\n\t\t\t\t\t\t\tpadding: 4px!important;\n\t\t\t\t\t\t\tfont-size: 14px!important;\n\t\t\t\t\t\t\tmax-width: 500px!important;\n\t\t\t\t\t\t\tleft: auto!important;\n\t\t\t\t\t\t\ttop: 15px!important;\n\t\t\t\t\t\t\tright: 15px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom{\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\n\t\t\t\t\t\t\tborder-color: transparent;\n\t\t\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\t\t\tpadding: 2px 10px;\n\t\t\t\t\t\t\tfont-size: 26px;\n\t\t\t\t\t\t\tborder-radius: 20px;\n\t\t\t\t\t\t\tbackground: #eee;\n\t\t\t\t\t\t\tcolor: #777;\n\t\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\t\tbottom: 15px;\n\t\t\t\t\t\t\toutline: none;\n\t\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t\t\tz-index: 99999;\n\t\t\t\t\t\t\t-webkit-user-select: none;\n\t\t\t\t\t\t\t-moz-user-select: none;\n\t\t\t\t\t\t\t-ms-user-select: none;\n\t\t\t\t\t\t\tuser-select: none;\n\t\t\t\t\t\t\tline-height: 1.2;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t@media (max-width: 768px) {\n\t\t\t\t\t\t\t.btn-zoom{\n\t\t\t\t\t\t\t\tdisplay:none;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom:hover{\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom-up{\n\t\t\t\t\t\t\tleft: 15px;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t.btn-zoom-down{\n\t\t\t\t\t\t\tleft: 60px;\n\t\t\t\t\t\t\tpadding: 1px 13px 3px 13px;\n\t\t\t\t\t\t}\n\t\t\t\t\t</style>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t\t<div class = \"loading\">Loading...</div>\n\t\t\t\t\t<div class = \"error-msg\">#{error_msg}</div>\n\t\t\t\t\t<div class=\"mermaid\"></div>\n\t\t\t\t\t<script type=\"text/javascript\">\n\t\t\t\t\t\tmermaid.initialize({\n\t\t\t\t\t\t\tstartOnLoad:false\n\t\t\t\t\t\t});\n\t\t\t\t\t\t$(function(){\n\t\t\t\t\t\t\tvar graphNodes = #{JSON.stringify(graphSyntax)};\n\t\t\t\t\t\t\t//方便前面可以通过调用mermaid.currentNodes调式，特意增加currentNodes属性。\n\t\t\t\t\t\t\tmermaid.currentNodes = graphNodes;\n\t\t\t\t\t\t\tvar graphSyntax = graphNodes.join(\"\\\\n\");\n\t\t\t\t\t\t\tconsole.log(graphNodes);\n\t\t\t\t\t\t\tconsole.log(graphSyntax);\n\t\t\t\t\t\t\tconsole.log(\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\");\n\t\t\t\t\t\t\t$(\".loading\").remove();\n\n\t\t\t\t\t\t\tvar id = \"flow-steps-svg\";\n\t\t\t\t\t\t\tvar element = $('.mermaid');\n\t\t\t\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\n\t\t\t\t\t\t\t\telement.html(svgCode);\n\t\t\t\t\t\t\t\tif(typeof callback !== 'undefined'){\n\t\t\t\t\t\t\t\t\tcallback(id);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbindFunctions(element[0]);\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\n\n\t\t\t\t\t\t\tvar zoomSVG = function(zoom){\n\t\t\t\t\t\t\t\tvar currentWidth = $(\"svg\").width();\n\t\t\t\t\t\t\t\tvar newWidth = currentWidth * zoom;\n\t\t\t\t\t\t\t\t$(\"svg\").css(\"maxWidth\",newWidth + \"px\").width(newWidth);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t//支持鼠标滚轮缩放画布\n\t\t\t\t\t\t\t$(window).on(\"mousewheel\",function(event){\n\t\t\t\t\t\t\t\tif(event.ctrlKey){\n\t\t\t\t\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\n\t\t\t\t\t\t\t\t\tzoomSVG(zoom);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t$(\".btn-zoom\").on(\"click\",function(){\n\t\t\t\t\t\t\t\tzoomSVG($(this).attr(\"zoom\"));\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t</script>\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-up\" zoom=1.1 title=\"点击放大\">+</a>\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-down\" zoom=0.9 title=\"点击缩小\">-</a>\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t\"\"\"\n\nJsonRoutes.add 'get', '/api/workflow/chart?instance_id=:instance_id', (req, res, next) ->\n\t# 流程图\n\tFlowversionAPI.sendHtmlResponse req, res\n\nJsonRoutes.add 'get', '/api/workflow/chart/traces?instance_id=:instance_id', (req, res, next) ->\n\t# 汇总签批历程图\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces\"\n\nJsonRoutes.add 'get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', (req, res, next) ->\n\t# 展开所有节点的签批历程图\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces_expand\"\n\n","var FlowversionAPI;\n\nFlowversionAPI = {\n  traceMaxApproveCount: 10,\n  traceSplitApprovesIndex: 5,\n  isExpandApprove: false,\n  getAbsoluteUrl: function(url) {\n    var rootUrl;\n    rootUrl = __meteor_runtime_config__ ? __meteor_runtime_config__.ROOT_URL_PATH_PREFIX : \"\";\n    if (rootUrl) {\n      url = rootUrl + url;\n    }\n    return url;\n  },\n  writeResponse: function(res, httpCode, body) {\n    res.statusCode = httpCode;\n    return res.end(body);\n  },\n  sendInvalidURLResponse: function(res) {\n    return this.writeResponse(res, 404, \"url must has querys as instance_id.\");\n  },\n  sendAuthTokenExpiredResponse: function(res) {\n    return this.writeResponse(res, 401, \"the auth_token has expired.\");\n  },\n  replaceErrorSymbol: function(str) {\n    return str.replace(/\\\"/g, \"&quot;\").replace(/\\n/g, \"<br/>\");\n  },\n  getStepHandlerName: function(step) {\n    var approverNames, stepHandlerName;\n    switch (step.deal_type) {\n      case 'specifyUser':\n        approverNames = step.approver_users.map(function(userId) {\n          var user;\n          user = db.users.findOne(userId);\n          if (user) {\n            return user.name;\n          } else {\n            return \"\";\n          }\n        });\n        stepHandlerName = approverNames.join(\",\");\n        break;\n      case 'applicantRole':\n        approverNames = step.approver_roles.map(function(roleId) {\n          var role;\n          role = db.flow_roles.findOne(roleId);\n          if (role) {\n            return role.name;\n          } else {\n            return \"\";\n          }\n        });\n        stepHandlerName = approverNames.join(\",\");\n        break;\n      default:\n        stepHandlerName = '';\n        break;\n    }\n    return stepHandlerName;\n  },\n  getStepLabel: function(stepName, stepHandlerName) {\n    if (stepName) {\n      stepName = \"<div class='graph-node'> <div class='step-name'>\" + stepName + \"</div> <div class='step-handler-name'>\" + stepHandlerName + \"</div> </div>\";\n      stepName = FlowversionAPI.replaceErrorSymbol(stepName);\n    } else {\n      stepName = \"\";\n    }\n    return stepName;\n  },\n  getStepName: function(step, cachedStepNames) {\n    var cachedStepName, stepHandlerName, stepName;\n    cachedStepName = cachedStepNames[step._id];\n    if (cachedStepName) {\n      return cachedStepName;\n    }\n    stepHandlerName = FlowversionAPI.getStepHandlerName(step);\n    stepName = FlowversionAPI.getStepLabel(step.name, stepHandlerName);\n    cachedStepNames[step._id] = stepName;\n    return stepName;\n  },\n  generateStepsGraphSyntax: function(steps, currentStepId, isConvertToString, direction) {\n    var cachedStepNames, graphSyntax, nodes;\n    nodes = [\"graph \" + direction];\n    cachedStepNames = {};\n    steps.forEach(function(step) {\n      var lines;\n      lines = step.lines;\n      if (lines != null ? lines.length : void 0) {\n        return lines.forEach(function(line) {\n          var stepName, toStep, toStepName;\n          if (step.name) {\n            if (step.step_type === \"condition\") {\n              nodes.push(\"\tclass \" + step._id + \" condition;\");\n            }\n            stepName = FlowversionAPI.getStepName(step, cachedStepNames);\n          } else {\n            stepName = \"\";\n          }\n          toStep = steps.findPropertyByPK(\"_id\", line.to_step);\n          toStepName = FlowversionAPI.getStepName(toStep, cachedStepNames);\n          return nodes.push(\"\t\" + step._id + \"(\\\"\" + stepName + \"\\\")-->\" + line.to_step + \"(\\\"\" + toStepName + \"\\\")\");\n        });\n      }\n    });\n    if (currentStepId) {\n      nodes.push(\"\tclass \" + currentStepId + \" current-step-node;\");\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  getApproveJudgeText: function(judge) {\n    var judgeText, locale;\n    locale = \"zh-CN\";\n    switch (judge) {\n      case 'approved':\n        judgeText = TAPi18n.__('Instance State approved', {}, locale);\n        break;\n      case 'rejected':\n        judgeText = TAPi18n.__('Instance State rejected', {}, locale);\n        break;\n      case 'terminated':\n        judgeText = TAPi18n.__('Instance State terminated', {}, locale);\n        break;\n      case 'reassigned':\n        judgeText = TAPi18n.__('Instance State reassigned', {}, locale);\n        break;\n      case 'relocated':\n        judgeText = TAPi18n.__('Instance State relocated', {}, locale);\n        break;\n      case 'retrieved':\n        judgeText = TAPi18n.__('Instance State retrieved', {}, locale);\n        break;\n      case 'returned':\n        judgeText = TAPi18n.__('Instance State returned', {}, locale);\n        break;\n      case 'readed':\n        judgeText = TAPi18n.__('Instance State readed', {}, locale);\n        break;\n      default:\n        judgeText = '';\n        break;\n    }\n    return judgeText;\n  },\n  getTraceName: function(traceName, approveHandlerName) {\n    if (traceName) {\n      traceName = \"<div class='graph-node'> <div class='trace-name'>\" + traceName + \"</div> <div class='trace-handler-name'>\" + approveHandlerName + \"</div> </div>\";\n      traceName = FlowversionAPI.replaceErrorSymbol(traceName);\n    } else {\n      traceName = \"\";\n    }\n    return traceName;\n  },\n  getTraceFromApproveCountersWithType: function(trace) {\n    var approves, counters;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    approves.forEach(function(approve) {\n      if (approve.from_approve_id) {\n        if (!counters[approve.from_approve_id]) {\n          counters[approve.from_approve_id] = {};\n        }\n        if (counters[approve.from_approve_id][approve.type]) {\n          return counters[approve.from_approve_id][approve.type]++;\n        } else {\n          return counters[approve.from_approve_id][approve.type] = 1;\n        }\n      }\n    });\n    return counters;\n  },\n  getTraceCountersWithType: function(trace, traceFromApproveCounters) {\n    var approves, counters, isExpandApprove, traceMaxApproveCount;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    isExpandApprove = FlowversionAPI.isExpandApprove;\n    approves.forEach(function(toApprove) {\n      var toApproveFromId, toApproveHandlerName, toApproveType;\n      toApproveType = toApprove.type;\n      toApproveFromId = toApprove.from_approve_id;\n      toApproveHandlerName = toApprove.handler_name;\n      if (!toApproveFromId) {\n        return;\n      }\n      return approves.forEach(function(fromApprove) {\n        var counter, counter2, counterContent, ref;\n        if (fromApprove._id === toApproveFromId) {\n          counter = counters[toApproveFromId];\n          if (!counter) {\n            counter = counters[toApproveFromId] = {};\n          }\n          if (!counter[toApprove.type]) {\n            counter[toApprove.type] = [];\n          }\n          counter2 = counter[toApprove.type];\n          if ((ref = traceFromApproveCounters[toApprove._id]) != null ? ref[toApproveType] : void 0) {\n            return counter2.push({\n              from_type: fromApprove.type,\n              from_approve_handler_name: fromApprove.handler_name,\n              to_approve_id: toApprove._id,\n              to_approve_handler_name: toApprove.handler_name\n            });\n          } else {\n            counterContent = isExpandApprove ? null : counter2.findPropertyByPK(\"is_total\", true);\n            if (counterContent) {\n              counterContent.count++;\n              if (!(counterContent.count > traceMaxApproveCount)) {\n                return counterContent.to_approve_handler_names.push(toApprove.handler_name);\n              }\n            } else {\n              return counter2.push({\n                from_type: fromApprove.type,\n                from_approve_handler_name: fromApprove.handler_name,\n                to_approve_id: toApprove._id,\n                count: 1,\n                to_approve_handler_names: [toApprove.handler_name],\n                is_total: true\n              });\n            }\n          }\n        }\n      });\n    });\n    return counters;\n  },\n  pushApprovesWithTypeGraphSyntax: function(nodes, trace) {\n    var approves, currentTraceName, extraHandlerNamesCounter, fromApprove, fromApproveId, results, splitIndex, tempHandlerNames, toApproveId, toApproveType, toApproves, traceCounters, traceFromApproveCounters, traceMaxApproveCount;\n    traceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType(trace);\n    traceCounters = FlowversionAPI.getTraceCountersWithType(trace, traceFromApproveCounters);\n    if (!traceCounters) {\n      return;\n    }\n    extraHandlerNamesCounter = {};\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    splitIndex = FlowversionAPI.traceSplitApprovesIndex;\n    currentTraceName = trace.name;\n    for (fromApproveId in traceCounters) {\n      fromApprove = traceCounters[fromApproveId];\n      for (toApproveType in fromApprove) {\n        toApproves = fromApprove[toApproveType];\n        toApproves.forEach(function(toApprove) {\n          var extraCount, isTypeNode, strToHandlerNames, toHandlerNames, traceName, typeName;\n          typeName = \"\";\n          switch (toApproveType) {\n            case 'cc':\n              typeName = \"传阅\";\n              break;\n            case 'forward':\n              typeName = \"转发\";\n              break;\n            case 'distribute':\n              typeName = \"分发\";\n          }\n          isTypeNode = [\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.from_type) >= 0;\n          if (isTypeNode) {\n            traceName = toApprove.from_approve_handler_name;\n          } else {\n            traceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.from_approve_handler_name);\n          }\n          if (toApprove.is_total) {\n            toHandlerNames = toApprove.to_approve_handler_names;\n            if (splitIndex && toApprove.count > splitIndex) {\n              toHandlerNames.splice(splitIndex, 0, \"<br/>,\");\n            }\n            strToHandlerNames = toHandlerNames.join(\",\").replace(\",,\", \"\");\n            extraCount = toApprove.count - traceMaxApproveCount;\n            if (extraCount > 0) {\n              strToHandlerNames += \"等\" + toApprove.count + \"人\";\n              if (!extraHandlerNamesCounter[fromApproveId]) {\n                extraHandlerNamesCounter[fromApproveId] = {};\n              }\n              extraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id;\n            }\n          } else {\n            strToHandlerNames = toApprove.to_approve_handler_name;\n          }\n          if (isTypeNode) {\n            return nodes.push(\"\t\" + fromApproveId + \">\\\"\" + traceName + \"\\\"]--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          } else {\n            return nodes.push(\"\t\" + fromApproveId + \"(\\\"\" + traceName + \"\\\")--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          }\n        });\n      }\n    }\n    approves = trace.approves;\n    if (!_.isEmpty(extraHandlerNamesCounter)) {\n      results = [];\n      for (fromApproveId in extraHandlerNamesCounter) {\n        fromApprove = extraHandlerNamesCounter[fromApproveId];\n        results.push((function() {\n          var results1;\n          results1 = [];\n          for (toApproveType in fromApprove) {\n            toApproveId = fromApprove[toApproveType];\n            tempHandlerNames = [];\n            approves.forEach(function(approve) {\n              var ref;\n              if (fromApproveId === approve.from_approve_id) {\n                if (!((ref = traceFromApproveCounters[approve._id]) != null ? ref[toApproveType] : void 0)) {\n                  return tempHandlerNames.push(approve.handler_name);\n                }\n              }\n            });\n            results1.push(nodes.push(\"\tclick \" + toApproveId + \" callback \\\"\" + (tempHandlerNames.join(\",\")) + \"\\\"\"));\n          }\n          return results1;\n        })());\n      }\n      return results;\n    }\n  },\n  generateTracesGraphSyntax: function(traces, isConvertToString, direction) {\n    var graphSyntax, lastApproves, lastTrace, nodes;\n    nodes = [\"graph \" + direction];\n    lastTrace = null;\n    lastApproves = [];\n    traces.forEach(function(trace) {\n      var currentTraceName, lines;\n      lines = trace.previous_trace_ids;\n      currentTraceName = trace.name;\n      if (lines != null ? lines.length : void 0) {\n        lines.forEach(function(line) {\n          var currentFromTraceName, fromApproves, fromTrace, toApproves;\n          fromTrace = traces.findPropertyByPK(\"_id\", line);\n          currentFromTraceName = fromTrace.name;\n          fromApproves = fromTrace.approves;\n          toApproves = trace.approves;\n          lastTrace = trace;\n          lastApproves = toApproves;\n          return fromApproves.forEach(function(fromApprove) {\n            var fromApproveHandlerName, fromTraceName, judgeText, toTraceName;\n            fromApproveHandlerName = fromApprove.handler_name;\n            if (toApproves != null ? toApproves.length : void 0) {\n              return toApproves.forEach(function(toApprove) {\n                var fromTraceName, judgeText, toTraceName;\n                if ([\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.type) < 0) {\n                  if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                    fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                    toTraceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.handler_name);\n                    judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                    if (judgeText) {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    } else {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    }\n                  }\n                }\n              });\n            } else {\n              if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                toTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName);\n                judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                if (judgeText) {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                } else {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                }\n              }\n            }\n          });\n        });\n      } else {\n        trace.approves.forEach(function(approve) {\n          var traceName;\n          traceName = FlowversionAPI.getTraceName(currentTraceName, approve.handler_name);\n          return nodes.push(\"\t\" + approve._id + \"(\\\"\" + traceName + \"\\\")\");\n        });\n      }\n      return FlowversionAPI.pushApprovesWithTypeGraphSyntax(nodes, trace);\n    });\n    if (lastApproves != null) {\n      lastApproves.forEach(function(lastApprove) {\n        return nodes.push(\"\tclass \" + lastApprove._id + \" current-step-node;\");\n      });\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  sendHtmlResponse: function(req, res, type) {\n    var allowDirections, currentStepId, direction, error_msg, flowversion, graphSyntax, instance, instance_id, query, ref, ref1, steps, title, traces;\n    query = req.query;\n    instance_id = query.instance_id;\n    direction = query.direction || 'TD';\n    allowDirections = ['TB', 'BT', 'RL', 'LR', 'TD'];\n    if (!_.include(allowDirections, direction)) {\n      return this.writeResponse(res, 500, \"Invalid direction. The value of direction should be in ['TB', 'BT', 'RL', 'LR', 'TD']\");\n    }\n    if (!instance_id) {\n      FlowversionAPI.sendInvalidURLResponse(res);\n    }\n    title = query.title;\n    if (title) {\n      title = decodeURIComponent(decodeURIComponent(title));\n    } else {\n      title = \"Workflow Chart\";\n    }\n    error_msg = \"\";\n    graphSyntax = \"\";\n    FlowversionAPI.isExpandApprove = false;\n    if (type === \"traces_expand\") {\n      type = \"traces\";\n      FlowversionAPI.isExpandApprove = true;\n    }\n    switch (type) {\n      case 'traces':\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            traces: 1\n          }\n        });\n        if (instance) {\n          traces = instance.traces;\n          if (traces != null ? traces.length : void 0) {\n            graphSyntax = this.generateTracesGraphSyntax(traces, false, direction);\n          } else {\n            error_msg = \"没有找到当前申请单的流程步骤数据\";\n          }\n        } else {\n          error_msg = \"当前申请单不存在或已被删除\";\n        }\n        break;\n      default:\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            flow_version: 1,\n            flow: 1,\n            traces: {\n              $slice: -1\n            }\n          }\n        });\n        if (instance) {\n          currentStepId = (ref = instance.traces) != null ? (ref1 = ref[0]) != null ? ref1.step : void 0 : void 0;\n          flowversion = WorkflowManager.getInstanceFlowVersion(instance);\n          steps = flowversion != null ? flowversion.steps : void 0;\n          if (steps != null ? steps.length : void 0) {\n            graphSyntax = this.generateStepsGraphSyntax(steps, currentStepId, false, direction);\n          } else {\n            error_msg = \"没有找到当前申请单的流程步骤数据\";\n          }\n        } else {\n          error_msg = \"当前申请单不存在或已被删除\";\n        }\n        break;\n    }\n    return this.writeResponse(res, 200, \"<!DOCTYPE html>\\n<html>\\n\t<head>\\n\t\t<meta charset=\\\"utf-8\\\">\\n\t\t<meta name=\\\"viewport\\\" content=\\\"width=device-width,initial-scale=1,user-scalable=yes\\\">\\n\t\t<title>\" + title + \"</title>\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"192x192\\\" href=\\\"/favicons/android-chrome-192x192.png\\\">\\n\t\t<link rel=\\\"manifest\\\" href=\\\"/favicons/manifest.json\\\">\\n\t\t<meta name=\\\"mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"theme-color\\\" content=\\\"#000\\\">\\n\t\t<meta name=\\\"application-name\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"57x57\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-57x57.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"60x60\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-60x60.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"72x72\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-72x72.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"76x76\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-76x76.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"114x114\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-114x114.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"120x120\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-120x120.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"144x144\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-144x144.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"152x152\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-152x152.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"180x180\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-180x180.png\")) + \"\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-status-bar-style\\\" content=\\\"black-translucent\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-title\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"228x228\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/coast-228x228.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"16x16\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-16x16.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"32x32\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-32x32.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"96x96\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-96x96.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"230x230\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-230x230.png\")) + \"\\\">\\n\t\t<link rel=\\\"shortcut icon\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon.ico\")) + \"\\\">\\n\t\t<link rel=\\\"yandex-tableau-widget\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/yandex-browser-manifest.json\")) + \"\\\">\\n\t\t<meta name=\\\"msapplication-TileColor\\\" content=\\\"#fff\\\">\\n\t\t<meta name=\\\"msapplication-TileImage\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/mstile-144x144.png\")) + \"\\\">\\n\t\t<meta name=\\\"msapplication-config\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/browserconfig.xml\")) + \"\\\">\\n\t\t<meta property=\\\"twitter:image\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/twitter.png\")) + \"\\\">\\n\t\t<meta property=\\\"og:image\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/open-graph.png\")) + \"\\\">\\n\t\t<link rel=\\\"stylesheet\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.css\")) + \"\\\"/>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"\" + (this.getAbsoluteUrl(\"/lib/jquery/jquery-1.11.2.min.js\")) + \"\\\"></script>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"\" + (this.getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.min.js\")) + \"\\\"></script>\\n\t\t<style>\\n\t\t\tbody { \\n\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tbackground-color: #fff;\\n\t\t\t}\\n\t\t\t.loading{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\ttop: 50%;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tmargin-top: -30px;\\n\t\t\t\tfont-size: 36px;\\n\t\t\t\tcolor: #dfdfdf;\\n\t\t\t}\\n\t\t\t.error-msg{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\tbottom: 20px;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tfont-size: 20px;\\n\t\t\t\tcolor: #a94442;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node rect{\\n\t\t\t\tfill: #ccccff;\\n\t\t\t\tstroke: rgb(144, 144, 255);\\n    \t\t\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.current-step-node rect{\\n\t\t\t\tfill: #cde498;\\n\t\t\t\tstroke: #13540c;\\n\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.condition rect{\\n\t\t\t\tfill: #ececff;\\n\t\t\t\tstroke: rgb(204, 204, 255);\\n    \t\t\t\t\t\tstroke-width: 1px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .trace-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .step-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\tdiv.mermaidTooltip{\\n\t\t\t\tposition: fixed!important;\\n\t\t\t\ttext-align: left!important;\\n\t\t\t\tpadding: 4px!important;\\n\t\t\t\tfont-size: 14px!important;\\n\t\t\t\tmax-width: 500px!important;\\n\t\t\t\tleft: auto!important;\\n\t\t\t\ttop: 15px!important;\\n\t\t\t\tright: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\\n\t\t\t\tborder-color: transparent;\\n\t\t\t\tdisplay: inline-block;\\n\t\t\t\tpadding: 2px 10px;\\n\t\t\t\tfont-size: 26px;\\n\t\t\t\tborder-radius: 20px;\\n\t\t\t\tbackground: #eee;\\n\t\t\t\tcolor: #777;\\n\t\t\t\tposition: fixed;\\n\t\t\t\tbottom: 15px;\\n\t\t\t\toutline: none;\\n\t\t\t\tcursor: pointer;\\n\t\t\t\tz-index: 99999;\\n\t\t\t\t-webkit-user-select: none;\\n\t\t\t\t-moz-user-select: none;\\n\t\t\t\t-ms-user-select: none;\\n\t\t\t\tuser-select: none;\\n\t\t\t\tline-height: 1.2;\\n\t\t\t}\\n\t\t\t@media (max-width: 768px) {\\n\t\t\t\t.btn-zoom{\\n\t\t\t\t\tdisplay:none;\\n\t\t\t\t}\\n\t\t\t}\\n\t\t\t.btn-zoom:hover{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\\n\t\t\t}\\n\t\t\t.btn-zoom-up{\\n\t\t\t\tleft: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom-down{\\n\t\t\t\tleft: 60px;\\n\t\t\t\tpadding: 1px 13px 3px 13px;\\n\t\t\t}\\n\t\t</style>\\n\t</head>\\n\t<body>\\n\t\t<div class = \\\"loading\\\">Loading...</div>\\n\t\t<div class = \\\"error-msg\\\">\" + error_msg + \"</div>\\n\t\t<div class=\\\"mermaid\\\"></div>\\n\t\t<script type=\\\"text/javascript\\\">\\n\t\t\tmermaid.initialize({\\n\t\t\t\tstartOnLoad:false\\n\t\t\t});\\n\t\t\t$(function(){\\n\t\t\t\tvar graphNodes = \" + (JSON.stringify(graphSyntax)) + \";\\n\t\t\t\t//方便前面可以通过调用mermaid.currentNodes调式，特意增加currentNodes属性。\\n\t\t\t\tmermaid.currentNodes = graphNodes;\\n\t\t\t\tvar graphSyntax = graphNodes.join(\\\"\\\\n\\\");\\n\t\t\t\tconsole.log(graphNodes);\\n\t\t\t\tconsole.log(graphSyntax);\\n\t\t\t\tconsole.log(\\\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\\\");\\n\t\t\t\t$(\\\".loading\\\").remove();\\n\\n\t\t\t\tvar id = \\\"flow-steps-svg\\\";\\n\t\t\t\tvar element = $('.mermaid');\\n\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\\n\t\t\t\t\telement.html(svgCode);\\n\t\t\t\t\tif(typeof callback !== 'undefined'){\\n\t\t\t\t\t\tcallback(id);\\n\t\t\t\t\t}\\n\t\t\t\t\tbindFunctions(element[0]);\\n\t\t\t\t};\\n\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\\n\\n\t\t\t\tvar zoomSVG = function(zoom){\\n\t\t\t\t\tvar currentWidth = $(\\\"svg\\\").width();\\n\t\t\t\t\tvar newWidth = currentWidth * zoom;\\n\t\t\t\t\t$(\\\"svg\\\").css(\\\"maxWidth\\\",newWidth + \\\"px\\\").width(newWidth);\\n\t\t\t\t}\\n\\n\t\t\t\t//支持鼠标滚轮缩放画布\\n\t\t\t\t$(window).on(\\\"mousewheel\\\",function(event){\\n\t\t\t\t\tif(event.ctrlKey){\\n\t\t\t\t\t\tevent.preventDefault();\\n\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\\n\t\t\t\t\t\tzoomSVG(zoom);\\n\t\t\t\t\t}\\n\t\t\t\t});\\n\t\t\t\t$(\\\".btn-zoom\\\").on(\\\"click\\\",function(){\\n\t\t\t\t\tzoomSVG($(this).attr(\\\"zoom\\\"));\\n\t\t\t\t});\\n\t\t\t});\\n\t\t</script>\\n\t\t<a class=\\\"btn-zoom btn-zoom-up\\\" zoom=1.1 title=\\\"点击放大\\\">+</a>\\n\t\t<a class=\\\"btn-zoom btn-zoom-down\\\" zoom=0.9 title=\\\"点击缩小\\\">-</a>\\n\t</body>\\n</html>\");\n  }\n};\n\nJsonRoutes.add('get', '/api/workflow/chart?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res);\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces\");\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces_expand\");\n});\n"]}