{"version":3,"sources":["meteor://💻app/packages/steedos_object-database/server/routes/api_creator_objects.coffee","meteor://💻app/server/routes/api_creator_objects.coffee","meteor://💻app/packages/steedos_object-database/server/publications/objects.coffee","meteor://💻app/server/publications/objects.coffee","meteor://💻app/packages/steedos_object-database/server/publications/object_layouts.coffee","meteor://💻app/server/publications/object_layouts.coffee"],"names":["_getLocale","clone","getUserProfileObjectLayout","objectql","steedosAuth","steedosI18n","require","user","locale","ref","ref1","toLocaleLowerCase","userId","spaceId","objectName","spaceUser","Creator","getCollection","findOne","space","fields","profile","profiles","object_name","JsonRoutes","add","req","res","next","_fields","_id","_object","authToken","e","isSpaceAdmin","lng","object","objectLayout","permissions","psets","psetsAdmin","psetsAdmin_pos","psetsCurrent","psetsCurrentNames","psetsCurrent_pos","psetsCustomer","psetsCustomer_pos","psetsGuest","psetsGuest_pos","psetsMember","psetsMember_pos","psetsSupplier","psetsSupplier_pos","psetsUser","psetsUser_pos","set_ids","type","userSession","params","headers","query","_","isEmpty","name","assigned_apps","find","$or","users","fetch","permission_set_id","created","modified","created_by","modified_by","length","pluck","$in","in_development","is_enable","datasource","Steedos","getAuthToken","Meteor","wrapAsync","cb","getSession","then","resolve","reject","v","getUserObjectPermission","convertObject","getObject","toConfig","database_name","label","Objects","getObjectPermissions","bind","db","list_views","getUserObjectListViews","translationObject","Object","assign","each","_item","field","has","group","required","readonly","disabled","allow_actions","actions","allow_relatedList","relatedList","sendResult","code","data","error","console","stack","errors","errorMessage","reason","message","publish","config","getSteedosConfig","tenant","saas","is_deleted","$ne"],"mappings":"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","file":"/packages/steedos_object-database.js","sourcesContent":["clone = require(\"clone\");\nsteedosAuth = require(\"@steedos/auth\");\nsteedosI18n = require(\"@steedos/i18n\");\nobjectql = require(\"@steedos/objectql\");\n\n_getLocale = (user)->\n\tif user?.locale?.toLocaleLowerCase() == 'zh-cn'\n\t\tlocale = \"zh-CN\"\n\telse if user?.locale?.toLocaleLowerCase() == 'en-us'\n\t\tlocale = \"en\"\n\telse\n\t\tlocale = \"zh-CN\"\n\treturn locale\n\ngetUserProfileObjectLayout = (userId, spaceId, objectName)->\n\tspaceUser = Creator.getCollection(\"space_users\").findOne({space: spaceId, user: userId}, {fields: {profile: 1}})\n\tif spaceUser && spaceUser.profile\n\t\treturn Creator.getCollection(\"object_layouts\")?.findOne({space: spaceId, profiles: spaceUser.profile, object_name: objectName});\n\nJsonRoutes.add 'get', '/api/creator/:space/objects/:_id', (req, res, next) ->\n\ttry\n\t\t_id = req.params._id\n\t\tspaceId = req.params.space\n\t\tuserId = req.headers[\"x-user-id\"]\n\n\t\ttype = req.query?.type\n\n\t\t_object = Creator.getCollection('objects').findOne(_id) || {}\n\n\t\tobject = {}\n\t\tif !_.isEmpty(_object)\n\t\t\tisSpaceAdmin = false\n\t\t\tspaceUser = null\n\t\t\tif userId\n\t\t\t\tisSpaceAdmin = Creator.isSpaceAdmin(spaceId, userId)\n\t\t\t\tspaceUser = Creator.getCollection(\"space_users\").findOne({ space: spaceId, user: userId }, { fields: { profile: 1 } })\n\n\t\t\tpsetsAdmin = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'admin'}, {fields:{_id:1, assigned_apps:1}}) || null\n\t\t\tpsetsUser = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'user'}, {fields:{_id:1, assigned_apps:1}}) || null\n\t\t\tpsetsMember = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'member'}, {fields:{_id:1, assigned_apps:1}}) || null\n\t\t\tpsetsGuest = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'guest'}, {fields:{_id:1, assigned_apps:1}}) || null\n\n\t\t\tpsetsSupplier = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'supplier'}, {fields:{_id:1, assigned_apps:1}}) || null\n\t\t\tpsetsCustomer = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'customer'}, {fields:{_id:1, assigned_apps:1}}) || null\n\t\t\tif spaceUser && spaceUser.profile\n\t\t\t\tpsetsCurrent = Creator.getCollection(\"permission_set\").find({space: spaceId, $or: [{users: userId}, {name: spaceUser.profile}]}, {fields:{_id:1, assigned_apps:1, name:1}}).fetch()\n\t\t\telse\n\t\t\t\tpsetsCurrent = Creator.getCollection(\"permission_set\").find({users: userId, space: spaceId}, {fields:{_id:1, assigned_apps:1, name:1}}).fetch()\n\n\t\t\tpsetsAdmin_pos = null\n\t\t\tpsetsUser_pos = null\n\t\t\tpsetsMember_pos = null\n\t\t\tpsetsGuest_pos = null\n\t\t\tpsetsCurrent_pos = null\n\t\t\tpsetsSupplier_pos = null\n\t\t\tpsetsCustomer_pos = null\n\n\t\t\tif psetsAdmin?._id\n\t\t\t\tpsetsAdmin_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: psetsAdmin._id}, {fields: {created: 0, modified: 0, created_by: 0, modified_by: 0}}).fetch()\n\t\t\tif psetsUser?._id\n\t\t\t\tpsetsUser_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: psetsUser._id}, {fields: {created: 0, modified: 0, created_by: 0, modified_by: 0}}).fetch()\n\t\t\tif psetsMember?._id\n\t\t\t\tpsetsMember_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: psetsMember._id}, {fields: {created: 0, modified: 0, created_by: 0, modified_by: 0}}).fetch()\n\t\t\tif psetsGuest?._id\n\t\t\t\tpsetsGuest_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: psetsGuest._id}, {fields: {created: 0, modified: 0, created_by: 0, modified_by: 0}}).fetch()\n\t\t\tif psetsSupplier?._id\n\t\t\t\tpsetsSupplier_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: psetsSupplier._id}, {fields: {created: 0, modified: 0, created_by: 0, modified_by: 0}}).fetch()\n\t\t\tif psetsCustomer?._id\n\t\t\t\tpsetsCustomer_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: psetsCustomer._id}, {fields: {created: 0, modified: 0, created_by: 0, modified_by: 0}}).fetch()\n\n\t\t\tif psetsCurrent.length > 0\n\t\t\t\tset_ids = _.pluck psetsCurrent, \"_id\"\n\t\t\t\tpsetsCurrent_pos = Creator.getCollection(\"permission_objects\").find({permission_set_id: {$in: set_ids}}).fetch()\n\t\t\t\tpsetsCurrentNames = _.pluck psetsCurrent, \"name\"\n\n\t\t\tpsets = {\n\t\t\t\tpsetsAdmin,\n\t\t\t\tpsetsUser,\n\t\t\t\tpsetsCurrent,\n\t\t\t\tpsetsMember,\n\t\t\t\tpsetsGuest,\n\t\t\t\tpsetsSupplier,\n\t\t\t\tpsetsCustomer,\n\t\t\t\tisSpaceAdmin,\n\t\t\t\tspaceUser,\n\t\t\t\tpsetsAdmin_pos,\n\t\t\t\tpsetsUser_pos,\n\t\t\t\tpsetsMember_pos,\n\t\t\t\tpsetsGuest_pos,\n\t\t\t\tpsetsSupplier_pos,\n\t\t\t\tpsetsCustomer_pos,\n\t\t\t\tpsetsCurrent_pos\n\t\t\t}\n\n\t\t\tif isSpaceAdmin || _object.in_development == '0' && _object.is_enable\n\t\t\t\tif _object.datasource != 'default'\n\t\t\t\t\tauthToken = Steedos.getAuthToken(req, res)\n\t\t\t\t\tuserSession = Meteor.wrapAsync((authToken, spaceId, cb)->\n\t\t\t\t\t\tsteedosAuth.getSession(authToken, spaceId).then (resolve, reject)->\n\t\t\t\t\t\t\tcb(reject, resolve)\n\t\t\t\t\t)(authToken, spaceId)\n\t\t\t\t\tpermissions = Meteor.wrapAsync (v, userSession, cb)->\n\t\t\t\t\t\tv.getUserObjectPermission(userSession).then (resolve, reject)->\n\t\t\t\t\t\t\tcb(reject, resolve)\n\t\t\t\t\tobject = Creator.convertObject(clone(objectql.getObject(_object.name).toConfig()), spaceId)\n\t\t\t\t\tobject.database_name = Creator.getCollection(\"datasources\").findOne({_id: _object.datasource})?.label\n\t\t\t\t\tobject.permissions = permissions(objectql.getObject(_object.name), userSession)\n\t\t\t\telse\n\n\t\t\t\t\tobject = Creator.convertObject(clone(Creator.Objects[_object.name]), spaceId) # Creator.convertObject(clone(Creator.Objects[_object.name]), spaceId) # Creator.convertObject(clone(new Creator.Object(_object)), spaceId);\n\t\t\t\t\tobject.permissions = Creator.getObjectPermissions.bind(psets)(spaceId, userId, object.name)\n\n\t\t\t\tdelete object.db\n\t\t\t\tobject.list_views = Creator.getUserObjectListViews(userId, spaceId, object.name)\n\t\t\t\tlng = _getLocale(db.users.findOne(userId, {fields: {locale: 1}}))\n\t\t\t\tsteedosI18n.translationObject(lng, object.name, Object.assign(object, {datasource: _object.datasource}))\n\t\t\t\tobjectLayout = getUserProfileObjectLayout(userId, spaceId, object.name)\n\t\t\t\tif objectLayout\n\t\t\t\t\t_fields = {};\n\t\t\t\t\t_.each objectLayout.fields, (_item)->\n\t\t\t\t\t\t_fields[_item.field] = object.fields[_item.field]\n\t\t\t\t\t\tif _.has(_item, 'group')\n\t\t\t\t\t\t\t_fields[_item.field].group = _item.group\n\t\t\t\t\t\tif _item.required\n\t\t\t\t\t\t\t_fields[_item.field].readonly = false\n\t\t\t\t\t\t\t_fields[_item.field].disabled = false\n\t\t\t\t\t\t\t_fields[_item.field].required = true\n\t\t\t\t\t\telse if _item.readonly\n\t\t\t\t\t\t\t_fields[_item.field].readonly = true\n\t\t\t\t\t\t\t_fields[_item.field].disabled = true\n\t\t\t\t\t\t\t_fields[_item.field].required = false\n\t\t\t\t\tobject.fields = _fields\n\t\t\t\t\tobject.allow_actions = objectLayout.actions || []\n\t\t\t\t\tobject.allow_relatedList = objectLayout.relatedList || []\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: object\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{ errorMessage: e.reason || e.message }] }\n\t\t}","var _getLocale, clone, getUserProfileObjectLayout, objectql, steedosAuth, steedosI18n;\n\nclone = require(\"clone\");\n\nsteedosAuth = require(\"@steedos/auth\");\n\nsteedosI18n = require(\"@steedos/i18n\");\n\nobjectql = require(\"@steedos/objectql\");\n\n_getLocale = function(user) {\n  var locale, ref, ref1;\n  if ((user != null ? (ref = user.locale) != null ? ref.toLocaleLowerCase() : void 0 : void 0) === 'zh-cn') {\n    locale = \"zh-CN\";\n  } else if ((user != null ? (ref1 = user.locale) != null ? ref1.toLocaleLowerCase() : void 0 : void 0) === 'en-us') {\n    locale = \"en\";\n  } else {\n    locale = \"zh-CN\";\n  }\n  return locale;\n};\n\ngetUserProfileObjectLayout = function(userId, spaceId, objectName) {\n  var ref, spaceUser;\n  spaceUser = Creator.getCollection(\"space_users\").findOne({\n    space: spaceId,\n    user: userId\n  }, {\n    fields: {\n      profile: 1\n    }\n  });\n  if (spaceUser && spaceUser.profile) {\n    return (ref = Creator.getCollection(\"object_layouts\")) != null ? ref.findOne({\n      space: spaceId,\n      profiles: spaceUser.profile,\n      object_name: objectName\n    }) : void 0;\n  }\n};\n\nJsonRoutes.add('get', '/api/creator/:space/objects/:_id', function(req, res, next) {\n  var _fields, _id, _object, authToken, e, isSpaceAdmin, lng, object, objectLayout, permissions, psets, psetsAdmin, psetsAdmin_pos, psetsCurrent, psetsCurrentNames, psetsCurrent_pos, psetsCustomer, psetsCustomer_pos, psetsGuest, psetsGuest_pos, psetsMember, psetsMember_pos, psetsSupplier, psetsSupplier_pos, psetsUser, psetsUser_pos, ref, ref1, set_ids, spaceId, spaceUser, type, userId, userSession;\n  try {\n    _id = req.params._id;\n    spaceId = req.params.space;\n    userId = req.headers[\"x-user-id\"];\n    type = (ref = req.query) != null ? ref.type : void 0;\n    _object = Creator.getCollection('objects').findOne(_id) || {};\n    object = {};\n    if (!_.isEmpty(_object)) {\n      isSpaceAdmin = false;\n      spaceUser = null;\n      if (userId) {\n        isSpaceAdmin = Creator.isSpaceAdmin(spaceId, userId);\n        spaceUser = Creator.getCollection(\"space_users\").findOne({\n          space: spaceId,\n          user: userId\n        }, {\n          fields: {\n            profile: 1\n          }\n        });\n      }\n      psetsAdmin = Creator.getCollection(\"permission_set\").findOne({\n        space: spaceId,\n        name: 'admin'\n      }, {\n        fields: {\n          _id: 1,\n          assigned_apps: 1\n        }\n      }) || null;\n      psetsUser = Creator.getCollection(\"permission_set\").findOne({\n        space: spaceId,\n        name: 'user'\n      }, {\n        fields: {\n          _id: 1,\n          assigned_apps: 1\n        }\n      }) || null;\n      psetsMember = Creator.getCollection(\"permission_set\").findOne({\n        space: spaceId,\n        name: 'member'\n      }, {\n        fields: {\n          _id: 1,\n          assigned_apps: 1\n        }\n      }) || null;\n      psetsGuest = Creator.getCollection(\"permission_set\").findOne({\n        space: spaceId,\n        name: 'guest'\n      }, {\n        fields: {\n          _id: 1,\n          assigned_apps: 1\n        }\n      }) || null;\n      psetsSupplier = Creator.getCollection(\"permission_set\").findOne({\n        space: spaceId,\n        name: 'supplier'\n      }, {\n        fields: {\n          _id: 1,\n          assigned_apps: 1\n        }\n      }) || null;\n      psetsCustomer = Creator.getCollection(\"permission_set\").findOne({\n        space: spaceId,\n        name: 'customer'\n      }, {\n        fields: {\n          _id: 1,\n          assigned_apps: 1\n        }\n      }) || null;\n      if (spaceUser && spaceUser.profile) {\n        psetsCurrent = Creator.getCollection(\"permission_set\").find({\n          space: spaceId,\n          $or: [\n            {\n              users: userId\n            }, {\n              name: spaceUser.profile\n            }\n          ]\n        }, {\n          fields: {\n            _id: 1,\n            assigned_apps: 1,\n            name: 1\n          }\n        }).fetch();\n      } else {\n        psetsCurrent = Creator.getCollection(\"permission_set\").find({\n          users: userId,\n          space: spaceId\n        }, {\n          fields: {\n            _id: 1,\n            assigned_apps: 1,\n            name: 1\n          }\n        }).fetch();\n      }\n      psetsAdmin_pos = null;\n      psetsUser_pos = null;\n      psetsMember_pos = null;\n      psetsGuest_pos = null;\n      psetsCurrent_pos = null;\n      psetsSupplier_pos = null;\n      psetsCustomer_pos = null;\n      if (psetsAdmin != null ? psetsAdmin._id : void 0) {\n        psetsAdmin_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: psetsAdmin._id\n        }, {\n          fields: {\n            created: 0,\n            modified: 0,\n            created_by: 0,\n            modified_by: 0\n          }\n        }).fetch();\n      }\n      if (psetsUser != null ? psetsUser._id : void 0) {\n        psetsUser_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: psetsUser._id\n        }, {\n          fields: {\n            created: 0,\n            modified: 0,\n            created_by: 0,\n            modified_by: 0\n          }\n        }).fetch();\n      }\n      if (psetsMember != null ? psetsMember._id : void 0) {\n        psetsMember_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: psetsMember._id\n        }, {\n          fields: {\n            created: 0,\n            modified: 0,\n            created_by: 0,\n            modified_by: 0\n          }\n        }).fetch();\n      }\n      if (psetsGuest != null ? psetsGuest._id : void 0) {\n        psetsGuest_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: psetsGuest._id\n        }, {\n          fields: {\n            created: 0,\n            modified: 0,\n            created_by: 0,\n            modified_by: 0\n          }\n        }).fetch();\n      }\n      if (psetsSupplier != null ? psetsSupplier._id : void 0) {\n        psetsSupplier_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: psetsSupplier._id\n        }, {\n          fields: {\n            created: 0,\n            modified: 0,\n            created_by: 0,\n            modified_by: 0\n          }\n        }).fetch();\n      }\n      if (psetsCustomer != null ? psetsCustomer._id : void 0) {\n        psetsCustomer_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: psetsCustomer._id\n        }, {\n          fields: {\n            created: 0,\n            modified: 0,\n            created_by: 0,\n            modified_by: 0\n          }\n        }).fetch();\n      }\n      if (psetsCurrent.length > 0) {\n        set_ids = _.pluck(psetsCurrent, \"_id\");\n        psetsCurrent_pos = Creator.getCollection(\"permission_objects\").find({\n          permission_set_id: {\n            $in: set_ids\n          }\n        }).fetch();\n        psetsCurrentNames = _.pluck(psetsCurrent, \"name\");\n      }\n      psets = {\n        psetsAdmin: psetsAdmin,\n        psetsUser: psetsUser,\n        psetsCurrent: psetsCurrent,\n        psetsMember: psetsMember,\n        psetsGuest: psetsGuest,\n        psetsSupplier: psetsSupplier,\n        psetsCustomer: psetsCustomer,\n        isSpaceAdmin: isSpaceAdmin,\n        spaceUser: spaceUser,\n        psetsAdmin_pos: psetsAdmin_pos,\n        psetsUser_pos: psetsUser_pos,\n        psetsMember_pos: psetsMember_pos,\n        psetsGuest_pos: psetsGuest_pos,\n        psetsSupplier_pos: psetsSupplier_pos,\n        psetsCustomer_pos: psetsCustomer_pos,\n        psetsCurrent_pos: psetsCurrent_pos\n      };\n      if (isSpaceAdmin || _object.in_development === '0' && _object.is_enable) {\n        if (_object.datasource !== 'default') {\n          authToken = Steedos.getAuthToken(req, res);\n          userSession = Meteor.wrapAsync(function(authToken, spaceId, cb) {\n            return steedosAuth.getSession(authToken, spaceId).then(function(resolve, reject) {\n              return cb(reject, resolve);\n            });\n          })(authToken, spaceId);\n          permissions = Meteor.wrapAsync(function(v, userSession, cb) {\n            return v.getUserObjectPermission(userSession).then(function(resolve, reject) {\n              return cb(reject, resolve);\n            });\n          });\n          object = Creator.convertObject(clone(objectql.getObject(_object.name).toConfig()), spaceId);\n          object.database_name = (ref1 = Creator.getCollection(\"datasources\").findOne({\n            _id: _object.datasource\n          })) != null ? ref1.label : void 0;\n          object.permissions = permissions(objectql.getObject(_object.name), userSession);\n        } else {\n          object = Creator.convertObject(clone(Creator.Objects[_object.name]), spaceId);\n          object.permissions = Creator.getObjectPermissions.bind(psets)(spaceId, userId, object.name);\n        }\n        delete object.db;\n        object.list_views = Creator.getUserObjectListViews(userId, spaceId, object.name);\n        lng = _getLocale(db.users.findOne(userId, {\n          fields: {\n            locale: 1\n          }\n        }));\n        steedosI18n.translationObject(lng, object.name, Object.assign(object, {\n          datasource: _object.datasource\n        }));\n        objectLayout = getUserProfileObjectLayout(userId, spaceId, object.name);\n        if (objectLayout) {\n          _fields = {};\n          _.each(objectLayout.fields, function(_item) {\n            _fields[_item.field] = object.fields[_item.field];\n            if (_.has(_item, 'group')) {\n              _fields[_item.field].group = _item.group;\n            }\n            if (_item.required) {\n              _fields[_item.field].readonly = false;\n              _fields[_item.field].disabled = false;\n              return _fields[_item.field].required = true;\n            } else if (_item.readonly) {\n              _fields[_item.field].readonly = true;\n              _fields[_item.field].disabled = true;\n              return _fields[_item.field].required = false;\n            }\n          });\n          object.fields = _fields;\n          object.allow_actions = objectLayout.actions || [];\n          object.allow_relatedList = objectLayout.relatedList || [];\n        }\n      }\n    }\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: object\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.reason || e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","objectql = require(\"@steedos/objectql\");\nMeteor.publish \"creator_objects\", (space)->\n\t#TODO 根据权限返回Objects记录\n\tconfig = objectql.getSteedosConfig();\n\tif config.tenant && config.tenant.saas\n\t\treturn\n\tCreator.getCollection(\"objects\").find({space: {$in: [null, space]}, is_deleted: {$ne: true}}, {fields: {_id: 1, modified: 1, is_enable: 1, in_development: 1}})","var objectql;\n\nobjectql = require(\"@steedos/objectql\");\n\nMeteor.publish(\"creator_objects\", function(space) {\n  var config;\n  config = objectql.getSteedosConfig();\n  if (config.tenant && config.tenant.saas) {\n    return;\n  }\n  return Creator.getCollection(\"objects\").find({\n    space: {\n      $in: [null, space]\n    },\n    is_deleted: {\n      $ne: true\n    }\n  }, {\n    fields: {\n      _id: 1,\n      modified: 1,\n      is_enable: 1,\n      in_development: 1\n    }\n  });\n});\n","Meteor.publish \"publish_object_layouts\", (space)->\n\tuserId = this.userId\n\tif !userId\n\t\treturn\n\tspaceUser = Creator.getCollection(\"space_users\").findOne({space: space, user: userId}, {fields: {profile: 1}})\n\tif spaceUser && spaceUser.profile\n\t\tCreator.getCollection(\"object_layouts\").find({space: {$in: [null, space]}, profiles: spaceUser.profile}, {fields: {_id: 1, modified: 1, object_name: 1}})","Meteor.publish(\"publish_object_layouts\", function(space) {\n  var spaceUser, userId;\n  userId = this.userId;\n  if (!userId) {\n    return;\n  }\n  spaceUser = Creator.getCollection(\"space_users\").findOne({\n    space: space,\n    user: userId\n  }, {\n    fields: {\n      profile: 1\n    }\n  });\n  if (spaceUser && spaceUser.profile) {\n    return Creator.getCollection(\"object_layouts\").find({\n      space: {\n        $in: [null, space]\n      },\n      profiles: spaceUser.profile\n    }, {\n      fields: {\n        _id: 1,\n        modified: 1,\n        object_name: 1\n      }\n    });\n  }\n});\n"]}