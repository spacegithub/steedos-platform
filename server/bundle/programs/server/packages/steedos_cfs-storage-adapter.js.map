{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/checkNpm.js","meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/storageAdapter.server.js","meteor://ðŸ’»app/packages/steedos:cfs-storage-adapter/transform.server.js"],"names":["checkNpmVersions","module","link","v","_storageAdapters","FS","StorageAdapter","storeName","options","api","self","fileKeyMaker","arguments","length","Error","Utility","each","split","name","typeName","internal","indexOf","fileKey","beforeWrite","extend","adapter","fileObj","createReadStreamForFileKey","debug","console","log","safeStream","createReadStream","_transform","logEventsForStream","stream","on","error","message","code","createWriteStreamForFileKey","writeStream","createWriteStream","store","save","type","size","fileChanges","extension","safeOn","result","copies","key","updatedAt","storedAt","Date","createdAt","_saveChanges","once","emitted","emit","_removeAsync","callback","remove","call","File","safeCallback","Meteor","wrapAsync","warn","init","bind","Transform","transformWrite","transformRead","require","inherits","EventEmitter","PassThrough","lengthStream","storage","scope","gm","source","height","color","prototype","destinationStream","aliases","contentType","metadata","addPassThrough","ptStream","originalStream","err","lstream","fileSize","pipe","sourceStream","func","pts"],"mappings":"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","file":"/packages/steedos_cfs-storage-adapter.js","sourcesContent":["import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\t'length-stream': '0.1.1'\r\n}, 'steedos:cfs-storage-adapter');","/* global FS, _storageAdapters:true, EventEmitter */\r\n\r\n// #############################################################################\r\n//\r\n// STORAGE ADAPTER\r\n//\r\n// #############################################################################\r\n_storageAdapters = {};\r\n\r\nFS.StorageAdapter = function(storeName, options, api) {\r\n  var self = this, fileKeyMaker;\r\n  options = options || {};\r\n\r\n  // If storeName is the only argument, a string and the SA already found\r\n  // we will just return that SA\r\n  if (arguments.length === 1 && storeName === '' + storeName &&\r\n          typeof _storageAdapters[storeName] !== 'undefined')\r\n    return _storageAdapters[storeName];\r\n\r\n  // Verify that the storage adapter defines all the necessary API methods\r\n  if (typeof api === 'undefined') {\r\n    throw new Error('FS.StorageAdapter please define an api');\r\n  }\r\n\r\n  FS.Utility.each('fileKey,remove,typeName,createReadStream,createWriteStream'.split(','), function(name) {\r\n    if (typeof api[name] === 'undefined') {\r\n      throw new Error('FS.StorageAdapter please define an api. \"' + name + '\" ' + (api.typeName || ''));\r\n    }\r\n  });\r\n\r\n  // Create an internal namespace, starting a name with underscore is only\r\n  // allowed for stores marked with options.internal === true\r\n  if (options.internal !== true && storeName[0] === '_') {\r\n    throw new Error('A storage adapter name may not begin with \"_\"');\r\n  }\r\n\r\n  if (storeName.indexOf('.') !== -1) {\r\n    throw new Error('A storage adapter name may not contain a \".\"');\r\n  }\r\n\r\n  // store reference for easy lookup by storeName\r\n  if (typeof _storageAdapters[storeName] !== 'undefined') {\r\n    throw new Error('Storage name already exists: \"' + storeName + '\"');\r\n  } else {\r\n    _storageAdapters[storeName] = self;\r\n  }\r\n\r\n  // User can customize the file key generation function\r\n  if (typeof options.fileKeyMaker === \"function\") {\r\n    fileKeyMaker = options.fileKeyMaker;\r\n  } else {\r\n    fileKeyMaker = api.fileKey;\r\n  }\r\n\r\n  // User can provide a function to adjust the fileObj\r\n  // before it is written to the store.\r\n  var beforeWrite = options.beforeWrite;\r\n\r\n  // extend self with options and other info\r\n  FS.Utility.extend(this, options, {\r\n    name: storeName,\r\n    typeName: api.typeName\r\n  });\r\n\r\n  // Create a nicer abstracted adapter interface\r\n  self.adapter = {};\r\n\r\n  self.adapter.fileKey = function(fileObj) {\r\n    return fileKeyMaker(fileObj);\r\n  };\r\n\r\n  // Return readable stream for fileKey\r\n  self.adapter.createReadStreamForFileKey = function(fileKey, options) {\r\n    if (FS.debug) console.log('createReadStreamForFileKey ' + storeName);\r\n    return FS.Utility.safeStream( api.createReadStream(fileKey, options) );\r\n  };\r\n\r\n  // Return readable stream for fileObj\r\n  self.adapter.createReadStream = function(fileObj, options) {\r\n    if (FS.debug) console.log('createReadStream ' + storeName);\r\n    if (self.internal) {\r\n      // Internal stores take a fileKey\r\n      return self.adapter.createReadStreamForFileKey(fileObj, options);\r\n    }\r\n    return FS.Utility.safeStream( self._transform.createReadStream(fileObj, options) );\r\n  };\r\n\r\n  function logEventsForStream(stream) {\r\n    if (FS.debug) {\r\n      stream.on('stored', function() {\r\n        console.log('-----------STORED STREAM', storeName);\r\n      });\r\n\r\n      stream.on('close', function() {\r\n        console.log('-----------CLOSE STREAM', storeName);\r\n      });\r\n\r\n      stream.on('end', function() {\r\n        console.log('-----------END STREAM', storeName);\r\n      });\r\n\r\n      stream.on('finish', function() {\r\n        console.log('-----------FINISH STREAM', storeName);\r\n      });\r\n\r\n      stream.on('error', function(error) {\r\n        console.log('-----------ERROR STREAM', storeName, error && (error.message || error.code));\r\n      });\r\n    }\r\n  }\r\n\r\n  // Return writeable stream for fileKey\r\n  self.adapter.createWriteStreamForFileKey = function(fileKey, options) {\r\n    if (FS.debug) console.log('createWriteStreamForFileKey ' + storeName);\r\n    var writeStream = FS.Utility.safeStream( api.createWriteStream(fileKey, options) );\r\n\r\n    logEventsForStream(writeStream);\r\n\r\n    return writeStream;\r\n  };\r\n\r\n  // Return writeable stream for fileObj\r\n  self.adapter.createWriteStream = function(fileObj, options) {\r\n    if (FS.debug) console.log('createWriteStream ' + storeName + ', internal: ' + !!self.internal);\r\n\r\n    if (self.internal) {\r\n      // Internal stores take a fileKey\r\n      return self.adapter.createWriteStreamForFileKey(fileObj, options);\r\n    }\r\n\r\n    // If we haven't set name, type, or size for this version yet,\r\n    // set it to same values as original version. We don't save\r\n    // these to the DB right away because they might be changed\r\n    // in a transformWrite function.\r\n    if (!fileObj.name({store: storeName})) {\r\n      fileObj.name(fileObj.name(), {store: storeName, save: false});\r\n    }\r\n    if (!fileObj.type({store: storeName})) {\r\n      fileObj.type(fileObj.type(), {store: storeName, save: false});\r\n    }\r\n    if (!fileObj.size({store: storeName})) {\r\n      fileObj.size(fileObj.size(), {store: storeName, save: false});\r\n    }\r\n\r\n    // Call user function to adjust file metadata for this store.\r\n    // We support updating name, extension, and/or type based on\r\n    // info returned in an object. Or `fileObj` could be\r\n    // altered directly within the beforeWrite function.\r\n    if (beforeWrite) {\r\n      var fileChanges = beforeWrite(fileObj);\r\n      if (typeof fileChanges === \"object\") {\r\n        if (fileChanges.extension) {\r\n          fileObj.extension(fileChanges.extension, {store: storeName, save: false});\r\n        } else if (fileChanges.name) {\r\n          fileObj.name(fileChanges.name, {store: storeName, save: false});\r\n        }\r\n        if (fileChanges.type) {\r\n          fileObj.type(fileChanges.type, {store: storeName, save: false});\r\n        }\r\n      }\r\n    }\r\n\r\n    var writeStream = FS.Utility.safeStream( self._transform.createWriteStream(fileObj, options) );\r\n\r\n    logEventsForStream(writeStream);\r\n\r\n    // Its really only the storage adapter who knows if the file is uploaded\r\n    //\r\n    // We have to use our own event making sure the storage process is completed\r\n    // this is mainly\r\n    writeStream.safeOn('stored', function(result) {\r\n      if (typeof result.fileKey === 'undefined') {\r\n        throw new Error('SA ' + storeName + ' type ' + api.typeName + ' did not return a fileKey');\r\n      }\r\n      if (FS.debug) console.log('SA', storeName, 'stored', result.fileKey);\r\n      // Set the fileKey\r\n      fileObj.copies[storeName].key = result.fileKey;\r\n\r\n      // Update the size, as provided by the SA, in case it was changed by stream transformation\r\n      if (typeof result.size === \"number\") {\r\n        fileObj.copies[storeName].size = result.size;\r\n      }\r\n\r\n      // Set last updated time, either provided by SA or now\r\n      fileObj.copies[storeName].updatedAt = result.storedAt || new Date();\r\n\r\n      // If the file object copy havent got a createdAt then set this\r\n      if (typeof fileObj.copies[storeName].createdAt === 'undefined') {\r\n        fileObj.copies[storeName].createdAt = fileObj.copies[storeName].updatedAt;\r\n      }\r\n\r\n      fileObj._saveChanges(storeName);\r\n\r\n      // There is code in transform that may have set the original file size, too.\r\n      fileObj._saveChanges('_original');\r\n    });\r\n\r\n    // Emit events from SA\r\n    writeStream.once('stored', function(/*result*/) {\r\n      // XXX Because of the way stores inherit from SA, this will emit on every store.\r\n      // Maybe need to rewrite the way we inherit from SA?\r\n      var emitted = self.emit('stored', storeName, fileObj);\r\n      if (FS.debug && !emitted) {\r\n        console.log(fileObj.name() + ' was successfully stored in the ' + storeName + ' store. You are seeing this informational message because you enabled debugging and you have not defined any listeners for the \"stored\" event on this store.');\r\n      }\r\n    });\r\n\r\n    writeStream.on('error', function(error) {\r\n      // XXX We could wrap and clarify error\r\n      // XXX Because of the way stores inherit from SA, this will emit on every store.\r\n      // Maybe need to rewrite the way we inherit from SA?\r\n      var emitted = self.emit('error', storeName, error, fileObj);\r\n      if (FS.debug && !emitted) {\r\n        console.log(error);\r\n      }\r\n    });\r\n\r\n    return writeStream;\r\n  };\r\n\r\n  //internal\r\n  self._removeAsync = function(fileKey, callback) {\r\n    // Remove the file from the store\r\n    api.remove.call(self, fileKey, callback);\r\n  };\r\n\r\n  /**\r\n   * @method FS.StorageAdapter.prototype.remove\r\n   * @public\r\n   * @param {FS.File} fsFile The FS.File instance to be stored.\r\n   * @param {Function} [callback] If not provided, will block and return true or false\r\n   *\r\n   * Attempts to remove a file from the store. Returns true if removed or not\r\n   * found, or false if the file couldn't be removed.\r\n   */\r\n  self.adapter.remove = function(fileObj, callback) {\r\n    if (FS.debug) console.log(\"---SA REMOVE\");\r\n\r\n    // Get the fileKey\r\n    var fileKey = (fileObj instanceof FS.File) ? self.adapter.fileKey(fileObj) : fileObj;\r\n\r\n    if (callback) {\r\n      return self._removeAsync(fileKey, FS.Utility.safeCallback(callback));\r\n    } else {\r\n      return Meteor.wrapAsync(self._removeAsync)(fileKey);\r\n    }\r\n  };\r\n\r\n  self.remove = function(fileObj, callback) {\r\n    // Add deprecation note\r\n    console.warn('Storage.remove is deprecating, use \"Storage.adapter.remove\"');\r\n    return self.adapter.remove(fileObj, callback);\r\n  };\r\n\r\n  if (typeof api.init === 'function') {\r\n    Meteor.wrapAsync(api.init.bind(self))();\r\n  }\r\n\r\n  // This supports optional transformWrite and transformRead\r\n  self._transform = new FS.Transform({\r\n    adapter: self.adapter,\r\n    // Optional transformation functions:\r\n    transformWrite: options.transformWrite,\r\n    transformRead: options.transformRead\r\n  });\r\n\r\n};\r\n\r\nrequire('util').inherits(FS.StorageAdapter, EventEmitter);\r\n","/* global FS, gm */\r\n\r\nvar PassThrough = require('stream').PassThrough;\r\nvar lengthStream = require('length-stream');\r\n\r\nFS.Transform = function(options) {\r\n  var self = this;\r\n\r\n  options = options || {};\r\n\r\n  if (!(self instanceof FS.Transform))\r\n    throw new Error('FS.Transform must be called with the \"new\" keyword');\r\n\r\n  if (!options.adapter)\r\n    throw new Error('Transform expects option.adapter to be a storage adapter');\r\n\r\n  self.storage = options.adapter;\r\n\r\n  // Fetch the transformation functions if any\r\n  self.transformWrite = options.transformWrite;\r\n  self.transformRead = options.transformRead;\r\n};\r\n\r\n// Allow packages to add scope\r\nFS.Transform.scope = {\r\n// Deprecate gm scope:\r\n  gm: function(source, height, color) {\r\n    console.warn('Deprecation notice: `this.gm` is deprecating in favour of the general global `gm` scope');\r\n    if (typeof gm !== 'function')\r\n      throw new Error('No graphicsmagick package installed, `gm` not found in scope, eg. `cfs-graphicsmagick`');\r\n    return gm(source, height, color);\r\n  }\r\n// EO Deprecate gm scope\r\n};\r\n\r\n// The transformation stream triggers an \"stored\" event when data is stored into\r\n// the storage adapter\r\nFS.Transform.prototype.createWriteStream = function(fileObj) {\r\n  var self = this;\r\n\r\n  // Get the file key\r\n  var fileKey = self.storage.fileKey(fileObj);\r\n\r\n  // Rig write stream\r\n  var destinationStream = self.storage.createWriteStreamForFileKey(fileKey, {\r\n    // Not all SA's can set these options and cfs dont depend on setting these\r\n    // but its nice if other systems are accessing the SA that some of the data\r\n    // is also available to those\r\n    aliases: [fileObj.name()],\r\n    contentType: fileObj.type(),\r\n    metadata: fileObj.metadata\r\n  });\r\n\r\n  // Pass through transformWrite function if provided\r\n  if (typeof self.transformWrite === 'function') {\r\n\r\n    destinationStream = addPassThrough(destinationStream, function (ptStream, originalStream) {\r\n      // Rig transform\r\n      try {\r\n        self.transformWrite.call(FS.Transform.scope, fileObj, ptStream, originalStream);\r\n        // XXX: If the transform function returns a buffer should we stream that?\r\n      } catch(err) {\r\n        // We emit an error - should we throw an error?\r\n        console.warn('FS.Transform.createWriteStream transform function failed, Error: ');\r\n        throw err;\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  // If original doesn't have size, add another PassThrough to get and set the size.\r\n  // This will run on size=0, too, which is OK.\r\n  // NOTE: This must come AFTER the transformWrite code block above. This might seem\r\n  // confusing, but by coming after it, this will actually be executed BEFORE the user's\r\n  // transform, which is what we need in order to be sure we get the original file\r\n  // size and not the transformed file size.\r\n  if (!fileObj.size()) {\r\n    destinationStream = addPassThrough(destinationStream, function (ptStream, originalStream) {\r\n      var lstream = lengthStream(function (fileSize) {\r\n        fileObj.size(fileSize, {save: false});\r\n      });\r\n\r\n      ptStream.pipe(lstream).pipe(originalStream);\r\n    });\r\n  }\r\n\r\n  return destinationStream;\r\n};\r\n\r\nFS.Transform.prototype.createReadStream = function(fileObj, options) {\r\n  var self = this;\r\n\r\n  // Get the file key\r\n  var fileKey = self.storage.fileKey(fileObj);\r\n\r\n  // Rig read stream\r\n  var sourceStream = self.storage.createReadStreamForFileKey(fileKey, options);\r\n\r\n  // Pass through transformRead function if provided\r\n  if (typeof self.transformRead === 'function') {\r\n\r\n    sourceStream = addPassThrough(sourceStream, function (ptStream, originalStream) {\r\n      // Rig transform\r\n      try {\r\n        self.transformRead.call(FS.Transform.scope, fileObj, originalStream, ptStream);\r\n      } catch(err) {\r\n        //throw new Error(err);\r\n        // We emit an error - should we throw an error?\r\n        sourceStream.emit('error', 'FS.Transform.createReadStream transform function failed');\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  // We dont transform just normal SA interface\r\n  return sourceStream;\r\n};\r\n\r\n// Utility function to simplify adding layers of passthrough\r\nfunction addPassThrough(stream, func) {\r\n  var pts = new PassThrough();\r\n  // We pass on the special \"stored\" event for those listening\r\n  stream.on('stored', function(result) {\r\n    pts.emit('stored', result);\r\n  });\r\n  func(pts, stream);\r\n  return pts;\r\n}\r\n"]}